(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();async function ur(n){try{return[null,await n()]}catch(e){return[e,null]}}function Ds(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}const Ns=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){const e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};class D extends Error{}class de extends D{constructor(e,t,s,r){super(`${de.makeMessage(e,t,s)}`),this.status=e,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=t;const a=t;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,s){const r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,s,r){if(!e||!r)return new es({message:s,cause:Ns(t)});const a=t?.error;return e===400?new wi(e,a,s,r):e===401?new bi(e,a,s,r):e===403?new xi(e,a,s,r):e===404?new Si(e,a,s,r):e===409?new Ai(e,a,s,r):e===422?new Ti(e,a,s,r):e===429?new Ii(e,a,s,r):e>=500?new ki(e,a,s,r):new de(e,a,s,r)}}class Ae extends de{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class es extends de{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class cr extends es{constructor({message:e}={}){super({message:e??"Request timed out."})}}class wi extends de{}class bi extends de{}class xi extends de{}class Si extends de{}class Ai extends de{}class Ti extends de{}class Ii extends de{}class ki extends de{}class Ci extends D{constructor(){super("Could not parse response content as the length limit was reached")}}class Ei extends D{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Lt extends Error{constructor(e){super(e)}}function On(n){return n!==void 0&&"function"in n&&n.function!==void 0}function Fu(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function lr(n){return n?.$brand==="auto-parseable-response-format"}function on(n){return n?.$brand==="auto-parseable-tool"}function ju(n,e){return!e||!Ri(e)?{...n,choices:n.choices.map(t=>(Oi(t.message.tool_calls),{...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:dr(n,e)}function dr(n,e){const t=n.choices.map(s=>{if(s.finish_reason==="length")throw new Ci;if(s.finish_reason==="content_filter")throw new Ei;return Oi(s.message.tool_calls),{...s,message:{...s.message,...s.message.tool_calls?{tool_calls:s.message.tool_calls?.map(r=>Bu(e,r))??void 0}:void 0,parsed:s.message.content&&!s.message.refusal?Uu(e,s.message.content):null}}});return{...n,choices:t}}function Uu(n,e){return n.response_format?.type!=="json_schema"?null:n.response_format?.type==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Bu(n,e){const t=n.tools?.find(s=>On(s)&&s.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:on(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function Ju(n,e){if(!n||!("tools"in n)||!n.tools)return!1;const t=n.tools?.find(s=>On(s)&&s.function?.name===e.function.name);return On(t)&&(on(t)||t?.function.strict||!1)}function Ri(n){return lr(n.response_format)?!0:n.tools?.some(e=>on(e)||e.type==="function"&&e.function.strict===!0)??!1}function Oi(n){for(const e of n||[])if(e.type!=="function")throw new D(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function Zu(n){for(const e of n??[]){if(e.type!=="function")throw new D(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new D(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const qu=Symbol("Let zodToJsonSchema decide on which parser to use"),Xr={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Wu=n=>typeof n=="string"?{...Xr,basePath:["#"],definitions:{},name:n}:{...Xr,basePath:["#"],definitions:{},...n},Ps=n=>"_def"in n?n._def:n;function Hu(n){if(!n)return!0;for(const e in n)return!1;return!0}const zu=n=>{const e=Wu(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([s,r])=>[Ps(r),{def:Ps(r),path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function Di(n,e,t,s){s?.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function W(n,e,t,s,r){n[e]=t,Di(n,e,s,r)}var J;(function(n){n.assertEqual=r=>{};function e(r){}n.assertIs=e;function t(r){throw new Error}n.assertNever=t,n.arrayToEnum=r=>{const a={};for(const i of r)a[i]=i;return a},n.getValidEnumValues=r=>{const a=n.objectKeys(r).filter(o=>typeof r[r[o]]!="number"),i={};for(const o of a)i[o]=r[o];return n.objectValues(i)},n.objectValues=r=>n.objectKeys(r).map(function(a){return r[a]}),n.objectKeys=typeof Object.keys=="function"?r=>Object.keys(r):r=>{const a=[];for(const i in r)Object.prototype.hasOwnProperty.call(r,i)&&a.push(i);return a},n.find=(r,a)=>{for(const i of r)if(a(i))return i},n.isInteger=typeof Number.isInteger=="function"?r=>Number.isInteger(r):r=>typeof r=="number"&&Number.isFinite(r)&&Math.floor(r)===r;function s(r,a=" | "){return r.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}n.joinValues=s,n.jsonStringifyReplacer=(r,a)=>typeof a=="bigint"?a.toString():a})(J||(J={}));var Yr;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Yr||(Yr={}));const k=J.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ke=n=>{switch(typeof n){case"undefined":return k.undefined;case"string":return k.string;case"number":return Number.isNaN(n)?k.nan:k.number;case"boolean":return k.boolean;case"function":return k.function;case"bigint":return k.bigint;case"symbol":return k.symbol;case"object":return Array.isArray(n)?k.array:n===null?k.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?k.promise:typeof Map<"u"&&n instanceof Map?k.map:typeof Set<"u"&&n instanceof Set?k.set:typeof Date<"u"&&n instanceof Date?k.date:k.object;default:return k.unknown}},v=J.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class We extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=s=>{this.issues=[...this.issues,s]},this.addIssues=(s=[])=>{this.issues=[...this.issues,...s]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},s={_errors:[]},r=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(r);else if(i.code==="invalid_return_type")r(i.returnTypeError);else if(i.code==="invalid_arguments")r(i.argumentsError);else if(i.path.length===0)s._errors.push(t(i));else{let o=s,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return r(this),s}static assert(e){if(!(e instanceof We))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,J.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},s=[];for(const r of this.issues)if(r.path.length>0){const a=r.path[0];t[a]=t[a]||[],t[a].push(e(r))}else s.push(e(r));return{formErrors:s,fieldErrors:t}}get formErrors(){return this.flatten()}}We.create=n=>new We(n);const $s=(n,e)=>{let t;switch(n.code){case v.invalid_type:n.received===k.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case v.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,J.jsonStringifyReplacer)}`;break;case v.unrecognized_keys:t=`Unrecognized key(s) in object: ${J.joinValues(n.keys,", ")}`;break;case v.invalid_union:t="Invalid input";break;case v.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${J.joinValues(n.options)}`;break;case v.invalid_enum_value:t=`Invalid enum value. Expected ${J.joinValues(n.options)}, received '${n.received}'`;break;case v.invalid_arguments:t="Invalid function arguments";break;case v.invalid_return_type:t="Invalid function return type";break;case v.invalid_date:t="Invalid date";break;case v.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:J.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case v.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="bigint"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case v.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case v.custom:t="Invalid input";break;case v.invalid_intersection_types:t="Intersection results could not be merged";break;case v.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case v.not_finite:t="Number must be finite";break;default:t=e.defaultError,J.assertNever(n)}return{message:t}};let Gu=$s;function Vu(){return Gu}const Ku=n=>{const{data:e,path:t,errorMaps:s,issueData:r}=n,a=[...t,...r.path||[]],i={...r,path:a};if(r.message!==void 0)return{...r,path:a,message:r.message};let o="";const u=s.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...r,path:a,message:o}};function T(n,e){const t=Vu(),s=Ku({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===$s?void 0:$s].filter(r=>!!r)});n.common.issues.push(s)}class he{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const s=[];for(const r of t){if(r.status==="aborted")return $;r.status==="dirty"&&e.dirty(),s.push(r.value)}return{status:e.value,value:s}}static async mergeObjectAsync(e,t){const s=[];for(const r of t){const a=await r.key,i=await r.value;s.push({key:a,value:i})}return he.mergeObjectSync(e,s)}static mergeObjectSync(e,t){const s={};for(const r of t){const{key:a,value:i}=r;if(a.status==="aborted"||i.status==="aborted")return $;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||r.alwaysSet)&&(s[a.value]=i.value)}return{status:e.value,value:s}}}const $=Object.freeze({status:"aborted"}),Ft=n=>({status:"dirty",value:n}),ke=n=>({status:"valid",value:n}),Qr=n=>n.status==="aborted",ea=n=>n.status==="dirty",Rt=n=>n.status==="valid",Dn=n=>typeof Promise<"u"&&n instanceof Promise;var E;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e?.message})(E||(E={}));class Me{constructor(e,t,s,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=s,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const ta=(n,e)=>{if(Rt(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new We(n.common.issues);return this._error=t,this._error}}};function M(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:s,description:r}=n;if(e&&(t||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(i,o)=>{const{message:u}=n;return i.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:u??s??o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:u??t??o.defaultError}},description:r}}class j{get description(){return this._def.description}_getType(e){return Ke(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ke(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new he,ctx:{common:e.parent.common,data:e.data,parsedType:Ke(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Dn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const s=this.safeParse(e,t);if(s.success)return s.data;throw s.error}safeParse(e,t){const s={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ke(e)},r=this._parseSync({data:e,path:s.path,parent:s});return ta(s,r)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ke(e)};if(!this["~standard"].async)try{const s=this._parseSync({data:e,path:[],parent:t});return Rt(s)?{value:s.value}:{issues:t.common.issues}}catch(s){s?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(s=>Rt(s)?{value:s.value}:{issues:t.common.issues})}async parseAsync(e,t){const s=await this.safeParseAsync(e,t);if(s.success)return s.data;throw s.error}async safeParseAsync(e,t){const s={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ke(e)},r=this._parse({data:e,path:s.path,parent:s}),a=await(Dn(r)?r:Promise.resolve(r));return ta(s,a)}refine(e,t){const s=r=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(r):t;return this._refinement((r,a)=>{const i=e(r),o=()=>a.addIssue({code:v.custom,...s(r)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((s,r)=>e(s)?!0:(r.addIssue(typeof t=="function"?t(s,r):t),!1))}_refinement(e){return new dt({schema:this,typeName:b.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Ze.create(this,this._def)}nullable(){return pt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return $e.create(this)}promise(){return jn.create(this,this._def)}or(e){return Pn.create([this,e],this._def)}and(e){return $n.create(this,e,this._def)}transform(e){return new dt({...M(this._def),schema:this,typeName:b.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Un({...M(this._def),innerType:this,defaultValue:t,typeName:b.ZodDefault})}brand(){return new Mi({typeName:b.ZodBranded,type:this,...M(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Bn({...M(this._def),innerType:this,catchValue:t,typeName:b.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return fr.create(this,e)}readonly(){return Jn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Xu=/^c[^\s-]{8,}$/i,Yu=/^[0-9a-z]+$/,Qu=/^[0-9A-HJKMNP-TV-Z]{26}$/i,ec=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,tc=/^[a-z0-9_-]{21}$/i,nc=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,sc=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,rc=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,ac="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let fs;const ic=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,oc=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,uc=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,cc=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,lc=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,dc=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ni="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",pc=new RegExp(`^${Ni}$`);function Pi(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function fc(n){return new RegExp(`^${Pi(n)}$`)}function hc(n){let e=`${Ni}T${Pi(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function mc(n,e){return!!((e==="v4"||!e)&&ic.test(n)||(e==="v6"||!e)&&uc.test(n))}function _c(n,e){if(!nc.test(n))return!1;try{const[t]=n.split(".");if(!t)return!1;const s=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),r=JSON.parse(atob(s));return!(typeof r!="object"||r===null||"typ"in r&&r?.typ!=="JWT"||!r.alg||e&&r.alg!==e)}catch{return!1}}function gc(n,e){return!!((e==="v4"||!e)&&oc.test(n)||(e==="v6"||!e)&&cc.test(n))}class Je extends j{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==k.string){const a=this._getOrReturnCtx(e);return T(a,{code:v.invalid_type,expected:k.string,received:a.parsedType}),$}const s=new he;let r;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),T(r,{code:v.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="max")e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),T(r,{code:v.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(r=this._getOrReturnCtx(e,r),i?T(r,{code:v.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&T(r,{code:v.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),s.dirty())}else if(a.kind==="email")rc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"email",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="emoji")fs||(fs=new RegExp(ac,"u")),fs.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"emoji",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="uuid")ec.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"uuid",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="nanoid")tc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"nanoid",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid")Xu.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"cuid",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid2")Yu.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"cuid2",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="ulid")Qu.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"ulid",code:v.invalid_string,message:a.message}),s.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),T(r,{validation:"url",code:v.invalid_string,message:a.message}),s.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"regex",code:v.invalid_string,message:a.message}),s.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),s.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:{startsWith:a.value},message:a.message}),s.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:{endsWith:a.value},message:a.message}),s.dirty()):a.kind==="datetime"?hc(a).test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:"datetime",message:a.message}),s.dirty()):a.kind==="date"?pc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:"date",message:a.message}),s.dirty()):a.kind==="time"?fc(a).test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:v.invalid_string,validation:"time",message:a.message}),s.dirty()):a.kind==="duration"?sc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"duration",code:v.invalid_string,message:a.message}),s.dirty()):a.kind==="ip"?mc(e.data,a.version)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"ip",code:v.invalid_string,message:a.message}),s.dirty()):a.kind==="jwt"?_c(e.data,a.alg)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"jwt",code:v.invalid_string,message:a.message}),s.dirty()):a.kind==="cidr"?gc(e.data,a.version)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"cidr",code:v.invalid_string,message:a.message}),s.dirty()):a.kind==="base64"?lc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"base64",code:v.invalid_string,message:a.message}),s.dirty()):a.kind==="base64url"?dc.test(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{validation:"base64url",code:v.invalid_string,message:a.message}),s.dirty()):J.assertNever(a);return{status:s.value,value:e.data}}_regex(e,t,s){return this.refinement(r=>e.test(r),{validation:t,code:v.invalid_string,...E.errToObj(s)})}_addCheck(e){return new Je({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...E.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...E.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...E.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...E.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...E.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...E.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...E.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new Je({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Je({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Je({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Je.create=n=>new Je({checks:[],typeName:b.ZodString,coerce:n?.coerce??!1,...M(n)});function yc(n,e){const t=(n.toString().split(".")[1]||"").length,s=(e.toString().split(".")[1]||"").length,r=t>s?t:s,a=Number.parseInt(n.toFixed(r).replace(".","")),i=Number.parseInt(e.toFixed(r).replace(".",""));return a%i/10**r}class Ot extends j{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==k.number){const a=this._getOrReturnCtx(e);return T(a,{code:v.invalid_type,expected:k.number,received:a.parsedType}),$}let s;const r=new he;for(const a of this._def.checks)a.kind==="int"?J.isInteger(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{code:v.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="multipleOf"?yc(e.data,a.value)!==0&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{code:v.not_finite,message:a.message}),r.dirty()):J.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,s,r){return new Ot({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:E.toString(r)}]})}_addCheck(e){return new Ot({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&J.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const s of this._def.checks){if(s.kind==="finite"||s.kind==="int"||s.kind==="multipleOf")return!0;s.kind==="min"?(t===null||s.value>t)&&(t=s.value):s.kind==="max"&&(e===null||s.value<e)&&(e=s.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ot.create=n=>new Ot({checks:[],typeName:b.ZodNumber,coerce:n?.coerce||!1,...M(n)});class Kt extends j{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==k.bigint)return this._getInvalidInput(e);let s;const r=new he;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(s=this._getOrReturnCtx(e,s),T(s,{code:v.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):J.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return T(t,{code:v.invalid_type,expected:k.bigint,received:t.parsedType}),$}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,s,r){return new Kt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:E.toString(r)}]})}_addCheck(e){return new Kt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Kt.create=n=>new Kt({checks:[],typeName:b.ZodBigInt,coerce:n?.coerce??!1,...M(n)});class Ms extends j{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==k.boolean){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.boolean,received:s.parsedType}),$}return ke(e.data)}}Ms.create=n=>new Ms({typeName:b.ZodBoolean,coerce:n?.coerce||!1,...M(n)});class Nn extends j{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==k.date){const a=this._getOrReturnCtx(e);return T(a,{code:v.invalid_type,expected:k.date,received:a.parsedType}),$}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return T(a,{code:v.invalid_date}),$}const s=new he;let r;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),T(r,{code:v.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),s.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),T(r,{code:v.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),s.dirty()):J.assertNever(a);return{status:s.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Nn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Nn.create=n=>new Nn({checks:[],coerce:n?.coerce||!1,typeName:b.ZodDate,...M(n)});class na extends j{_parse(e){if(this._getType(e)!==k.symbol){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.symbol,received:s.parsedType}),$}return ke(e.data)}}na.create=n=>new na({typeName:b.ZodSymbol,...M(n)});class Ls extends j{_parse(e){if(this._getType(e)!==k.undefined){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.undefined,received:s.parsedType}),$}return ke(e.data)}}Ls.create=n=>new Ls({typeName:b.ZodUndefined,...M(n)});class Fs extends j{_parse(e){if(this._getType(e)!==k.null){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.null,received:s.parsedType}),$}return ke(e.data)}}Fs.create=n=>new Fs({typeName:b.ZodNull,...M(n)});class js extends j{constructor(){super(...arguments),this._any=!0}_parse(e){return ke(e.data)}}js.create=n=>new js({typeName:b.ZodAny,...M(n)});class sa extends j{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ke(e.data)}}sa.create=n=>new sa({typeName:b.ZodUnknown,...M(n)});class Xe extends j{_parse(e){const t=this._getOrReturnCtx(e);return T(t,{code:v.invalid_type,expected:k.never,received:t.parsedType}),$}}Xe.create=n=>new Xe({typeName:b.ZodNever,...M(n)});class ra extends j{_parse(e){if(this._getType(e)!==k.undefined){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.void,received:s.parsedType}),$}return ke(e.data)}}ra.create=n=>new ra({typeName:b.ZodVoid,...M(n)});class $e extends j{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),r=this._def;if(t.parsedType!==k.array)return T(t,{code:v.invalid_type,expected:k.array,received:t.parsedType}),$;if(r.exactLength!==null){const i=t.data.length>r.exactLength.value,o=t.data.length<r.exactLength.value;(i||o)&&(T(t,{code:i?v.too_big:v.too_small,minimum:o?r.exactLength.value:void 0,maximum:i?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),s.dirty())}if(r.minLength!==null&&t.data.length<r.minLength.value&&(T(t,{code:v.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),s.dirty()),r.maxLength!==null&&t.data.length>r.maxLength.value&&(T(t,{code:v.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>r.type._parseAsync(new Me(t,i,t.path,o)))).then(i=>he.mergeArray(s,i));const a=[...t.data].map((i,o)=>r.type._parseSync(new Me(t,i,t.path,o)));return he.mergeArray(s,a)}get element(){return this._def.type}min(e,t){return new $e({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new $e({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new $e({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}}$e.create=(n,e)=>new $e({type:n,minLength:null,maxLength:null,exactLength:null,typeName:b.ZodArray,...M(e)});function xt(n){if(n instanceof Q){const e={};for(const t in n.shape){const s=n.shape[t];e[t]=Ze.create(xt(s))}return new Q({...n._def,shape:()=>e})}else return n instanceof $e?new $e({...n._def,type:xt(n.element)}):n instanceof Ze?Ze.create(xt(n.unwrap())):n instanceof pt?pt.create(xt(n.unwrap())):n instanceof ct?ct.create(n.items.map(e=>xt(e))):n}class Q extends j{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=J.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==k.object){const c=this._getOrReturnCtx(e);return T(c,{code:v.invalid_type,expected:k.object,received:c.parsedType}),$}const{status:s,ctx:r}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Xe&&this._def.unknownKeys==="strip"))for(const c in r.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=a[c],p=r.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Me(r,p,r.path,c)),alwaysSet:c in r.data})}if(this._def.catchall instanceof Xe){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:r.data[l]}});else if(c==="strict")o.length>0&&(T(r,{code:v.unrecognized_keys,keys:o}),s.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const p=r.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Me(r,p,r.path,l)),alwaysSet:l in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const p=await l.key,h=await l.value;c.push({key:p,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>he.mergeObjectSync(s,c)):he.mergeObjectSync(s,u)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new Q({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,s)=>{const r=this._def.errorMap?.(t,s).message??s.defaultError;return t.code==="unrecognized_keys"?{message:E.errToObj(e).message??r}:{message:r}}}:{}})}strip(){return new Q({...this._def,unknownKeys:"strip"})}passthrough(){return new Q({...this._def,unknownKeys:"passthrough"})}extend(e){return new Q({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Q({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:b.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Q({...this._def,catchall:e})}pick(e){const t={};for(const s of J.objectKeys(e))e[s]&&this.shape[s]&&(t[s]=this.shape[s]);return new Q({...this._def,shape:()=>t})}omit(e){const t={};for(const s of J.objectKeys(this.shape))e[s]||(t[s]=this.shape[s]);return new Q({...this._def,shape:()=>t})}deepPartial(){return xt(this)}partial(e){const t={};for(const s of J.objectKeys(this.shape)){const r=this.shape[s];e&&!e[s]?t[s]=r:t[s]=r.optional()}return new Q({...this._def,shape:()=>t})}required(e){const t={};for(const s of J.objectKeys(this.shape))if(e&&!e[s])t[s]=this.shape[s];else{let a=this.shape[s];for(;a instanceof Ze;)a=a._def.innerType;t[s]=a}return new Q({...this._def,shape:()=>t})}keyof(){return $i(J.objectKeys(this.shape))}}Q.create=(n,e)=>new Q({shape:()=>n,unknownKeys:"strip",catchall:Xe.create(),typeName:b.ZodObject,...M(e)});Q.strictCreate=(n,e)=>new Q({shape:()=>n,unknownKeys:"strict",catchall:Xe.create(),typeName:b.ZodObject,...M(e)});Q.lazycreate=(n,e)=>new Q({shape:n,unknownKeys:"strip",catchall:Xe.create(),typeName:b.ZodObject,...M(e)});class Pn extends j{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function r(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new We(o.ctx.common.issues));return T(t,{code:v.invalid_union,unionErrors:i}),$}if(t.common.async)return Promise.all(s.map(async a=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(r);{let a;const i=[];for(const u of s){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!a&&(a={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(u=>new We(u));return T(t,{code:v.invalid_union,unionErrors:o}),$}}get options(){return this._def.options}}Pn.create=(n,e)=>new Pn({options:n,typeName:b.ZodUnion,...M(e)});const Ue=n=>n instanceof Ln?Ue(n.schema):n instanceof dt?Ue(n.innerType()):n instanceof Fn?[n.value]:n instanceof lt?n.options:n instanceof Bs?J.objectValues(n.enum):n instanceof Un?Ue(n._def.innerType):n instanceof Ls?[void 0]:n instanceof Fs?[null]:n instanceof Ze?[void 0,...Ue(n.unwrap())]:n instanceof pt?[null,...Ue(n.unwrap())]:n instanceof Mi||n instanceof Jn?Ue(n.unwrap()):n instanceof Bn?Ue(n._def.innerType):[];class pr extends j{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==k.object)return T(t,{code:v.invalid_type,expected:k.object,received:t.parsedType}),$;const s=this.discriminator,r=t.data[s],a=this.optionsMap.get(r);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(T(t,{code:v.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[s]}),$)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,s){const r=new Map;for(const a of t){const i=Ue(a.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(r.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);r.set(o,a)}}return new pr({typeName:b.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...M(s)})}}function Us(n,e){const t=Ke(n),s=Ke(e);if(n===e)return{valid:!0,data:n};if(t===k.object&&s===k.object){const r=J.objectKeys(e),a=J.objectKeys(n).filter(o=>r.indexOf(o)!==-1),i={...n,...e};for(const o of a){const u=Us(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===k.array&&s===k.array){if(n.length!==e.length)return{valid:!1};const r=[];for(let a=0;a<n.length;a++){const i=n[a],o=e[a],u=Us(i,o);if(!u.valid)return{valid:!1};r.push(u.data)}return{valid:!0,data:r}}else return t===k.date&&s===k.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class $n extends j{_parse(e){const{status:t,ctx:s}=this._processInputParams(e),r=(a,i)=>{if(Qr(a)||Qr(i))return $;const o=Us(a.value,i.value);return o.valid?((ea(a)||ea(i))&&t.dirty(),{status:t.value,value:o.data}):(T(s,{code:v.invalid_intersection_types}),$)};return s.common.async?Promise.all([this._def.left._parseAsync({data:s.data,path:s.path,parent:s}),this._def.right._parseAsync({data:s.data,path:s.path,parent:s})]).then(([a,i])=>r(a,i)):r(this._def.left._parseSync({data:s.data,path:s.path,parent:s}),this._def.right._parseSync({data:s.data,path:s.path,parent:s}))}}$n.create=(n,e,t)=>new $n({left:n,right:e,typeName:b.ZodIntersection,...M(t)});class ct extends j{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==k.array)return T(s,{code:v.invalid_type,expected:k.array,received:s.parsedType}),$;if(s.data.length<this._def.items.length)return T(s,{code:v.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),$;!this._def.rest&&s.data.length>this._def.items.length&&(T(s,{code:v.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...s.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Me(s,i,s.path,o)):null}).filter(i=>!!i);return s.common.async?Promise.all(a).then(i=>he.mergeArray(t,i)):he.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new ct({...this._def,rest:e})}}ct.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ct({items:n,typeName:b.ZodTuple,rest:null,...M(e)})};class Mn extends j{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==k.object)return T(s,{code:v.invalid_type,expected:k.object,received:s.parsedType}),$;const r=[],a=this._def.keyType,i=this._def.valueType;for(const o in s.data)r.push({key:a._parse(new Me(s,o,s.path,o)),value:i._parse(new Me(s,s.data[o],s.path,o)),alwaysSet:o in s.data});return s.common.async?he.mergeObjectAsync(t,r):he.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,s){return t instanceof j?new Mn({keyType:e,valueType:t,typeName:b.ZodRecord,...M(s)}):new Mn({keyType:Je.create(),valueType:e,typeName:b.ZodRecord,...M(t)})}}class aa extends j{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==k.map)return T(s,{code:v.invalid_type,expected:k.map,received:s.parsedType}),$;const r=this._def.keyType,a=this._def.valueType,i=[...s.data.entries()].map(([o,u],c)=>({key:r._parse(new Me(s,o,s.path,[c,"key"])),value:a._parse(new Me(s,u,s.path,[c,"value"]))}));if(s.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return $;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return $;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}aa.create=(n,e,t)=>new aa({valueType:e,keyType:n,typeName:b.ZodMap,...M(t)});class Xt extends j{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==k.set)return T(s,{code:v.invalid_type,expected:k.set,received:s.parsedType}),$;const r=this._def;r.minSize!==null&&s.data.size<r.minSize.value&&(T(s,{code:v.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),r.maxSize!==null&&s.data.size>r.maxSize.value&&(T(s,{code:v.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const a=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return $;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...s.data.values()].map((u,c)=>a._parse(new Me(s,u,s.path,c)));return s.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new Xt({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new Xt({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Xt.create=(n,e)=>new Xt({valueType:n,minSize:null,maxSize:null,typeName:b.ZodSet,...M(e)});class Ln extends j{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ln.create=(n,e)=>new Ln({getter:n,typeName:b.ZodLazy,...M(e)});class Fn extends j{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return T(t,{received:t.data,code:v.invalid_literal,expected:this._def.value}),$}return{status:"valid",value:e.data}}get value(){return this._def.value}}Fn.create=(n,e)=>new Fn({value:n,typeName:b.ZodLiteral,...M(e)});function $i(n,e){return new lt({values:n,typeName:b.ZodEnum,...M(e)})}class lt extends j{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),s=this._def.values;return T(t,{expected:J.joinValues(s),received:t.parsedType,code:v.invalid_type}),$}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),s=this._def.values;return T(t,{received:t.data,code:v.invalid_enum_value,options:s}),$}return ke(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return lt.create(e,{...this._def,...t})}exclude(e,t=this._def){return lt.create(this.options.filter(s=>!e.includes(s)),{...this._def,...t})}}lt.create=$i;class Bs extends j{_parse(e){const t=J.getValidEnumValues(this._def.values),s=this._getOrReturnCtx(e);if(s.parsedType!==k.string&&s.parsedType!==k.number){const r=J.objectValues(t);return T(s,{expected:J.joinValues(r),received:s.parsedType,code:v.invalid_type}),$}if(this._cache||(this._cache=new Set(J.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const r=J.objectValues(t);return T(s,{received:s.data,code:v.invalid_enum_value,options:r}),$}return ke(e.data)}get enum(){return this._def.values}}Bs.create=(n,e)=>new Bs({values:n,typeName:b.ZodNativeEnum,...M(e)});class jn extends j{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==k.promise&&t.common.async===!1)return T(t,{code:v.invalid_type,expected:k.promise,received:t.parsedType}),$;const s=t.parsedType===k.promise?t.data:Promise.resolve(t.data);return ke(s.then(r=>this._def.type.parseAsync(r,{path:t.path,errorMap:t.common.contextualErrorMap})))}}jn.create=(n,e)=>new jn({type:n,typeName:b.ZodPromise,...M(e)});class dt extends j{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===b.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:s}=this._processInputParams(e),r=this._def.effect||null,a={addIssue:i=>{T(s,i),i.fatal?t.abort():t.dirty()},get path(){return s.path}};if(a.addIssue=a.addIssue.bind(a),r.type==="preprocess"){const i=r.transform(s.data,a);if(s.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return $;const u=await this._def.schema._parseAsync({data:o,path:s.path,parent:s});return u.status==="aborted"?$:u.status==="dirty"||t.value==="dirty"?Ft(u.value):u});{if(t.value==="aborted")return $;const o=this._def.schema._parseSync({data:i,path:s.path,parent:s});return o.status==="aborted"?$:o.status==="dirty"||t.value==="dirty"?Ft(o.value):o}}if(r.type==="refinement"){const i=o=>{const u=r.refinement(o,a);if(s.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(s.common.async===!1){const o=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});return o.status==="aborted"?$:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(o=>o.status==="aborted"?$:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(r.type==="transform")if(s.common.async===!1){const i=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});if(!Rt(i))return $;const o=r.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(i=>Rt(i)?Promise.resolve(r.transform(i.value,a)).then(o=>({status:t.value,value:o})):$);J.assertNever(r)}}dt.create=(n,e,t)=>new dt({schema:n,typeName:b.ZodEffects,effect:e,...M(t)});dt.createWithPreprocess=(n,e,t)=>new dt({schema:e,effect:{type:"preprocess",transform:n},typeName:b.ZodEffects,...M(t)});class Ze extends j{_parse(e){return this._getType(e)===k.undefined?ke(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ze.create=(n,e)=>new Ze({innerType:n,typeName:b.ZodOptional,...M(e)});class pt extends j{_parse(e){return this._getType(e)===k.null?ke(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}pt.create=(n,e)=>new pt({innerType:n,typeName:b.ZodNullable,...M(e)});class Un extends j{_parse(e){const{ctx:t}=this._processInputParams(e);let s=t.data;return t.parsedType===k.undefined&&(s=this._def.defaultValue()),this._def.innerType._parse({data:s,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Un.create=(n,e)=>new Un({innerType:n,typeName:b.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...M(e)});class Bn extends j{_parse(e){const{ctx:t}=this._processInputParams(e),s={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:s.data,path:s.path,parent:{...s}});return Dn(r)?r.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new We(s.common.issues)},input:s.data})})):{status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new We(s.common.issues)},input:s.data})}}removeCatch(){return this._def.innerType}}Bn.create=(n,e)=>new Bn({innerType:n,typeName:b.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...M(e)});class ia extends j{_parse(e){if(this._getType(e)!==k.nan){const s=this._getOrReturnCtx(e);return T(s,{code:v.invalid_type,expected:k.nan,received:s.parsedType}),$}return{status:"valid",value:e.data}}}ia.create=n=>new ia({typeName:b.ZodNaN,...M(n)});class Mi extends j{_parse(e){const{ctx:t}=this._processInputParams(e),s=t.data;return this._def.type._parse({data:s,path:t.path,parent:t})}unwrap(){return this._def.type}}class fr extends j{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:s.data,path:s.path,parent:s});return a.status==="aborted"?$:a.status==="dirty"?(t.dirty(),Ft(a.value)):this._def.out._parseAsync({data:a.value,path:s.path,parent:s})})();{const r=this._def.in._parseSync({data:s.data,path:s.path,parent:s});return r.status==="aborted"?$:r.status==="dirty"?(t.dirty(),{status:"dirty",value:r.value}):this._def.out._parseSync({data:r.value,path:s.path,parent:s})}}static create(e,t){return new fr({in:e,out:t,typeName:b.ZodPipeline})}}class Jn extends j{_parse(e){const t=this._def.innerType._parse(e),s=r=>(Rt(r)&&(r.value=Object.freeze(r.value)),r);return Dn(t)?t.then(r=>s(r)):s(t)}unwrap(){return this._def.innerType}}Jn.create=(n,e)=>new Jn({innerType:n,typeName:b.ZodReadonly,...M(e)});var b;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(b||(b={}));const d=Je.create,C=Ot.create,ot=Ms.create,F=js.create;Xe.create;const B=$e.create,g=Q.create,Li=Pn.create,we=pr.create;$n.create;ct.create;const ee=Mn.create,vc=Ln.create,y=Fn.create,V=lt.create;jn.create;Ze.create;pt.create;function wc(){return{}}function bc(n,e){const t={type:"array"};return n.type?._def?.typeName!==b.ZodAny&&(t.items=Z(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&W(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&W(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(W(t,"minItems",n.exactLength.value,n.exactLength.message,e),W(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function xc(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?W(t,"minimum",s.value,s.message,e):W(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),W(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?W(t,"maximum",s.value,s.message,e):W(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),W(t,"maximum",s.value,s.message,e));break;case"multipleOf":W(t,"multipleOf",s.value,s.message,e);break}return t}function Sc(){return{type:"boolean"}}function Ac(n,e){return Z(n.type._def,e)}const Tc=(n,e)=>Z(n.innerType._def,e);function Fi(n,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((r,a)=>Fi(n,e,r))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Ic(n,e)}}const Ic=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of n.checks)switch(s.kind){case"min":W(t,"minimum",s.value,s.message,e);break;case"max":W(t,"maximum",s.value,s.message,e);break}return t};function kc(n,e){return{...Z(n.innerType._def,e),default:n.defaultValue()}}function Cc(n,e,t){return e.effectStrategy==="input"?Z(n.schema._def,e,t):{}}function Ec(n){return{type:"string",enum:[...n.values]}}const Rc=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Oc(n,e){const t=[Z(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Z(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const r=[];return t.forEach(a=>{if(Rc(a))r.push(...a.allOf),a.unevaluatedProperties===void 0&&(s=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...u}=a;i=u}else s=void 0;r.push(i)}}),r.length?{allOf:r,...s}:void 0}function Dc(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let hs;const et={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(hs===void 0&&(hs=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),hs),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ji(n,e){const t={type:"string"};function s(r){return e.patternStrategy==="escape"?Nc(r):r}if(n.checks)for(const r of n.checks)switch(r.kind){case"min":W(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":W(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ce(t,"email",r.message,e);break;case"format:idn-email":Ce(t,"idn-email",r.message,e);break;case"pattern:zod":Ee(t,et.email,r.message,e);break}break;case"url":Ce(t,"uri",r.message,e);break;case"uuid":Ce(t,"uuid",r.message,e);break;case"regex":Ee(t,r.regex,r.message,e);break;case"cuid":Ee(t,et.cuid,r.message,e);break;case"cuid2":Ee(t,et.cuid2,r.message,e);break;case"startsWith":Ee(t,RegExp(`^${s(r.value)}`),r.message,e);break;case"endsWith":Ee(t,RegExp(`${s(r.value)}$`),r.message,e);break;case"datetime":Ce(t,"date-time",r.message,e);break;case"date":Ce(t,"date",r.message,e);break;case"time":Ce(t,"time",r.message,e);break;case"duration":Ce(t,"duration",r.message,e);break;case"length":W(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),W(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ee(t,RegExp(s(r.value)),r.message,e);break}case"ip":{r.version!=="v6"&&Ce(t,"ipv4",r.message,e),r.version!=="v4"&&Ce(t,"ipv6",r.message,e);break}case"emoji":Ee(t,et.emoji,r.message,e);break;case"ulid":{Ee(t,et.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Ce(t,"binary",r.message,e);break}case"contentEncoding:base64":{W(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ee(t,et.base64,r.message,e);break}}break}case"nanoid":Ee(t,et.nanoid,r.message,e)}return t}const Nc=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Ce=(n,e,t,s)=>{n.format||n.anyOf?.some(r=>r.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&s.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):W(n,"format",e,t,s)},Ee=(n,e,t,s)=>{n.pattern||n.allOf?.some(r=>r.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&s.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:oa(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):W(n,"pattern",oa(e,s),t,s)},oa=(n,e)=>{const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const s={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=s.i?t.source.toLowerCase():t.source;let a="",i=!1,o=!1,u=!1;for(let c=0;c<r.length;c++){if(i){a+=r[c],i=!1;continue}if(s.i){if(o){if(r[c].match(/[a-z]/)){u?(a+=r[c],a+=`${r[c-2]}-${r[c]}`.toUpperCase(),u=!1):r[c+1]==="-"&&r[c+2]?.match(/[a-z]/)?(a+=r[c],u=!0):a+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){a+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(s.m){if(r[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(s.s&&r[c]==="."){a+=o?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}a+=r[c],r[c]==="\\"?i=!0:o&&r[c]==="]"?o=!1:!o&&r[c]==="["&&(o=!0)}try{const c=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a};function Ui(n,e){if(e.target==="openApi3"&&n.keyType?._def.typeName===b.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((s,r)=>({...s,[r]:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(n.keyType?._def.typeName===b.ZodString&&n.keyType._def.checks?.length){const s=Object.entries(ji(n.keyType._def,e)).reduce((r,[a,i])=>a==="type"?r:{...r,[a]:i},{});return{...t,propertyNames:s}}else if(n.keyType?._def.typeName===b.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Pc(n,e){if(e.mapStrategy==="record")return Ui(n,e);const t=Z(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function $c(n){const e=n.values,s=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),r=Array.from(new Set(s.map(a=>typeof a)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:s}}function Mc(){return{not:{}}}function Lc(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Zn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Fc(n,e){if(e.target==="openApi3")return ua(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(s=>s._def.typeName in Zn&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((r,a)=>{const i=Zn[a._def.typeName];return i&&!r.includes(i)?[...r,i]:r},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((r,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...r,i];case"bigint":return[...r,"integer"];case"object":if(a._def.value===null)return[...r,"null"];case"symbol":case"undefined":case"function":default:return r}},[]);if(s.length===t.length){const r=s.filter((a,i,o)=>o.indexOf(a)===i);return{type:r.length>1?r:r[0],enum:t.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,r)=>[...s,...r._def.values.filter(a=>!s.includes(a))],[])};return ua(n,e)}const ua=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((s,r)=>Z(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${r}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function jc(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Zn[n.innerType._def.typeName],nullable:!0}:{type:[Zn[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=Z(n.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=Z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Uc(n,e){const t={type:"number"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"int":t.type="integer",Di(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?W(t,"minimum",s.value,s.message,e):W(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),W(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?W(t,"maximum",s.value,s.message,e):W(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),W(t,"maximum",s.value,s.message,e));break;case"multipleOf":W(t,"multipleOf",s.value,s.message,e);break}return t}function Bc(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":Z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":Z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Jc(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((s,[r,a])=>{if(a===void 0||a._def===void 0)return s;const i=[...e.currentPath,"properties",r],o=Z(a._def,{...e,currentPath:i,propertyPath:i});if(o===void 0)return s;if(e.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&typeof a._def?.defaultValue>"u")throw new Error(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...s.properties,[r]:o},required:a.isOptional()&&!e.openaiStrictMode?s.required:[...s.required,r]}},{properties:{},required:[]}),additionalProperties:Bc(n,e)};return t.required.length||delete t.required,t}const Zc=(n,e)=>{if(e.propertyPath&&e.currentPath.slice(0,e.propertyPath.length).toString()===e.propertyPath.toString())return Z(n.innerType._def,{...e,currentPath:e.currentPath});const t=Z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},qc=(n,e)=>{if(e.pipeStrategy==="input")return Z(n.in._def,e);if(e.pipeStrategy==="output")return Z(n.out._def,e);const t=Z(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=Z(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(r=>r!==void 0)}};function Wc(n,e){return Z(n.type._def,e)}function Hc(n,e){const s={type:"array",uniqueItems:!0,items:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&W(s,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&W(s,"maxItems",n.maxSize.value,n.maxSize.message,e),s}function zc(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,s)=>Z(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:Z(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,s)=>Z(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function Gc(){return{not:{}}}function Vc(){return{}}const Kc=(n,e)=>Z(n.innerType._def,e);function Z(n,e,t=!1){const s=e.seen.get(n);if(e.override){const i=e.override?.(n,e,s,t);if(i!==qu)return i}if(s&&!t){const i=Xc(s,e);if(i!==void 0)return"$ref"in i&&e.seenRefs.add(i.$ref),i}const r={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,r);const a=Qc(n,n.typeName,e,t);return a&&el(n,e,a),r.jsonSchema=a,a}const Xc=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":const t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:Yc(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((s,r)=>e.currentPath[r]===s)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Yc=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Qc=(n,e,t,s)=>{switch(e){case b.ZodString:return ji(n,t);case b.ZodNumber:return Uc(n,t);case b.ZodObject:return Jc(n,t);case b.ZodBigInt:return xc(n,t);case b.ZodBoolean:return Sc();case b.ZodDate:return Fi(n,t);case b.ZodUndefined:return Gc();case b.ZodNull:return Lc(t);case b.ZodArray:return bc(n,t);case b.ZodUnion:case b.ZodDiscriminatedUnion:return Fc(n,t);case b.ZodIntersection:return Oc(n,t);case b.ZodTuple:return zc(n,t);case b.ZodRecord:return Ui(n,t);case b.ZodLiteral:return Dc(n,t);case b.ZodEnum:return Ec(n);case b.ZodNativeEnum:return $c(n);case b.ZodNullable:return jc(n,t);case b.ZodOptional:return Zc(n,t);case b.ZodMap:return Pc(n,t);case b.ZodSet:return Hc(n,t);case b.ZodLazy:return Z(n.getter()._def,t);case b.ZodPromise:return Wc(n,t);case b.ZodNaN:case b.ZodNever:return Mc();case b.ZodEffects:return Cc(n,t,s);case b.ZodAny:return wc();case b.ZodUnknown:return Vc();case b.ZodDefault:return kc(n,t);case b.ZodBranded:return Ac(n,t);case b.ZodReadonly:return Kc(n,t);case b.ZodCatch:return Tc(n,t);case b.ZodPipeline:return qc(n,t);case b.ZodFunction:case b.ZodVoid:case b.ZodSymbol:return;default:return(r=>{})()}},el=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),tl=(n,e)=>{const t=zu(e),s=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,r=Z(n._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(r.title=a);const i=(()=>{if(Hu(t.definitions))return;const u={},c=new Set;for(let l=0;l<500;l++){const p=Object.entries(t.definitions).filter(([h])=>!c.has(h));if(p.length===0)break;for(const[h,f]of p)u[h]=Z(Ps(f),{...t,currentPath:[...t.basePath,t.definitionPath,h]},!0)??{},c.add(h)}return u})(),o=s===void 0?i?{...r,[t.definitionPath]:i}:r:t.nameStrategy==="duplicate-ref"?{...r,...i||t.seenRefs.size?{[t.definitionPath]:{...i,...t.seenRefs.size?{[s]:r}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...i,[s]:r}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function nl(n,e){return!e||!rl(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(s=>({...s,parsed:null}))}:t)}:Bi(n,e)}function Bi(n,e){const t=n.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:ul(e,r)};if(r.type==="message"){const a=r.content.map(i=>i.type==="output_text"?{...i,parsed:sl(e,i.text)}:i);return{...r,content:a}}return r}),s=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||Js(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const r of s.output)if(r.type==="message"){for(const a of r.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),s}function sl(n,e){return n.text?.format?.type!=="json_schema"?null:"$parseRaw"in n.text?.format?(n.text?.format).$parseRaw(e):JSON.parse(e)}function rl(n){return!!lr(n.text?.format)}function al(n,{parser:e,callback:t}){const s={...n};return Object.defineProperties(s,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),s}function il(n){return n?.$brand==="auto-parseable-tool"}function ol(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function ul(n,e){const t=ol(n.tools??[],e.name);return{...e,...e,parsed_arguments:il(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function Js(n){const e=[];for(const t of n.output)if(t.type==="message")for(const s of t.content)s.type==="output_text"&&e.push(s.text);n.output_text=e.join("")}function Ji(n,e){return tl(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function cl(n,e,t){return Fu({type:"json_schema",...t,name:e,strict:!0,schema:Ji(n,{name:e})},s=>n.parse(JSON.parse(s)))}function ll(n){return al({type:"function",name:n.name,parameters:Ji(n.parameters,{name:n.name}),strict:!0},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}class Qe extends Error{state;constructor(e,t){super(e),this.state=t}}class dl extends Qe{}class ca extends Qe{}class Te extends Qe{}class H extends Qe{}class la extends Qe{error;constructor(e,t,s){super(e,s),this.error=t}}class pl extends Qe{error;constructor(e,t,s){super(e,s),this.error=t}}class da extends Qe{result;constructor(e,t,s){super(e,s),this.result=t}}class Zs extends Qe{result;constructor(e,t,s){super(e,s),this.result=t}}function ft(n){return typeof n=="object"&&n!==null&&"_def"in n&&typeof n._def=="object"&&n._def!==null&&"typeName"in n._def&&n._def.typeName==="ZodObject"}function fl(n){return typeof n=="object"&&n!==null&&"input"in n&&typeof n.input=="string"}function qn(n){if(n=n.replace(/\s/g,"_"),n=n.replace(/[^a-zA-Z0-9]/g,"_"),n.length===0)throw new Error("Tool name cannot be empty");return n}function hr(n,e){const t=s=>JSON.parse(s);if(ft(n)){const s=ll({name:e,parameters:n,function:()=>{}});return{schema:s.parameters,parser:s.$parseRaw}}else if(typeof n=="object"&&n!==null)return{schema:n,parser:t};throw new H("Input type is not a ZodObject or a valid JSON schema")}function pa(n){if(n==="text")return"text";if(ft(n)){const e=cl(n,"output");return{type:e.type,name:e.name,strict:e.strict||!1,schema:e.schema}}return n}function hl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var dn={exports:{}},ms,fa;function ml(){if(fa)return ms;fa=1;var n=1e3,e=n*60,t=e*60,s=t*24,r=s*7,a=s*365.25;ms=function(l,p){p=p||{};var h=typeof l;if(h==="string"&&l.length>0)return i(l);if(h==="number"&&isFinite(l))return p.long?u(l):o(l);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(l))};function i(l){if(l=String(l),!(l.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(l);if(p){var h=parseFloat(p[1]),f=(p[2]||"ms").toLowerCase();switch(f){case"years":case"year":case"yrs":case"yr":case"y":return h*a;case"weeks":case"week":case"w":return h*r;case"days":case"day":case"d":return h*s;case"hours":case"hour":case"hrs":case"hr":case"h":return h*t;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function o(l){var p=Math.abs(l);return p>=s?Math.round(l/s)+"d":p>=t?Math.round(l/t)+"h":p>=e?Math.round(l/e)+"m":p>=n?Math.round(l/n)+"s":l+"ms"}function u(l){var p=Math.abs(l);return p>=s?c(l,p,s,"day"):p>=t?c(l,p,t,"hour"):p>=e?c(l,p,e,"minute"):p>=n?c(l,p,n,"second"):l+" ms"}function c(l,p,h,f){var _=p>=h*1.5;return Math.round(l/h)+" "+f+(_?"s":"")}return ms}var _s,ha;function _l(){if(ha)return _s;ha=1;function n(e){s.debug=s,s.default=s,s.coerce=c,s.disable=o,s.enable=a,s.enabled=u,s.humanize=ml(),s.destroy=l,Object.keys(e).forEach(p=>{s[p]=e[p]}),s.names=[],s.skips=[],s.formatters={};function t(p){let h=0;for(let f=0;f<p.length;f++)h=(h<<5)-h+p.charCodeAt(f),h|=0;return s.colors[Math.abs(h)%s.colors.length]}s.selectColor=t;function s(p){let h,f=null,_,w;function A(...I){if(!A.enabled)return;const S=A,U=Number(new Date),q=U-(h||U);S.diff=q,S.prev=h,S.curr=U,h=U,I[0]=s.coerce(I[0]),typeof I[0]!="string"&&I.unshift("%O");let Y=0;I[0]=I[0].replace(/%([a-zA-Z%])/g,(G,ne)=>{if(G==="%%")return"%";Y++;const X=s.formatters[ne];if(typeof X=="function"){const K=I[Y];G=X.call(S,K),I.splice(Y,1),Y--}return G}),s.formatArgs.call(S,I),(S.log||s.log).apply(S,I)}return A.namespace=p,A.useColors=s.useColors(),A.color=s.selectColor(p),A.extend=r,A.destroy=s.destroy,Object.defineProperty(A,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(_!==s.namespaces&&(_=s.namespaces,w=s.enabled(p)),w),set:I=>{f=I}}),typeof s.init=="function"&&s.init(A),A}function r(p,h){const f=s(this.namespace+(typeof h>"u"?":":h)+p);return f.log=this.log,f}function a(p){s.save(p),s.namespaces=p,s.names=[],s.skips=[];const h=(typeof p=="string"?p:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const f of h)f[0]==="-"?s.skips.push(f.slice(1)):s.names.push(f)}function i(p,h){let f=0,_=0,w=-1,A=0;for(;f<p.length;)if(_<h.length&&(h[_]===p[f]||h[_]==="*"))h[_]==="*"?(w=_,A=f,_++):(f++,_++);else if(w!==-1)_=w+1,A++,f=A;else return!1;for(;_<h.length&&h[_]==="*";)_++;return _===h.length}function o(){const p=[...s.names,...s.skips.map(h=>"-"+h)].join(",");return s.enable(""),p}function u(p){for(const h of s.skips)if(i(p,h))return!1;for(const h of s.names)if(i(p,h))return!0;return!1}function c(p){return p instanceof Error?p.stack||p.message:p}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}return _s=n,_s}var ma;function gl(){return ma||(ma=1,(function(n,e){var t={};e.formatArgs=r,e.save=a,e.load=i,e.useColors=s,e.storage=o(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const l="color: "+this.color;c.splice(1,0,l,"color: inherit");let p=0,h=0;c[0].replace(/%[a-zA-Z%]/g,f=>{f!=="%%"&&(p++,f==="%c"&&(h=p))}),c.splice(h,0,l)}e.log=console.debug||console.log||(()=>{});function a(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function i(){let c;try{c=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=t.DEBUG),c}function o(){try{return localStorage}catch{}}n.exports=_l()(e);const{formatters:u}=n.exports;u.j=function(c){try{return JSON.stringify(c)}catch(l){return"[UnexpectedJSONParseError]: "+l.message}}})(dn,dn.exports)),dn.exports}var yl=gl();const vl=hl(yl);function Zi(){return _r()}function _a(n){const e=Zi();return typeof e<"u"&&(e[n]==="true"||e[n]==="1")}const qi={get disabled(){return!0}},Wi={get dontLogModelData(){return _a("OPENAI_AGENTS_DONT_LOG_MODEL_DATA")},get dontLogToolData(){return _a("OPENAI_AGENTS_DONT_LOG_TOOL_DATA")}},wl=Wi.dontLogModelData,bl=Wi.dontLogToolData;function mr(n="openai-agents"){return{namespace:n,debug:vl(n),error:console.error,warn:console.warn,dontLogModelData:wl,dontLogToolData:bl}}const R=mr("openai-agents:core");function Ye(n){if(n==null)return String(n);if(typeof n=="string")return n;if(typeof n=="object")try{return JSON.stringify(n)}catch{return"[object with circular references]"}return String(n)}function xl(n){return"serverUrl"in n?{type:"hosted_tool",name:"hosted_mcp",providerData:typeof n.requireApproval>"u"||n.requireApproval==="never"?{type:"mcp",server_label:n.serverLabel,server_url:n.serverUrl,require_approval:"never",allowed_tools:yt(n.allowedTools),headers:n.headers}:{type:"mcp",server_label:n.serverLabel,server_url:n.serverUrl,allowed_tools:yt(n.allowedTools),headers:n.headers,require_approval:typeof n.requireApproval=="string"?"always":gs(n.requireApproval),on_approval:n.onApproval}}:"connectorId"in n?{type:"hosted_tool",name:"hosted_mcp",providerData:typeof n.requireApproval>"u"||n.requireApproval==="never"?{type:"mcp",server_label:n.serverLabel,connector_id:n.connectorId,authorization:n.authorization,require_approval:"never",allowed_tools:yt(n.allowedTools),headers:n.headers}:{type:"mcp",server_label:n.serverLabel,connector_id:n.connectorId,authorization:n.authorization,allowed_tools:yt(n.allowedTools),headers:n.headers,require_approval:typeof n.requireApproval=="string"?"always":gs(n.requireApproval),on_approval:n.onApproval}}:{type:"hosted_tool",name:"hosted_mcp",providerData:typeof n.requireApproval>"u"||n.requireApproval==="never"?{type:"mcp",server_label:n.serverLabel,require_approval:"never",allowed_tools:yt(n.allowedTools)}:{type:"mcp",server_label:n.serverLabel,allowed_tools:yt(n.allowedTools),require_approval:typeof n.requireApproval=="string"?"always":gs(n.requireApproval),on_approval:n.onApproval}}}function Sl(n,e){return`An error occurred while running the tool. Please try again. Error: ${e instanceof Error?e.toString():String(e)}`}function qs(n){const e=n.name?qn(n.name):qn(n.execute.name),t=typeof n.errorFunction>"u"?Sl:n.errorFunction;if(!e)throw new Error("Tool name cannot be empty. Either name your function or provide a name in the options.");const s=n.strict??!0;if(!s&&ft(n.parameters))throw new H("Strict mode is required for Zod parameters");const{parser:r,schema:a}=hr(n.parameters,e);async function i(c,l,p){const[h,f]=await ur(()=>r(l));if(h!==null)throw R.dontLogToolData?R.debug(`Invalid JSON input for tool ${e}`):R.debug(`Invalid JSON input for tool ${e}: ${l}`),new Te("Invalid JSON input for tool");R.dontLogToolData?R.debug(`Invoking tool ${e}`):R.debug(`Invoking tool ${e} with input ${l}`);const _=await n.execute(f,c,p),w=Ye(_);return R.dontLogToolData?R.debug(`Tool ${e} completed`):R.debug(`Tool ${e} returned: ${w}`),_}async function o(c,l,p){return i(c,l,p).catch(h=>{if(t)return Qt()?.setError({message:"Error running tool (non-fatal)",data:{tool_name:e,error:h.toString()}}),t(c,h);throw h})}const u=typeof n.needsApproval=="function"?n.needsApproval:async()=>typeof n.needsApproval=="boolean"?n.needsApproval:!1;return{type:"function",name:e,description:n.description,parameters:a,strict:s,invoke:o,needsApproval:u}}function gs(n){const e={};return n.always&&(e.always={tool_names:n.always.toolNames}),n.never&&(e.never={tool_names:n.never.toolNames}),e}function yt(n){if(!(typeof n>"u"))return Array.isArray(n)?{tool_names:n}:{tool_names:n?.toolNames??[]}}g({name:d(),description:d().optional(),inputSchema:g({type:y("object"),properties:ee(d(),F()),required:B(d()),additionalProperties:ot()})});const ys={};async function Al({server:n,convertSchemasToStrict:e,runContext:t,agent:s}){return n.cacheToolsList&&ys[n.name]?ys[n.name].map(r=>ga(r,n,e)):Kl(async r=>{const a=await n.listTools();let i=a;if(t&&s){const u={runContext:t,agent:s,serverName:n.name},c=[];for(const l of a){const p=n.toolFilter;if(p)if(typeof p=="function"){if(!await p(u,l)){R.debug(`MCP Tool (server: ${n.name}, tool: ${l.name}) is blocked by the callable filter.`);continue}}else{const h=p.allowedToolNames??[],f=p.blockedToolNames??[];if(h.length>0||f.length>0){const _=h.length>0?h.includes(l.name):!0,w=f.length>0?f.includes(l.name):!1;if(!_||w){w?R.debug(`MCP Tool (server: ${n.name}, tool: ${l.name}) is blocked by the static filter.`):_||R.debug(`MCP Tool (server: ${n.name}, tool: ${l.name}) is not allowed by the static filter.`);continue}}}c.push(l)}i=c}r.spanData.result=i.map(u=>u.name);const o=i.map(u=>ga(u,n,e));return n.cacheToolsList&&(ys[n.name]=i),o},{data:{server:n.name}})}async function Tl(n,e,t,s=!1){const r=Array.isArray(n)?{mcpServers:n,runContext:e,agent:t,convertSchemasToStrict:s}:n,{mcpServers:a,convertSchemasToStrict:i=!1,runContext:o,agent:u}=r,c=[],l=new Set;for(const p of a){const h=await Al({server:p,convertSchemasToStrict:i,runContext:o,agent:u}),_=[...new Set(h.map(w=>w.name))].filter(w=>l.has(w));if(_.length>0)throw new H(`Duplicate tool names found across MCP servers: ${_.join(", ")}`);for(const w of h)l.add(w.name),c.push(w)}return c}function ga(n,e,t){async function s(i,o){let u={};typeof i=="string"&&i?u=JSON.parse(i):typeof i=="object"&&i!=null&&(u=i);const c=Qt();c&&(c.spanData.mcp_data={server:e.name});const l=await e.callTool(n.name,u);return l.length===1?l[0]:l}const r={...n.inputSchema,type:n.inputSchema?.type??"object",properties:n.inputSchema?.properties??{},required:n.inputSchema?.required??[],additionalProperties:n.inputSchema?.additionalProperties??!1};if(t||r.additionalProperties===!0)try{const i=Il(r);return qs({name:n.name,description:n.description||"",parameters:i,strict:!0,execute:s})}catch(i){R.warn(`Error converting MCP schema to strict mode: ${i}`)}const a={...r,additionalProperties:!0};return qs({name:n.name,description:n.description||"",parameters:a,strict:!1,execute:s})}function Il(n){const e={...n,additionalProperties:!1};return e.required||(e.required=[]),e}function _r(){return{}}class ts{#e=new EventTarget;#t=new Map;on(e,t){const s=e;let r=this.#t.get(s);r||(r=new Map,this.#t.set(s,r));let a=r.get(t);a||(a=new Set,r.set(t,a));const i=(o=>t(...o.detail??[]));return a.add(i),this.#e.addEventListener(s,i),this}off(e,t){const s=e,r=this.#t.get(s),a=r?.get(t);if(a?.size){for(const i of a)this.#e.removeEventListener(s,i);r?.delete(t),r?.size===0&&this.#t.delete(s)}return this}emit(e,...t){const s=new CustomEvent(e,{detail:t});return this.#e.dispatchEvent(s)}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};return this.on(e,s),this}}const Hi=crypto.randomUUID.bind(crypto),kl=class{constructor(){}pipeTo(e,t){}pipeThrough(e,t){}},Cl=globalThis.ReadableStream,El=globalThis.TransformStream;class Rl{context=null;constructor(){}run(e,t){return this.context=e,t()}getStore(){return this.context}enterWith(e){this.context=e}}class Ol{constructor(){}setTimeout(e,t){const s=setTimeout(e,t);return s.ref=typeof s.ref=="function"?s.ref:()=>s,s.unref=typeof s.unref=="function"?s.unref:()=>s,s.hasRef=typeof s.hasRef=="function"?s.hasRef:()=>!0,s.refresh=typeof s.refresh=="function"?s.refresh:()=>s,s}clearTimeout(e){window.clearTimeout(e)}}const Dl=new Ol;let ya;function Le(){return ya??=new Rl,ya}function Yt(){const n=Le().getStore();return n?.trace?n.trace:null}function Qt(){const n=Le().getStore();return n?.span?n.span:null}function zi(n){return async()=>{const e=Yt();if(!e)throw new Error("No trace found");await e.start();const t=await n(e);return await e.end(),t}}async function Nl(n,e,t={}){const s=typeof n=="string"?be().createTrace({...t,name:n}):n;return Le().run({trace:s},zi(e))}async function Pl(n,e={}){if(Yt())return await n();const s=be().createTrace(e);return Le().run({trace:s},zi(n))}function Ct(n){const e=Le().getStore();if(!e)throw new Error("No existing trace found");e.span&&(e.span.previousSpan=e.previousSpan,e.previousSpan=e.span),e.span=n,Le().enterWith(e)}function rt(){const n=Le().getStore();n&&(n.span=n.previousSpan,n.previousSpan=n.previousSpan?.previousSpan,Le().enterWith(n))}function Et(n){const e=Qt();e&&e.setError(n)}function $l(n){return{trace:n.trace?.clone(),span:n.span?.clone(),previousSpan:n.previousSpan?.clone()}}function Ws(n){const e=Le().getStore();if(!e)throw new Error("No existing trace found");const t=$l(e);return Le().run(t,n)}class Ml{async export(e){if(qi.disabled){R.debug("Tracing is disabled. Skipping export");return}for(const t of e)t.type==="trace"?console.log(`[Exporter] Export trace traceId=${t.traceId} name=${t.name}${t.groupId?` groupId=${t.groupId}`:""}`):console.log(`[Exporter] Export span: ${JSON.stringify(t)}`)}}class Gi{#e;#t;#n;#s;#i;#a=[];#o;#r=null;#u=!1;#d=null;constructor(e,{maxQueueSize:t=1e3,maxBatchSize:s=100,scheduleDelay:r=5e3,exportTriggerRatio:a=.8}={}){this.#e=t,this.#t=s,this.#n=r,this.#s=t*a,this.#i=e,this.#o=Dl,R.debug("Automatic trace export loop is not supported in this environment. You need to manually call `getGlobalTraceProvider().forceFlush()` to export traces.")}start(){this.#d=new AbortController,this.#p()}async#c(e){if(this.#a.length+1>this.#e){R.error("Dropping trace because buffer is full");return}this.#a.push(e),this.#a.length>this.#s&&await this.#l()}#p(){this.#r=this.#o.setTimeout(async()=>{await this.#l(),this.#p()},this.#n),typeof this.#r.unref=="function"&&this.#r.unref()}async#l(e=!1){if(this.#a.length!==0){if(R.debug(`Exporting batches. Force: ${e}. Buffer size: ${this.#a.length}`),e||this.#a.length<this.#t){const t=[...this.#a];this.#a=[],this.#u=!0,await this.#i.export(t),this.#u=!1}else if(this.#a.length>0){const t=this.#a.splice(0,this.#t);this.#u=!0,await this.#i.export(t),this.#u=!1}}}async onTraceStart(e){await this.#c(e)}async onTraceEnd(e){}async onSpanStart(e){}async onSpanEnd(e){await this.#c(e)}async shutdown(e){for(e&&this.#o.setTimeout(()=>{this.#d?.abort()},e),R.debug("Shutting down gracefully");this.#a.length>0;){if(R.debug(`Waiting for buffer to empty. Items left: ${this.#a.length}`),this.#u||await this.#l(!0),this.#d?.signal.aborted){R.debug("Timeout reached, force flushing"),await this.#l(!0);break}await new Promise(t=>this.#o.setTimeout(t,500))}R.debug("Buffer empty. Exiting"),this.#o&&this.#r&&this.#o.clearTimeout(this.#r)}async forceFlush(){this.#a.length>0&&await this.#l(!0)}}class Ll{#e=[];start(){for(const e of this.#e)e.start&&e.start()}addTraceProcessor(e){this.#e.push(e)}setProcessors(e){R.debug("Shutting down old processors");for(const t of this.#e)t.shutdown();this.#e=e}async onTraceStart(e){for(const t of this.#e)await t.onTraceStart(e)}async onTraceEnd(e){for(const t of this.#e)await t.onTraceEnd(e)}async onSpanStart(e){for(const t of this.#e)await t.onSpanStart(e)}async onSpanEnd(e){for(const t of this.#e)await t.onSpanEnd(e)}async shutdown(e){for(const t of this.#e)await t.shutdown(e)}async forceFlush(){for(const e of this.#e)await e.forceFlush()}}let vs=null,ws=null;function Fl(){return vs||(vs=new Ml),vs}function Vi(){return ws||(ws=new Gi(Fl())),ws}function va(){return new Date().toISOString()}function Ki(){return`trace_${Hi().replace(/-/g,"")}`}function jl(){return`span_${Hi().replace(/-/g,"").slice(0,24)}`}function Ul(n){return Object.fromEntries(Object.entries(n).filter(([e])=>!e.startsWith("_")))}class en{type="trace.span";#e;#t;#n;#s;#i;#a;#o;#r;#u;constructor(e,t){this.#t=e.traceId,this.#n=e.spanId??jl(),this.#e=e.data,this.#i=t,this.#s=e.parentId??null,this.#r=e.error??null,this.#a=e.startedAt??null,this.#o=e.endedAt??null}get traceId(){return this.#t}get spanData(){return this.#e}get spanId(){return this.#n}get parentId(){return this.#s}get previousSpan(){return this.#u}set previousSpan(e){this.#u=e}start(){if(this.#a){R.warn("Span already started");return}this.#a=va(),this.#i.onSpanStart(this)}end(){if(this.#o){R.debug("Span already finished",this.spanData);return}this.#o=va(),this.#i.onSpanEnd(this)}setError(e){this.#r=e}get error(){return this.#r}get startedAt(){return this.#a}get endedAt(){return this.#o}clone(){const e=new en({traceId:this.traceId,spanId:this.spanId,parentId:this.parentId??void 0,data:this.spanData,startedAt:this.#a??void 0,endedAt:this.#o??void 0,error:this.#r??void 0},this.#i);return e.previousSpan=this.previousSpan?.clone(),e}toJSON(){return{object:this.type,id:this.spanId,trace_id:this.traceId,parent_id:this.parentId,started_at:this.startedAt,ended_at:this.endedAt,span_data:Ul(this.spanData),error:this.error}}}class He extends en{constructor(e,t){super({traceId:"no-op",spanId:"no-op",data:e},t)}start(){}end(){}setError(){}toJSON(){return null}}class tn{type="trace";traceId;name;groupId=null;metadata;#e;#t;constructor(e,t){this.traceId=e.traceId??Ki(),this.name=e.name??"Agent workflow",this.groupId=e.groupId??null,this.metadata=e.metadata??{},this.#e=t??Vi(),this.#t=e.started??!1}async start(){this.#t||(this.#t=!0,await this.#e.onTraceStart(this))}async end(){this.#t&&(this.#t=!1,await this.#e.onTraceEnd(this))}clone(){return new tn({traceId:this.traceId,name:this.name,groupId:this.groupId??void 0,metadata:this.metadata,started:this.#t})}toJSON(){return{object:this.type,id:this.traceId,workflow_name:this.name,group_id:this.groupId,metadata:this.metadata}}}class bs extends tn{constructor(){super({})}async start(){}async end(){}toJSON(){return null}}class Bl{#e;#t;constructor(){this.#e=new Ll,this.#t=qi.disabled,this.#n()}registerProcessor(e){this.#e.addTraceProcessor(e)}setProcessors(e){this.#e.setProcessors(e)}getCurrentTrace(){return Yt()}getCurrentSpan(){return Qt()}setDisabled(e){this.#t=e}startExportLoop(){this.#e.start()}createTrace(e){if(this.#t)return R.debug("Tracing is disabled, Not creating trace %o",e),new bs;const t=e.traceId??Ki(),s=e.name??"Agent workflow";return R.debug("Creating trace %s with name %s",t,s),new tn({...e,name:s,traceId:t},this.#e)}createSpan(e,t){if(this.#t||e.disabled)return R.debug("Tracing is disabled, Not creating span %o",e),new He(e.data,this.#e);let s,r;if(t){if(t instanceof tn){if(t instanceof bs)return R.debug("Parent trace is no-op, returning NoopSpan"),new He(e.data,this.#e);r=t.traceId}else if(t instanceof en){if(t instanceof He)return R.debug("Parent span is no-op, returning NoopSpan"),new He(e.data,this.#e);s=t.spanId,r=t.traceId}}else{const a=Yt(),i=Qt();if(!a)return R.error("No active trace. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new He(e.data,this.#e);if(i instanceof He||a instanceof bs)return R.debug(`Parent ${i} or ${a} is no-op, returning NoopSpan`),new He(e.data,this.#e);r=a.traceId,i?(R.debug("Using parent span %s",i.spanId),s=i.spanId):R.debug("No parent span, using current trace %s",a.traceId)}return r?(R.debug(`Creating span ${JSON.stringify(e.data)} with id ${e.spanId??r}`),new en({...e,traceId:r,parentId:s},this.#e)):(R.error("No traceId found. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new He(e.data,this.#e))}async shutdown(e){try{R.debug("Shutting down tracing provider"),await this.#e.shutdown(e)}catch(t){R.error("Error shutting down tracing provider %o",t)}}#n(){if(typeof process<"u"&&typeof process.on=="function"){const e=async()=>{const t=setTimeout(()=>{console.warn("Cleanup timeout, forcing exit"),process.exit(1)},5e3);try{await this.shutdown()}finally{clearTimeout(t)}};process.on("beforeExit",e),process.on("SIGINT",async()=>{await e(),wa("SIGINT")||process.exit(130)}),process.on("SIGTERM",async()=>{await e(),wa("SIGTERM")||process.exit(0)}),process.on("unhandledRejection",async(t,s)=>{R.error("Unhandled rejection",t,s),await e(),Jl("unhandledRejection")||process.exit(1)})}}async forceFlush(){await this.#e.forceFlush()}}function wa(n){return process.listeners(n).length>1}function Jl(n){return process.listeners(n).length>1}let xs;function be(){return xs||(xs=new Bl),xs}function Nt(n){return async(e,...t)=>Ws(async()=>{const s=n(...t);Ct(s);try{return s.start(),await e(s)}catch(r){throw s.setError({message:r.message,data:r.data}),r}finally{s.end(),rt()}})}function Xi(n,e){return n={},be().createSpan({...n,data:{type:"response",...n.data}},e)}const Zl=Nt(Xi);function ba(n,e){return be().createSpan({...n,data:{type:"agent",name:n?.data?.name??"Agent",...n?.data}},e)}function ql(n,e){return be().createSpan({...n,data:{type:"function",input:n?.data?.input??"",output:n?.data?.output??"",...n?.data}},e)}const xa=Nt(ql);function Wl(n,e){return be().createSpan({...n,data:{type:"handoff",...n?.data}},e)}const Hl=Nt(Wl);function Yi(n,e){return be().createSpan({...n,data:{type:"generation",...n?.data}},e)}const zl=Nt(Yi);function Gl(n,e){return be().createSpan({...n,data:{type:"guardrail",triggered:!1,...n?.data}},e)}const Sa=Nt(Gl);function Vl(n,e){return be().createSpan({...n,data:{type:"mcp_tools",...n?.data}},e)}const Kl=Nt(Vl);function Xl(n){be().registerProcessor(n)}function Yl(n){be().setProcessors(n)}class gr{on(e,t){return this.eventEmitter.on(e,t),this.eventEmitter}off(e,t){return this.eventEmitter.off(e,t),this.eventEmitter}emit(e,...t){return this.eventEmitter.emit(e,...t)}once(e,t){return this.eventEmitter.once(e,t),this.eventEmitter}}class Ql extends gr{eventEmitter=new ts}class ed extends gr{eventEmitter=new ts}const td="OPENAI_DEFAULT_MODEL";function ns(n){return n.startsWith("gpt-5-chat")?!1:n.startsWith("gpt-5")}function Qi(){return ns(yr())}function yr(){return Zi()[td]?.toLowerCase()??"gpt-4.1"}function nd(n){const e=yr();return ns(e)?{providerData:{reasoning:{effort:"low"},text:{verbosity:"low"}}}:{}}function Aa({name:n,execute:e}){return{type:"input",name:n,guardrailFunction:e,async run(t){return{guardrail:{type:"input",name:n},output:await e(t)}}}}function Hs({name:n,execute:e}){return{type:"output",name:n,guardrailFunction:e,async run(t){return{guardrail:{type:"output",name:n},agent:t.agent,agentOutput:t.agentOutput,output:await e(t)}}}}function eo(n){return JSON.stringify({assistant:n.name})}function sd(n){return`transfer_to_${qn(n.name)}`}function rd(n){return`Handoff to the ${n.name} agent to handle the request. ${n.handoffDescription??""}`}class to{toolName;toolDescription;inputJsonSchema={type:"object",properties:{},required:[],additionalProperties:!1};strictJsonSchema=!0;onInvokeHandoff;agentName;inputFilter;agent;getHandoffAsFunctionTool(){return{type:"function",name:this.toolName,description:this.toolDescription,parameters:this.inputJsonSchema,strict:this.strictJsonSchema}}constructor(e,t){this.agentName=e.name,this.onInvokeHandoff=t,this.toolName=sd(e),this.toolDescription=rd(e),this.agent=e}}function no(n,e={}){let t;const s=!!e.onHandoff,r=!!e.inputType;if(!(s===r))throw new H("You must provide either both `onHandoff` and `inputType` or neither.");async function i(u,c){if(t){if(!c)throw Et({message:`Handoff function expected non empty input but got: ${c}`,data:{details:"input is empty"}}),new Te("Handoff function expected non empty input");try{const l=await t(c);e.onHandoff&&await e.onHandoff(u,l)}catch(l){throw Et({message:"Invalid JSON provided",data:{}}),R.dontLogToolData||R.error(`Invalid JSON when parsing: ${c}. Error: ${l}`),new Te("Invalid JSON provided")}}else await e.onHandoff?.(u);return n}const o=new to(n,i);if(e.inputType){const u=hr(e.inputType,o.toolName);o.inputJsonSchema=u.schema,o.strictJsonSchema=!0,t=u.parser}return e.toolNameOverride&&(o.toolName=e.toolNameOverride),e.toolDescriptionOverride&&(o.toolDescription=e.toolDescriptionOverride),e.inputFilter&&(o.inputFilter=e.inputFilter),o}function Wn(n){return n instanceof to?n:no(n)}let zs;function ad(n){zs=n}function id(){if(typeof zs>"u")throw new Error("No default model provider set. Make sure to set a provider using setDefaultModelProvider before calling getDefaultModelProvider or pass an explicit provider.");return zs}const ue=g({providerData:ee(d(),F()).optional()}),_t=ue.extend({id:d().optional()}),od=ue.extend({type:y("refusal"),refusal:d()}),ud=ue.extend({type:y("output_text"),text:d()}),so=ue.extend({type:y("input_text"),text:d()}),cd=ue.extend({type:y("reasoning_text"),text:d()}),ld=ue.extend({type:y("input_image"),image:d().or(g({id:d()})).describe("Could be a URL, base64 or an object with a file ID.")}),dd=ue.extend({type:y("input_file"),file:d().describe("Either base64 encoded file data or a publicly accessible file URL").or(g({id:d().describe("OpenAI file ID")})).or(g({url:d().describe("Publicly accessible PDF file URL")})).describe("Contents of the file or an object with a file ID.")}),ro=ue.extend({type:y("audio"),audio:d().or(g({id:d()})).describe("Base64 encoded audio data or file id"),format:d().nullable().optional(),transcript:d().nullable().optional()}),pd=ue.extend({type:y("image"),image:d().describe("Base64 encoded image data")}),fd=ue.extend({type:y("text"),text:d()}),hd=ue.extend({type:y("image"),data:d().describe("Base64 encoded image data"),mediaType:d().describe("IANA media type of the image")}),md=ue.extend({type:y("computer_screenshot"),data:d().describe("Base64 encoded image data or URL")}),_d=we("type",[g({type:y("screenshot")}),g({type:y("click"),x:C(),y:C(),button:V(["left","right","wheel","back","forward"])}),g({type:y("double_click"),x:C(),y:C()}),g({type:y("scroll"),x:C(),y:C(),scroll_x:C(),scroll_y:C()}),g({type:y("type"),text:d()}),g({type:y("wait")}),g({type:y("move"),x:C(),y:C()}),g({type:y("keypress"),keys:B(d())}),g({type:y("drag"),path:B(g({x:C(),y:C()}))})]),gd=we("type",[ud,od,ro,pd]),vr=_t.extend({type:y("message").optional()}),ss=vr.extend({role:y("assistant"),status:V(["in_progress","completed","incomplete"]),content:B(gd)}),yd=we("type",[so,ld,dd,ro]),ao=vr.extend({role:y("user"),content:B(yd).or(d())}),io=vr.extend({role:y("system"),content:d()});we("role",[io,ss,ao]);const nn=_t.extend({type:y("hosted_tool_call"),name:d().describe("The name of the hosted tool"),arguments:d().describe("The arguments of the hosted tool call").optional(),status:d().optional(),output:d().optional()}),sn=_t.extend({type:y("function_call"),callId:d().describe("The ID of the tool call"),name:d().describe("The name of the function"),status:V(["in_progress","completed","incomplete"]).optional(),arguments:d()}),Gs=_t.extend({type:y("function_call_result"),name:d().describe("The name of the tool"),callId:d().describe("The ID of the tool call"),status:V(["in_progress","completed","incomplete"]),output:we("type",[fd,hd])}),wr=_t.extend({type:y("computer_call"),callId:d().describe("The ID of the computer call"),status:V(["in_progress","completed","incomplete"]),action:_d}),vd=_t.extend({type:y("computer_call_result"),callId:d().describe("The ID of the computer call"),output:md}),wd=we("type",[wr,sn,nn]),br=ue.extend({id:d().optional(),type:y("reasoning"),content:B(so),rawContent:B(cd).optional()}),oo=_t.extend({type:y("unknown")}),xr=we("type",[ss,nn,sn,wr,br,oo]),bd=Li([ao,ss,io,nn,sn,wr,Gs,vd,br,oo]),xd=g({requests:C().optional(),inputTokens:C(),outputTokens:C(),totalTokens:C(),inputTokensDetails:ee(d(),C()).optional(),outputTokensDetails:ee(d(),C()).optional()}),uo=ue.extend({type:y("output_text_delta"),delta:d()}),Sd=ue.extend({type:y("response_started")}),co=ue.extend({type:y("response_done"),response:ue.extend({id:d(),usage:xd,output:B(xr)})}),Ad=ue.extend({type:y("model"),event:F().describe("The event from the model")});we("type",[uo,co,Sd,Ad]);class ht{requests;inputTokens;outputTokens;totalTokens;inputTokensDetails=[];outputTokensDetails=[];constructor(e){if(typeof e>"u")this.requests=0,this.inputTokens=0,this.outputTokens=0,this.totalTokens=0,this.inputTokensDetails=[],this.outputTokensDetails=[];else{this.requests=e?.requests??1,this.inputTokens=e?.inputTokens??e?.input_tokens??0,this.outputTokens=e?.outputTokens??e?.output_tokens??0,this.totalTokens=e?.totalTokens??e?.total_tokens??0;const t=e?.inputTokensDetails??e?.input_tokens_details;this.inputTokensDetails=t?[t]:[];const s=e?.outputTokensDetails??e?.output_tokens_details;this.outputTokensDetails=s?[s]:[]}}add(e){this.requests+=e.requests,this.inputTokens+=e.inputTokens,this.outputTokens+=e.outputTokens,this.totalTokens+=e.totalTokens,e.inputTokensDetails&&this.inputTokensDetails.push(...e.inputTokensDetails),e.outputTokensDetails&&this.outputTokensDetails.push(...e.outputTokensDetails)}}class It{context;usage;#e;constructor(e={}){this.context=e,this.usage=new ht,this.#e=new Map}_rebuildApprovals(e){this.#e=new Map(Object.entries(e))}isToolApproved({toolName:e,callId:t}){const s=this.#e.get(e);if(s?.approved===!0&&s.rejected===!0)return R.warn("Tool is permanently approved and rejected at the same time. Approval takes precedence"),!0;if(s?.approved===!0)return!0;if(s?.rejected===!0)return!1;const r=Array.isArray(s?.approved)?s.approved.includes(t):!1,a=Array.isArray(s?.rejected)?s.rejected.includes(t):!1;if(r&&a)return R.warn(`Tool call ${t} is both approved and rejected at the same time. Approval takes precedence`),!0;if(r)return!0;if(a)return!1}approveTool(e,{alwaysApprove:t=!1}={}){const s=e.rawItem.name;if(t){this.#e.set(s,{approved:!0,rejected:[]});return}const r=this.#e.get(s)??{approved:[],rejected:[]};if(Array.isArray(r.approved)){const a="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;r.approved.push(a)}this.#e.set(s,r)}rejectTool(e,{alwaysReject:t=!1}={}){const s=e.rawItem.name;if(t){this.#e.set(s,{approved:!1,rejected:!0});return}const r=this.#e.get(s)??{approved:[],rejected:[]};if(Array.isArray(r.rejected)){const a="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;r.rejected.push(a)}this.#e.set(s,r)}toJSON(){return{context:this.context,usage:this.usage,approvals:Object.fromEntries(this.#e.entries())}}}class lo{state;constructor(e){this.state=e}get history(){return rn(this.input,this.newItems)}get output(){return rn([],this.newItems)}get input(){return this.state._originalInput}get newItems(){return this.state._generatedItems}get rawResponses(){return this.state._modelResponses}get lastResponseId(){const e=this.rawResponses;return e&&e.length>0?e[e.length-1].responseId:void 0}get lastAgent(){return this.state._currentAgent}get inputGuardrailResults(){return this.state._inputGuardrailResults}get outputGuardrailResults(){return this.state._outputGuardrailResults}get interruptions(){return this.state._currentStep?.type==="next_step_interruption"?this.state._currentStep.data.interruptions:[]}get finalOutput(){if(this.state._currentStep?.type==="next_step_final_output")return this.state._currentAgent.processFinalOutput(this.state._currentStep.output);R.warn("Accessed finalOutput before agent run is completed.")}}class Ss extends lo{constructor(e){super(e)}}class Td extends lo{get currentAgent(){return this.lastAgent}currentTurn=0;maxTurns;#e=null;#t;#n;#s;#i;#a;#o;#r=!1;constructor(e={}){super(e.state),this.#t=e.signal,this.#t&&this.#t.addEventListener("abort",async()=>{await this.#s.cancel()}),this.#s=new Cl({start:t=>{this.#n=t},cancel:()=>{this.#r=!0}}),this.#i=new Promise((t,s)=>{this.#a=t,this.#o=s})}_addItem(e){this.cancelled||this.#n?.enqueue(e)}_done(){!this.cancelled&&this.#n&&(this.#n.close(),this.#n=void 0,this.#a?.())}_raiseError(e){!this.cancelled&&this.#n&&(this.#n.error(e),this.#n=void 0),this.#e=e,this.#o?.(e),this.#i.catch(t=>{R.debug(`Resulted in an error: ${t}`)})}get cancelled(){return this.#r}toStream(){return this.#s}get completed(){return this.#i}get error(){return this.#e}toTextStream(e={}){const t=this.#s.pipeThrough(new El({transform(s,r){if(s.type==="raw_model_stream_event"&&s.data.type==="output_text_delta"){const a=uo.parse(s.data);r.enqueue(a.delta)}}}));return e.compatibleWithNodeStreams?kl.fromWeb(t):t}[Symbol.asyncIterator](){return this.#s[Symbol.asyncIterator]()}}function Ta(n){return n.type==="function"?{type:"function",name:n.name,description:n.description,parameters:n.parameters,strict:n.strict}:n.type==="computer"?{type:"computer",name:n.name,environment:n.computer.environment,dimensions:n.computer.dimensions}:{type:"hosted_tool",name:n.name,providerData:n.providerData}}function Ia(n){return{toolName:n.toolName,toolDescription:n.toolDescription,inputJsonSchema:n.inputJsonSchema,strictJsonSchema:n.strictJsonSchema}}class gt{type="base_item";rawItem;toJSON(){return{type:this.type,rawItem:this.rawItem}}}class rs extends gt{rawItem;agent;type="message_output_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}get content(){let e="";for(const t of this.rawItem.content)t.type==="output_text"&&(e+=t.text);return e}}class ut extends gt{rawItem;agent;type="tool_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Dt extends gt{rawItem;agent;output;type="tool_call_output_item";constructor(e,t,s){super(),this.rawItem=e,this.agent=t,this.output=s}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),output:Ye(this.output)}}}class Sr extends gt{rawItem;agent;type="reasoning_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Ar extends gt{rawItem;agent;type="handoff_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Tr extends gt{rawItem;sourceAgent;targetAgent;type="handoff_output_item";constructor(e,t,s){super(),this.rawItem=e,this.sourceAgent=t,this.targetAgent=s}toJSON(){return{...super.toJSON(),sourceAgent:this.sourceAgent.toJSON(),targetAgent:this.targetAgent.toJSON()}}}class Ie extends gt{rawItem;agent;type="tool_approval_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}function po(n){if(n.type!=="message"||n.role!=="assistant")return;const e=n.content[n.content.length-1];if(e.type==="output_text")return e.text}function Id(n){return n.output.length===0?"":po(n.output[n.output.length-1])||""}class kd{data;type="raw_model_stream_event";constructor(e){this.data=e}}class Cd{name;item;type="run_item_stream_event";constructor(e,t){this.name=e,this.item=t}}class Ed{agent;type="agent_updated_stream_event";constructor(e){this.agent=e}}function ka(n,e,t,s){const r=[],a=[],i=[],o=[],u=[],c=[],l=new Map(s.map(_=>[_.toolName,_])),p=new Map(t.filter(_=>_.type==="function").map(_=>[_.name,_])),h=t.find(_=>_.type==="computer"),f=new Map(t.filter(_=>_.type==="hosted_tool"&&_.providerData?.type==="mcp").map(_=>_).map(_=>[_.providerData.server_label,_]));for(const _ of n.output){if(_.type==="message")_.role==="assistant"&&r.push(new rs(_,e));else if(_.type==="hosted_tool_call"){r.push(new ut(_,e));const A=_.name;if(c.push(A),_.providerData?.type==="mcp_approval_request"||_.name==="mcp_approval_request"){const I=_.providerData,S=I.server_label,U=f.get(S);if(typeof U>"u"){const Y=`MCP server (${S}) not found in Agent (${e.name})`;throw Et({message:Y,data:{mcp_server_label:S}}),new Te(Y)}const q=new Ie({type:"hosted_tool_call",name:I.name,id:I.id,status:"in_progress",providerData:I},e);u.push({requestItem:q,mcpTool:U}),U.providerData.on_approval||r.push(q)}}else if(_.type==="reasoning")r.push(new Sr(_,e));else if(_.type==="computer_call"){if(r.push(new ut(_,e)),c.push("computer_use"),!h)throw Et({message:"Model produced computer action without a computer tool.",data:{agent_name:e.name}}),new Te("Model produced computer action without a computer tool.");o.push({toolCall:_,computer:h})}if(_.type!=="function_call")continue;c.push(_.name);const w=l.get(_.name);if(w)r.push(new Ar(_,e)),a.push({toolCall:_,handoff:w});else{const A=p.get(_.name);if(!A)throw Et({message:`Tool ${_.name} not found in agent ${e.name}.`,data:{tool_name:_.name,agent_name:e.name}}),new Te(`Tool ${_.name} not found in agent ${e.name}.`);r.push(new ut(_,e)),i.push({toolCall:_,tool:A})}}return{newItems:r,handoffs:a,functions:i,computerActions:o,mcpApprovalRequests:u,toolsUsed:c,hasToolsOrApprovalsToRun(){return a.length>0||i.length>0||u.length>0||o.length>0}}}const Rd=we("type",[g({type:y("next_step_handoff"),newAgent:F()}),g({type:y("next_step_final_output"),output:d()}),g({type:y("next_step_run_again")}),g({type:y("next_step_interruption"),data:ee(d(),F())})]);class xe{originalInput;modelResponse;preStepItems;newStepItems;nextStep;constructor(e,t,s,r,a){this.originalInput=e,this.modelResponse=t,this.preStepItems=s,this.newStepItems=r,this.nextStep=a}get generatedItems(){return this.preStepItems.concat(this.newStepItems)}}function Ca(n,e,t){return n.resetToolChoice&&e.hasUsedTools(n)?{...t,toolChoice:void 0}:t}async function Ea(n,e,t,s,r,a,i){const o=t.filter(_=>_ instanceof Ie&&"callId"in _.rawItem&&_.rawItem.type==="function_call").map(_=>_.rawItem.callId),u=r.functions.filter(_=>o.includes(_.toolCall.callId)),c=await fo(n,u,a,i),l=c.map(_=>_.runItem),p=r.mcpApprovalRequests.filter(_=>_.requestItem.type==="tool_approval_item"&&_.requestItem.rawItem.type==="hosted_tool_call"&&_.requestItem.rawItem.providerData?.type==="mcp_approval_request");for(const _ of p){const w=_.requestItem.rawItem.id,A=i._context.isToolApproved({toolName:_.requestItem.rawItem.name,callId:w});if(typeof A<"u"){const I={approve:A,approval_request_id:w,reason:void 0};l.push(new ut({type:"hosted_tool_call",name:"mcp_approval_response",providerData:I},n))}}const h=await ho(n,c,i),f=t.filter(_=>!(_ instanceof Ie));return h.isFinalOutput?(a.emit("agent_end",i._context,n,h.finalOutput),n.emit("agent_end",i._context,h.finalOutput),new xe(e,s,f,l,{type:"next_step_final_output",output:h.finalOutput})):h.isInterrupted?new xe(e,s,f,l,{type:"next_step_interruption",data:{interruptions:h.interruptions}}):new xe(e,s,f,l,{type:"next_step_run_again"})}async function Ra(n,e,t,s,r,a,i){const o=t;let u=r.newItems;const[c,l]=await Promise.all([fo(n,r.functions,a,i),Dd(n,r.computerActions,a,i._context)]);if(u=u.concat(c.map(A=>A.runItem)),u=u.concat(l),r.mcpApprovalRequests.length>0)for(const A of r.mcpApprovalRequests){const I=A.mcpTool.providerData,S=A.requestItem.rawItem.providerData;if(I.on_approval){const U=await I.on_approval(i._context,A.requestItem),q={approve:U.approve,approval_request_id:S.id,reason:U.reason};u.push(new ut({type:"hosted_tool_call",name:"mcp_approval_response",providerData:q},n))}else{u.push(A.requestItem);const U={type:"hosted_mcp_tool_approval",tool:A.mcpTool,runItem:new Ie({type:"hosted_tool_call",name:S.name,id:S.id,arguments:S.arguments,status:"in_progress",providerData:S},n)};c.push(U)}}if(r.handoffs.length>0)return await Nd(n,e,o,u,s,r.handoffs,a,i._context);const p=await ho(n,c,i);if(p.isFinalOutput)return a.emit("agent_end",i._context,n,p.finalOutput),n.emit("agent_end",i._context,p.finalOutput),new xe(e,s,o,u,{type:"next_step_final_output",output:p.finalOutput});if(p.isInterrupted)return new xe(e,s,o,u,{type:"next_step_interruption",data:{interruptions:p.interruptions}});if((r.functions?.length??0)>0||(r.computerActions?.length??0)>0||(r.mcpApprovalRequests?.length??0)>0||(r.handoffs?.length??0)>0)return new xe(e,s,o,u,{type:"next_step_run_again"});const f=u.filter(A=>A instanceof rs),_=f.length>0?po(f[f.length-1].rawItem):void 0;if(typeof _>"u")return new xe(e,s,o,u,{type:"next_step_run_again"});if(!c.some(A=>A.runItem instanceof Ie)){if(n.outputType==="text")return new xe(e,s,o,u,{type:"next_step_final_output",output:_});if(n.outputType!=="text"&&_){const{parser:A}=hr(n.outputType,"final_output"),[I]=await ur(()=>A(_));if(I)throw Et({message:"Invalid output type",data:{error:String(I)}}),new Te("Invalid output type");return new xe(e,s,o,u,{type:"next_step_final_output",output:_})}}return new xe(e,s,o,u,{type:"next_step_run_again"})}function Hn(n,e){return{type:"function_call_result",name:n.name,callId:n.callId,status:"completed",output:{type:"text",text:Ye(e)}}}async function fo(n,e,t,s){async function r(a){let i=a.toolCall.arguments;if(a.tool.parameters&&(ft(a.tool.parameters)?i=a.tool.parameters.parse(i):i=JSON.parse(i)),await a.tool.needsApproval(s._context,i,a.toolCall.callId)){const u=s._context.isToolApproved({toolName:a.tool.name,callId:a.toolCall.callId});if(u===!1)return xa(async c=>{const l="Tool execution was not approved.";return c.setError({message:l,data:{tool_name:a.tool.name,error:`Tool execution for ${a.toolCall.callId} was manually rejected by user.`}}),c.spanData.output=l,{type:"function_output",tool:a.tool,output:l,runItem:new Dt(Hn(a.toolCall,l),n,l)}},{data:{name:a.tool.name}});if(u!==!0)return{type:"function_approval",tool:a.tool,runItem:new Ie(a.toolCall,n)}}return xa(async u=>{t.config.traceIncludeSensitiveData&&(u.spanData.input=a.toolCall.arguments);try{t.emit("agent_tool_start",s._context,n,a.tool,{toolCall:a.toolCall}),n.emit("agent_tool_start",s._context,a.tool,{toolCall:a.toolCall});const c=await a.tool.invoke(s._context,a.toolCall.arguments,{toolCall:a.toolCall}),l=Ye(c);t.emit("agent_tool_end",s._context,n,a.tool,l,{toolCall:a.toolCall}),n.emit("agent_tool_end",s._context,a.tool,l,{toolCall:a.toolCall}),t.config.traceIncludeSensitiveData&&(u.spanData.output=l);const p={type:"function_output",tool:a.tool,output:c,runItem:new Dt(Hn(a.toolCall,c),n,c)},h=qd(a.toolCall);if(h){p.agentRunResult=h;const f=h.interruptions;f.length>0&&(p.interruptions=f)}return p}catch(c){throw u.setError({message:"Error running tool",data:{tool_name:a.tool.name,error:String(c)}}),c}},{data:{name:a.tool.name}})}try{return await Promise.all(e.map(r))}catch(a){throw new pl(`Failed to run function tools: ${a}`,a,s)}}async function Od(n,e){const t=e.action;let s;switch(t.type){case"click":await n.click(t.x,t.y,t.button);break;case"double_click":await n.doubleClick(t.x,t.y);break;case"drag":await n.drag(t.path.map(r=>[r.x,r.y]));break;case"keypress":await n.keypress(t.keys);break;case"move":await n.move(t.x,t.y);break;case"screenshot":s=await n.screenshot();break;case"scroll":await n.scroll(t.x,t.y,t.scroll_x,t.scroll_y);break;case"type":await n.type(t.text);break;case"wait":await n.wait();break}if(typeof s<"u"||typeof n.screenshot=="function"&&(s=await n.screenshot(),typeof s<"u"))return s;throw new Error("Computer does not implement screenshot()")}async function Dd(n,e,t,s,r=void 0){const a=r??R,i=[];for(const o of e){const u=o.computer.computer,c=o.toolCall;t.emit("agent_tool_start",s,n,o.computer,{toolCall:c}),typeof n.emit=="function"&&n.emit("agent_tool_start",s,o.computer,{toolCall:c});let l;try{l=await Od(u,c)}catch(f){a.error("Failed to execute computer action:",f),l=""}t.emit("agent_tool_end",s,n,o.computer,l,{toolCall:c}),typeof n.emit=="function"&&n.emit("agent_tool_end",s,o.computer,l,{toolCall:c});const p=l?`data:image/png;base64,${l}`:"",h={type:"computer_call_result",callId:c.callId,output:{type:"computer_screenshot",data:p}};i.push(new Dt(h,n,p))}return i}async function Nd(n,e,t,s,r,a,i,o){if(s=[...s],a.length===0)return R.warn("Incorrectly called executeHandoffCalls with no handoffs. This should not happen. Moving on."),new xe(e,r,t,s,{type:"next_step_run_again"});if(a.length>1){const c="Multiple handoffs detected, ignoring this one.";for(let l=1;l<a.length;l++)s.push(new Dt(Hn(a[l].toolCall,c),n,c))}const u=a[0];return Hl(async c=>{const l=u.handoff,p=await l.onInvokeHandoff(o,u.toolCall.arguments);if(c.spanData.to_agent=p.name,a.length>1){const f=a.map(_=>_.handoff.agentName);c.setError({message:"Multiple handoffs requested",data:{requested_agents:f}})}s.push(new Tr(Hn(u.toolCall,eo(p)),n,p)),i.emit("agent_handoff",o,n,p),n.emit("agent_handoff",o,p);const h=l.inputFilter??i.config.handoffInputFilter;if(h){R.debug("Filtering inputs for handoff"),typeof h!="function"&&c.setError({message:"Invalid input filter",data:{details:"not callable"}});const f={inputHistory:Array.isArray(e)?[...e]:e,preHandoffItems:[...t],newItems:[...s],runContext:o},_=h(f);e=_.inputHistory,t=_.preHandoffItems,s=_.newItems}return new xe(e,r,t,s,{type:"next_step_handoff",newAgent:p})},{data:{from_agent:n.name}})}const pn={isFinalOutput:!1,isInterrupted:void 0};async function ho(n,e,t){if(e.length===0)return pn;const s=[];for(const i of e)if(i.runItem instanceof Ie&&s.push(i.runItem),i.type==="function_output"){if(Array.isArray(i.interruptions))s.push(...i.interruptions);else if(i.agentRunResult){const o=i.agentRunResult.interruptions;o.length>0&&s.push(...o)}}if(s.length>0)return{isFinalOutput:!1,isInterrupted:!0,interruptions:s};if(n.toolUseBehavior==="run_llm_again")return pn;const r=e[0];if(n.toolUseBehavior==="stop_on_first_tool")return r?.type==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:Ye(r.output)}:pn;const a=n.toolUseBehavior;if(typeof a=="object"){const i=e.find(o=>a.stopAtToolNames.includes(o.tool.name));return i?.type==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:Ye(i.output)}:pn}if(typeof a=="function")return a(t._context,e);throw new H(`Invalid toolUseBehavior: ${a}`,t)}function Oa(n,e){for(const t of e.newStepItems){let s;if(t instanceof rs)s="message_output_created";else if(t instanceof Ar)s="handoff_requested";else if(t instanceof Tr)s="handoff_occurred";else if(t instanceof ut)s="tool_called";else if(t instanceof Dt)s="tool_output";else if(t instanceof Sr)s="reasoning_item_created";else if(t instanceof Ie)s="tool_approval_requested";else{R.warn("Unknown item type: ",t);continue}n._addItem(new Cd(s,t))}}class Da{#e=new Map;addToolUse(e,t){this.#e.set(e,t)}hasUsedTools(e){return this.#e.has(e)}toJSON(){return Object.fromEntries(Array.from(this.#e.entries()).map(([e,t])=>[e.name,t]))}}const bn="1.0",Pd=y(bn),De=g({name:d()}),$d=g({object:y("trace.span"),id:d(),trace_id:d(),parent_id:d().nullable(),started_at:d().nullable(),ended_at:d().nullable(),error:g({message:d(),data:ee(d(),F()).optional()}).nullable(),span_data:ee(d(),F())}),mo=$d.extend({previous_span:vc(()=>mo).optional()}),_o=g({requests:C(),inputTokens:C(),outputTokens:C(),totalTokens:C()}),Na=g({usage:_o,output:B(xr),responseId:d().optional(),providerData:ee(d(),F()).optional()}),go=we("type",[g({type:y("message_output_item"),rawItem:ss,agent:De}),g({type:y("tool_call_item"),rawItem:wd.or(nn),agent:De}),g({type:y("tool_call_output_item"),rawItem:Gs,agent:De,output:d()}),g({type:y("reasoning_item"),rawItem:br,agent:De}),g({type:y("handoff_call_item"),rawItem:sn,agent:De}),g({type:y("handoff_output_item"),rawItem:Gs,sourceAgent:De,targetAgent:De}),g({type:y("tool_approval_item"),rawItem:sn.or(nn),agent:De})]),Md=g({object:y("trace"),id:d(),workflow_name:d(),group_id:d().nullable(),metadata:ee(d(),F())}),Ld=g({newItems:B(go),toolsUsed:B(d()),handoffs:B(g({toolCall:F(),handoff:F()})),functions:B(g({toolCall:F(),tool:F()})),computerActions:B(g({toolCall:F(),computer:F()})),mcpApprovalRequests:B(g({requestItem:g({rawItem:g({type:y("hosted_tool_call"),name:d(),arguments:d().optional(),status:d().optional(),output:d().optional(),providerData:ee(d(),F()).nullable().optional()})}),mcpTool:g({type:y("hosted_tool"),name:y("hosted_mcp"),providerData:ee(d(),F())})})).optional()}),yo=g({tripwireTriggered:ot(),outputInfo:F()}),Fd=g({guardrail:g({type:y("input"),name:d()}),output:yo}),jd=g({guardrail:g({type:y("output"),name:d()}),agentOutput:F(),agent:De,output:yo}),Pa=g({$schemaVersion:Pd,currentTurn:C(),currentAgent:De,originalInput:d().or(B(bd)),modelResponses:B(Na),context:g({usage:_o,approvals:ee(d(),g({approved:B(d()).or(ot()),rejected:B(d()).or(ot())})),context:ee(d(),F())}),toolUseTracker:ee(d(),B(d())),maxTurns:C(),currentAgentSpan:mo.nullable().optional(),noActiveAgentRun:ot(),inputGuardrailResults:B(Fd),outputGuardrailResults:B(jd),currentStep:Rd.optional(),lastModelResponse:Na.optional(),generatedItems:B(go),lastProcessedResponse:Ld.optional(),trace:Md.nullable()});class nt{_currentTurn=0;_currentAgent;_originalInput;_modelResponses;_currentAgentSpan;_context;_toolUseTracker;_generatedItems;_maxTurns;_noActiveAgentRun=!0;_lastTurnResponse;_inputGuardrailResults;_outputGuardrailResults;_currentStep=void 0;_lastProcessedResponse=void 0;_trace=null;constructor(e,t,s,r){this._context=e,this._originalInput=structuredClone(t),this._modelResponses=[],this._currentAgentSpan=void 0,this._currentAgent=s,this._toolUseTracker=new Da,this._generatedItems=[],this._maxTurns=r,this._inputGuardrailResults=[],this._outputGuardrailResults=[],this._trace=Yt()}get history(){return rn(this._originalInput,this._generatedItems)}getInterruptions(){return this._currentStep?.type!=="next_step_interruption"?[]:this._currentStep.data.interruptions}approve(e,t={alwaysApprove:!1}){this._context.approveTool(e,t)}reject(e,t={alwaysReject:!1}){this._context.rejectTool(e,t)}toJSON(){const e={$schemaVersion:bn,currentTurn:this._currentTurn,currentAgent:{name:this._currentAgent.name},originalInput:this._originalInput,modelResponses:this._modelResponses.map(s=>({usage:{requests:s.usage.requests,inputTokens:s.usage.inputTokens,outputTokens:s.usage.outputTokens,totalTokens:s.usage.totalTokens},output:s.output,responseId:s.responseId,providerData:s.providerData})),context:this._context.toJSON(),toolUseTracker:this._toolUseTracker.toJSON(),maxTurns:this._maxTurns,currentAgentSpan:this._currentAgentSpan?.toJSON(),noActiveAgentRun:this._noActiveAgentRun,inputGuardrailResults:this._inputGuardrailResults,outputGuardrailResults:this._outputGuardrailResults.map(s=>({...s,agent:s.agent.toJSON()})),currentStep:this._currentStep,lastModelResponse:this._lastTurnResponse,generatedItems:this._generatedItems.map(s=>s.toJSON()),lastProcessedResponse:this._lastProcessedResponse,trace:this._trace?this._trace.toJSON():null},t=Pa.safeParse(e);if(!t.success)throw new dl(`Failed to serialize run state. ${t.error.message}`);return t.data}toString(){return JSON.stringify(this.toJSON())}static async fromString(e,t){const[s,r]=await ur(()=>JSON.parse(t));if(s)throw new H(`Failed to parse run state. ${s instanceof Error?s.message:String(s)}`);const a=r.$schemaVersion;if(!a)throw new H("Run state is missing schema version");if(a!==bn)throw new H(`Run state schema version ${a} is not supported. Please use version ${bn}`);const i=Pa.parse(JSON.parse(t)),o=Ud(e),u=new It(i.context.context);u._rebuildApprovals(i.context.approvals);const c=o.get(i.currentAgent.name);if(!c)throw new H(`Agent ${i.currentAgent.name} not found`);const l=new nt(u,"",c,i.maxTurns);l._currentTurn=i.currentTurn,l._toolUseTracker=new Da;for(const[p,h]of Object.entries(i.toolUseTracker))l._toolUseTracker.addToolUse(o.get(p),h);if(i.currentAgentSpan){i.trace||R.warn("Trace is not set, skipping tracing setup");const p=be().createTrace({traceId:i.trace?.id,name:i.trace?.workflow_name,groupId:i.trace?.group_id??void 0,metadata:i.trace?.metadata});l._currentAgentSpan=vo(p,i.currentAgentSpan),l._trace=p}return l._noActiveAgentRun=i.noActiveAgentRun,l._inputGuardrailResults=i.inputGuardrailResults,l._outputGuardrailResults=i.outputGuardrailResults.map(p=>({...p,agent:o.get(p.agent.name)})),l._currentStep=i.currentStep,l._originalInput=i.originalInput,l._modelResponses=i.modelResponses.map($a),l._lastTurnResponse=i.lastModelResponse?$a(i.lastModelResponse):void 0,l._generatedItems=i.generatedItems.map(p=>wo(p,o)),l._lastProcessedResponse=i.lastProcessedResponse?await Bd(o,l._currentAgent,l._context,i.lastProcessedResponse):void 0,i.currentStep?.type==="next_step_handoff"&&(l._currentStep={type:"next_step_handoff",newAgent:o.get(i.currentStep.newAgent.name)}),l}}function Ud(n){const e=new Map,t=[n];for(;t.length>0;){const s=t.shift();if(!e.has(s.name)){e.set(s.name,s);for(const r of s.handoffs)r instanceof qe?e.has(r.name)||t.push(r):r.agent&&(e.has(r.agent.name)||t.push(r.agent))}}return e}function vo(n,e){const t=e.span_data,s=e.previous_span?vo(n,e.previous_span):void 0,r=be().createSpan({spanId:e.id,traceId:e.trace_id,parentId:e.parent_id??void 0,startedAt:e.started_at??void 0,endedAt:e.ended_at??void 0,data:t},n);return r.previousSpan=s,r}function $a(n){const e=new ht;return e.requests=n.usage.requests,e.inputTokens=n.usage.inputTokens,e.outputTokens=n.usage.outputTokens,e.totalTokens=n.usage.totalTokens,{usage:e,output:n.output.map(t=>xr.parse(t)),responseId:n.responseId,providerData:n.providerData}}function wo(n,e){switch(n.type){case"message_output_item":return new rs(n.rawItem,e.get(n.agent.name));case"tool_call_item":return new ut(n.rawItem,e.get(n.agent.name));case"tool_call_output_item":return new Dt(n.rawItem,e.get(n.agent.name),n.output);case"reasoning_item":return new Sr(n.rawItem,e.get(n.agent.name));case"handoff_call_item":return new Ar(n.rawItem,e.get(n.agent.name));case"handoff_output_item":return new Tr(n.rawItem,e.get(n.sourceAgent.name),e.get(n.targetAgent.name));case"tool_approval_item":return new Ie(n.rawItem,e.get(n.agent.name))}}async function Bd(n,e,t,s){const r=await e.getAllTools(t),a=new Map(r.filter(c=>c.type==="function").map(c=>[c.name,c])),i=new Map(r.filter(c=>c.type==="computer").map(c=>[c.name,c])),o=new Map(e.handoffs.map(c=>c instanceof qe?[c.name,no(c)]:[c.toolName,c])),u={newItems:s.newItems.map(c=>wo(c,n)),toolsUsed:s.toolsUsed,handoffs:s.handoffs.map(c=>{if(!o.has(c.handoff.toolName))throw new H(`Handoff ${c.handoff.toolName} not found`);return{toolCall:c.toolCall,handoff:o.get(c.handoff.toolName)}}),functions:await Promise.all(s.functions.map(async c=>{if(!a.has(c.tool.name))throw new H(`Tool ${c.tool.name} not found`);return{toolCall:c.toolCall,tool:a.get(c.tool.name)}})),computerActions:s.computerActions.map(c=>{const l=c.computer.name;if(!i.has(l))throw new H(`Computer tool ${l} not found`);return{toolCall:c.toolCall,computer:i.get(l)}}),mcpApprovalRequests:(s.mcpApprovalRequests??[]).map(c=>({requestItem:new Ie(c.requestItem.rawItem,e),mcpTool:c.mcpTool}))};return{...u,hasToolsOrApprovalsToRun(){return u.handoffs.length>0||u.functions.length>0||u.mcpApprovalRequests.length>0||u.computerActions.length>0}}}const Ma=10;function La(n,e){return n?!1:e?!0:"enabled_without_data"}function rn(n,e){const t=e.filter(s=>s.type!=="tool_approval_item").map(s=>s.rawItem);return typeof n=="string"&&(n=[{type:"message",role:"user",content:n}]),[...n,...t]}class Jd extends ed{config;inputGuardrailDefs;outputGuardrailDefs;constructor(e={}){super(),this.config={modelProvider:e.modelProvider??id(),model:e.model,modelSettings:e.modelSettings,handoffInputFilter:e.handoffInputFilter,inputGuardrails:e.inputGuardrails,outputGuardrails:e.outputGuardrails,tracingDisabled:e.tracingDisabled??!1,traceIncludeSensitiveData:e.traceIncludeSensitiveData??!0,workflowName:e.workflowName??"Agent workflow",traceId:e.traceId,groupId:e.groupId,traceMetadata:e.traceMetadata},this.inputGuardrailDefs=(e.inputGuardrails??[]).map(Aa),this.outputGuardrailDefs=(e.outputGuardrails??[]).map(Hs)}async#e(e,t,s){return Ws(async()=>{const r=t instanceof nt?t:new nt(s.context instanceof It?s.context:new It(s.context),t,e,s.maxTurns??Ma);try{for(;;){const a=r._currentAgent.model!==void 0&&r._currentAgent.model!==""||this.config.model!==void 0&&this.config.model!=="";let i=Fa(r._currentAgent.model,this.config.model);if(typeof i=="string"&&(i=await this.config.modelProvider.getModel(i)),r._currentStep=r._currentStep??{type:"next_step_run_again"},r._currentStep.type==="next_step_interruption"){if(R.debug("Continuing from interruption"),!r._lastTurnResponse||!r._lastProcessedResponse)throw new H("No model response found in previous state",r);const o=await Ea(r._currentAgent,r._originalInput,r._generatedItems,r._lastTurnResponse,r._lastProcessedResponse,this,r);if(r._toolUseTracker.addToolUse(r._currentAgent,r._lastProcessedResponse.toolsUsed),r._originalInput=o.originalInput,r._generatedItems=o.generatedItems,r._currentStep=o.nextStep,o.nextStep.type==="next_step_interruption")return new Ss(r);continue}if(r._currentStep.type==="next_step_run_again"){const o=[];if(r._currentAgent.handoffs&&o.push(...r._currentAgent.handoffs.map(Wn)),!r._currentAgentSpan){const A=o.map(I=>I.agentName);r._currentAgentSpan=ba({data:{name:r._currentAgent.name,handoffs:A,output_type:r._currentAgent.outputSchemaName}}),r._currentAgentSpan.start(),Ct(r._currentAgentSpan)}const u=await r._currentAgent.getAllTools(r._context),c=u.map(A=>Ta(A)),l=o.map(A=>Ia(A));if(r._currentAgentSpan&&(r._currentAgentSpan.spanData.tools=u.map(A=>A.name)),r._currentTurn++,r._currentTurn>r._maxTurns)throw r._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:r._maxTurns}}),new ca(`Max turns (${r._maxTurns}) exceeded`,r);R.debug(`Running agent ${r._currentAgent.name} (turn ${r._currentTurn})`),r._currentTurn===1&&await this.#t(r);const p=rn(r._originalInput,r._generatedItems);r._noActiveAgentRun&&(r._currentAgent.emit("agent_start",r._context,r._currentAgent),this.emit("agent_start",r._context,r._currentAgent));let h={...this.config.modelSettings,...r._currentAgent.modelSettings};const f=r._currentAgent.modelSettings;h=ja(a,f,i,h),h=Ca(r._currentAgent,r._toolUseTracker,h),r._lastTurnResponse=await i.getResponse({systemInstructions:await r._currentAgent.getSystemPrompt(r._context),prompt:await r._currentAgent.getPrompt(r._context),input:p,previousResponseId:s.previousResponseId,conversationId:s.conversationId,modelSettings:h,tools:c,outputType:pa(r._currentAgent.outputType),handoffs:l,tracing:La(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:s.signal}),r._modelResponses.push(r._lastTurnResponse),r._context.usage.add(r._lastTurnResponse.usage),r._noActiveAgentRun=!1;const _=ka(r._lastTurnResponse,r._currentAgent,u,o);r._lastProcessedResponse=_;const w=await Ra(r._currentAgent,r._originalInput,r._generatedItems,r._lastTurnResponse,r._lastProcessedResponse,this,r);r._toolUseTracker.addToolUse(r._currentAgent,r._lastProcessedResponse.toolsUsed),r._originalInput=w.originalInput,r._generatedItems=w.generatedItems,r._currentStep=w.nextStep}if(r._currentStep&&r._currentStep.type==="next_step_final_output")return await this.#n(r,r._currentStep.output),this.emit("agent_end",r._context,r._currentAgent,r._currentStep.output),r._currentAgent.emit("agent_end",r._context,r._currentStep.output),new Ss(r);if(r._currentStep&&r._currentStep.type==="next_step_handoff")r._currentAgent=r._currentStep.newAgent,r._currentAgentSpan&&(r._currentAgentSpan.end(),rt(),r._currentAgentSpan=void 0),r._noActiveAgentRun=!0,r._currentStep={type:"next_step_run_again"};else{if(r._currentStep&&r._currentStep.type==="next_step_interruption")return new Ss(r);R.debug("Running next loop")}}}catch(a){throw r._currentAgentSpan&&r._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(a)}}),a}finally{r._currentAgentSpan&&(r._currentStep?.type!=="next_step_interruption"&&r._currentAgentSpan.end(),rt())}})}async#t(e){const t=this.inputGuardrailDefs.concat(e._currentAgent.inputGuardrails.map(Aa));if(t.length>0){const s={agent:e._currentAgent,input:e._originalInput,context:e._context};try{const r=await Promise.all(t.map(async a=>Sa(async i=>{const o=await a.run(s);return i.spanData.triggered=o.output.tripwireTriggered,o},{data:{name:a.name}},e._currentAgentSpan)));for(const a of r)if(a.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:a.guardrail.name}}),new da(`Input guardrail triggered: ${JSON.stringify(a.output.outputInfo)}`,a,e)}catch(r){throw r instanceof da?r:(e._currentTurn--,new la(`Input guardrail failed to complete: ${r}`,r,e))}}}async#n(e,t){const s=this.outputGuardrailDefs.concat(e._currentAgent.outputGuardrails.map(Hs));if(s.length>0){const r=e._currentAgent.processFinalOutput(t),a={agent:e._currentAgent,agentOutput:r,context:e._context,details:{modelResponse:e._lastTurnResponse}};try{const i=await Promise.all(s.map(async o=>Sa(async u=>{const c=await o.run(a);return u.spanData.triggered=c.output.tripwireTriggered,c},{data:{name:o.name}},e._currentAgentSpan)));for(const o of i)if(o.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:o.guardrail.name}}),new Zs(`Output guardrail triggered: ${JSON.stringify(o.output.outputInfo)}`,o,e)}catch(i){throw i instanceof Zs?i:new la(`Output guardrail failed to complete: ${i}`,i,e)}}}async#s(e,t){try{for(;;){const s=e.state._currentAgent,r=s.handoffs.map(Wn),a=await s.getAllTools(e.state._context),i=a.map(u=>Ta(u)),o=r.map(u=>Ia(u));if(e.state._currentStep=e.state._currentStep??{type:"next_step_run_again"},e.state._currentStep.type==="next_step_interruption"){if(R.debug("Continuing from interruption"),!e.state._lastTurnResponse||!e.state._lastProcessedResponse)throw new H("No model response found in previous state",e.state);const u=await Ea(e.state._currentAgent,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);if(Oa(e,u),e.state._toolUseTracker.addToolUse(e.state._currentAgent,e.state._lastProcessedResponse.toolsUsed),e.state._originalInput=u.originalInput,e.state._generatedItems=u.generatedItems,e.state._currentStep=u.nextStep,u.nextStep.type==="next_step_interruption")return;continue}if(e.state._currentStep.type==="next_step_run_again"){if(!e.state._currentAgentSpan){const A=r.map(I=>I.agentName);e.state._currentAgentSpan=ba({data:{name:s.name,handoffs:A,tools:a.map(I=>I.name),output_type:s.outputSchemaName}}),e.state._currentAgentSpan.start(),Ct(e.state._currentAgentSpan)}if(e.state._currentTurn++,e.state._currentTurn>e.state._maxTurns)throw e.state._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:e.state._maxTurns}}),new ca(`Max turns (${e.state._maxTurns}) exceeded`,e.state);R.debug(`Running agent ${s.name} (turn ${e.state._currentTurn})`);const u=s.model!==void 0&&s.model!==""||this.config.model!==void 0&&this.config.model!=="";let c=Fa(s.model,this.config.model);typeof c=="string"&&(c=await this.config.modelProvider.getModel(c)),e.state._currentTurn===1&&await this.#t(e.state);let l={...this.config.modelSettings,...s.modelSettings};const p=s.modelSettings;l=ja(u,p,c,l),l=Ca(s,e.state._toolUseTracker,l);const h=rn(e.input,e.newItems);e.state._noActiveAgentRun&&(s.emit("agent_start",e.state._context,s),this.emit("agent_start",e.state._context,s));let f;for await(const A of c.getStreamedResponse({systemInstructions:await s.getSystemPrompt(e.state._context),prompt:await s.getPrompt(e.state._context),input:h,previousResponseId:t.previousResponseId,conversationId:t.conversationId,modelSettings:l,tools:i,handoffs:o,outputType:pa(s.outputType),tracing:La(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:t.signal})){if(A.type==="response_done"){const I=co.parse(A);f={usage:new ht(I.response.usage),output:I.response.output,responseId:I.response.id}}if(e.cancelled)return;e._addItem(new kd(A))}if(e.state._noActiveAgentRun=!1,!f)throw new Te("Model did not produce a final response!",e.state);e.state._lastTurnResponse=f,e.state._modelResponses.push(e.state._lastTurnResponse);const _=ka(e.state._lastTurnResponse,s,a,r);e.state._lastProcessedResponse=_;const w=await Ra(s,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);Oa(e,w),e.state._toolUseTracker.addToolUse(s,_.toolsUsed),e.state._originalInput=w.originalInput,e.state._generatedItems=w.generatedItems,e.state._currentStep=w.nextStep}if(e.state._currentStep.type==="next_step_final_output"){await this.#n(e.state,e.state._currentStep.output),this.emit("agent_end",e.state._context,s,e.state._currentStep.output),s.emit("agent_end",e.state._context,e.state._currentStep.output);return}else{if(e.state._currentStep.type==="next_step_interruption")return;e.state._currentStep.type==="next_step_handoff"?(e.state._currentAgent=e.state._currentStep?.newAgent,e.state._currentAgentSpan&&(e.state._currentAgentSpan.end(),rt()),e.state._currentAgentSpan=void 0,e._addItem(new Ed(e.state._currentAgent)),e.state._noActiveAgentRun=!0,e.state._currentStep={type:"next_step_run_again"}):R.debug("Running next loop")}}}catch(s){throw e.state._currentAgentSpan&&e.state._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(s)}}),s}finally{e.state._currentAgentSpan&&(e.state._currentStep?.type!=="next_step_interruption"&&e.state._currentAgentSpan.end(),rt())}}async#i(e,t,s){return s=s??{},Ws(async()=>{const r=t instanceof nt?t:new nt(s.context instanceof It?s.context:new It(s.context),t,e,s.maxTurns??Ma),a=new Td({signal:s.signal,state:r});return a.maxTurns=s.maxTurns??r._maxTurns,this.#s(a,s).then(()=>{a._done()},i=>{a._raiseError(i)}),a})}run(e,t,s={stream:!1,context:void 0}){return t instanceof nt&&t._trace?Nl(t._trace,async()=>(t._currentAgentSpan&&Ct(t._currentAgentSpan),s?.stream?this.#i(e,t,s):this.#e(e,t,s))):Pl(async()=>s?.stream?this.#i(e,t,s):this.#e(e,t,s),{traceId:this.config.traceId,name:this.config.workflowName,groupId:this.config.groupId,metadata:this.config.traceMetadata})}}function Fa(n,e){return typeof n=="string"&&n!==qe.DEFAULT_MODEL_PLACEHOLDER||n?n:e??n??qe.DEFAULT_MODEL_PLACEHOLDER}function ja(n,e,t,s){return Qi()&&n&&(typeof t!="string"||!ns(t))&&(e.providerData?.reasoning||e.providerData?.text?.verbosity||e.providerData?.reasoning_effort)&&(delete s.providerData?.reasoning,delete s.providerData?.text?.verbosity,delete s.providerData?.reasoning_effort),s}const Vs=new WeakMap;function Zd(n,e){n&&Vs.set(n,e)}function qd(n){const e=Vs.get(n);return e&&Vs.delete(n),e}const Wd=g({input:d()});class qe extends Ql{static create(e){return new qe({...e,handoffs:e.handoffs,outputType:e.outputType,handoffOutputTypeWarningEnabled:!1})}static DEFAULT_MODEL_PLACEHOLDER="";name;instructions;prompt;handoffDescription;handoffs;model;modelSettings;tools;mcpServers;inputGuardrails;outputGuardrails;outputType="text";toolUseBehavior;resetToolChoice;constructor(e){if(super(),typeof e.name!="string"||e.name.trim()==="")throw new H("Agent must have a name.");if(this.name=e.name,this.instructions=e.instructions??qe.DEFAULT_MODEL_PLACEHOLDER,this.prompt=e.prompt,this.handoffDescription=e.handoffDescription??"",this.handoffs=e.handoffs??[],this.model=e.model??"",this.modelSettings=e.modelSettings??nd(),this.tools=e.tools??[],this.mcpServers=e.mcpServers??[],this.inputGuardrails=e.inputGuardrails??[],this.outputGuardrails=e.outputGuardrails??[],e.outputType&&(this.outputType=e.outputType),this.toolUseBehavior=e.toolUseBehavior??"run_llm_again",this.resetToolChoice=e.resetToolChoice??!0,e.model!==void 0&&Qi()&&(typeof e.model!="string"||!ns(e.model))&&e.modelSettings===void 0&&(this.modelSettings={}),(e.handoffOutputTypeWarningEnabled===void 0||e.handoffOutputTypeWarningEnabled)&&this.handoffs&&this.outputType){const t=new Set([JSON.stringify(this.outputType)]);for(const s of this.handoffs)"outputType"in s&&s.outputType?t.add(JSON.stringify(s.outputType)):"agent"in s&&s.agent.outputType&&t.add(JSON.stringify(s.agent.outputType));t.size>1&&R.warn(`[Agent] Warning: Handoff agents have different output types: ${Array.from(t).join(", ")}. You can make it type-safe by using Agent.create({ ... }) method instead.`)}}get outputSchemaName(){if(this.outputType==="text")return"text";if(ft(this.outputType))return"ZodOutput";if(typeof this.outputType=="object")return this.outputType.name;throw new Error(`Unknown output type: ${this.outputType}`)}clone(e){return new qe({...this,...e})}asTool(e){const{toolName:t,toolDescription:s,customOutputExtractor:r,needsApproval:a}=e;return qs({name:t??qn(this.name),description:s??"",parameters:Wd,strict:!0,needsApproval:a,execute:async(i,o,u)=>{if(!fl(i))throw new Te("Agent tool called with invalid input");const l=await new Jd().run(this,i.input,{context:o}),p=typeof r=="function"?await r(l):Id(l.rawResponses[l.rawResponses.length-1]);return u?.toolCall&&Zd(u.toolCall,l),p}})}async getSystemPrompt(e){return typeof this.instructions=="function"?await this.instructions(e,this):this.instructions}async getPrompt(e){return typeof this.prompt=="function"?await this.prompt(e,this):this.prompt}async getMcpTools(e){return this.mcpServers.length>0?Tl({mcpServers:this.mcpServers,runContext:e,agent:this,convertSchemasToStrict:!1}):[]}async getAllTools(e){return[...await this.getMcpTools(e),...this.tools]}processFinalOutput(e){if(this.outputType==="text")return e;if(typeof this.outputType=="object"){const t=JSON.parse(e);return ft(this.outputType)?this.outputType.parse(t):t}throw new Error(`Unknown output type: ${this.outputType}`)}toJSON(){return{name:this.name}}}Xl(Vi());function P(n,e,t,s,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}function m(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)}let bo=function(){const{crypto:n}=globalThis;if(n?.randomUUID)return bo=n.randomUUID.bind(n),n.randomUUID();const e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^t()&15>>+s/4).toString(16))};const Hd=/^[a-z][a-z0-9+.-]*:/i,zd=n=>Hd.test(n);let _e=n=>(_e=Array.isArray,_e(n)),Ua=_e;function xo(n){return typeof n!="object"?{}:n??{}}function Gd(n){if(!n)return!0;for(const e in n)return!1;return!0}function Vd(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function As(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}const Kd=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new D(`${n} must be an integer`);if(e<0)throw new D(`${n} must be a positive integer`);return e},Xd=n=>{try{return JSON.parse(n)}catch{return}},un=n=>new Promise(e=>setTimeout(e,n)),St="5.20.2",Yd=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Qd(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const ep=()=>{const n=Qd();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":St,"X-Stainless-OS":Ja(Deno.build.os),"X-Stainless-Arch":Ba(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":St,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":St,"X-Stainless-OS":Ja(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Ba(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=tp();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":St,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":St,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function tp(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const r=s[1]||0,a=s[2]||0,i=s[3]||0;return{browser:e,version:`${r}.${a}.${i}`}}}return null}const Ba=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Ja=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Za;const np=()=>Za??(Za=ep());function sp(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function So(...n){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function Ao(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return So({start(){},async pull(t){const{done:s,value:r}=await e.next();s?t.close():t.enqueue(r)},async cancel(){await e.return?.()}})}function To(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function rp(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}const e=n.getReader(),t=e.cancel();e.releaseLock(),await t}const ap=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),Io="RFC3986",ko=n=>String(n),qa={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:ko},ip="RFC1738";let Ks=(n,e)=>(Ks=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Ks(n,e));const Oe=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),Ts=1024,op=(n,e,t,s,r)=>{if(n.length===0)return n;let a=n;if(typeof n=="symbol"?a=Symbol.prototype.toString.call(n):typeof n!="string"&&(a=String(n)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=Ts){const u=a.length>=Ts?a.slice(o,o+Ts):a,c=[];for(let l=0;l<u.length;++l){let p=u.charCodeAt(l);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||r===ip&&(p===40||p===41)){c[c.length]=u.charAt(l);continue}if(p<128){c[c.length]=Oe[p];continue}if(p<2048){c[c.length]=Oe[192|p>>6]+Oe[128|p&63];continue}if(p<55296||p>=57344){c[c.length]=Oe[224|p>>12]+Oe[128|p>>6&63]+Oe[128|p&63];continue}l+=1,p=65536+((p&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Oe[240|p>>18]+Oe[128|p>>12&63]+Oe[128|p>>6&63]+Oe[128|p&63]}i+=c.join("")}return i};function up(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Wa(n,e){if(_e(n)){const t=[];for(let s=0;s<n.length;s+=1)t.push(e(n[s]));return t}return e(n)}const Co={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Eo=function(n,e){Array.prototype.push.apply(n,_e(e)?e:[e])};let Ha;const ae={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:op,encodeValuesOnly:!1,format:Io,formatter:ko,indices:!1,serializeDate(n){return(Ha??(Ha=Function.prototype.call.bind(Date.prototype.toISOString)))(n)},skipNulls:!1,strictNullHandling:!1};function cp(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const Is={};function Ro(n,e,t,s,r,a,i,o,u,c,l,p,h,f,_,w,A,I){let S=n,U=I,q=0,Y=!1;for(;(U=U.get(Is))!==void 0&&!Y;){const K=U.get(n);if(q+=1,typeof K<"u"){if(K===q)throw new RangeError("Cyclic object value");Y=!0}typeof U.get(Is)>"u"&&(q=0)}if(typeof c=="function"?S=c(e,S):S instanceof Date?S=h?.(S):t==="comma"&&_e(S)&&(S=Wa(S,function(K){return K instanceof Date?h?.(K):K})),S===null){if(a)return u&&!w?u(e,ae.encoder,A,"key",f):e;S=""}if(cp(S)||up(S)){if(u){const K=w?e:u(e,ae.encoder,A,"key",f);return[_?.(K)+"="+_?.(u(S,ae.encoder,A,"value",f))]}return[_?.(e)+"="+_?.(String(S))]}const pe=[];if(typeof S>"u")return pe;let G;if(t==="comma"&&_e(S))w&&u&&(S=Wa(S,u)),G=[{value:S.length>0?S.join(",")||null:void 0}];else if(_e(c))G=c;else{const K=Object.keys(S);G=l?K.sort(l):K}const ne=o?String(e).replace(/\./g,"%2E"):String(e),X=s&&_e(S)&&S.length===1?ne+"[]":ne;if(r&&_e(S)&&S.length===0)return X+"[]";for(let K=0;K<G.length;++K){const se=G[K],Vr=typeof se=="object"&&typeof se.value<"u"?se.value:S[se];if(i&&Vr===null)continue;const ps=p&&o?se.replace(/\./g,"%2E"):se,Lu=_e(S)?typeof t=="function"?t(X,ps):X:X+(p?"."+ps:"["+ps+"]");I.set(n,q);const Kr=new WeakMap;Kr.set(Is,I),Eo(pe,Ro(Vr,Lu,t,s,r,a,i,o,t==="comma"&&w&&_e(S)?null:u,c,l,p,h,f,_,w,A,Kr))}return pe}function lp(n=ae){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||ae.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Io;if(typeof n.format<"u"){if(!Ks(qa,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const s=qa[t];let r=ae.filter;(typeof n.filter=="function"||_e(n.filter))&&(r=n.filter);let a;if(n.arrayFormat&&n.arrayFormat in Co?a=n.arrayFormat:"indices"in n?a=n.indices?"indices":"repeat":a=ae.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:ae.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:ae.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:ae.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:ae.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?ae.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:ae.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:ae.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:ae.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:ae.encodeValuesOnly,filter:r,format:t,formatter:s,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:ae.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:ae.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:ae.strictNullHandling}}function dp(n,e={}){let t=n;const s=lp(e);let r,a;typeof s.filter=="function"?(a=s.filter,t=a("",t)):_e(s.filter)&&(a=s.filter,r=a);const i=[];if(typeof t!="object"||t===null)return"";const o=Co[s.arrayFormat],u=o==="comma"&&s.commaRoundTrip;r||(r=Object.keys(t)),s.sort&&r.sort(s.sort);const c=new WeakMap;for(let h=0;h<r.length;++h){const f=r[h];s.skipNulls&&t[f]===null||Eo(i,Ro(t[f],f,o,u,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,c))}const l=i.join(s.delimiter);let p=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),l.length>0?p+l:""}function pp(n){let e=0;for(const r of n)e+=r.length;const t=new Uint8Array(e);let s=0;for(const r of n)t.set(r,s),s+=r.length;return t}let za;function Ir(n){let e;return(za??(e=new globalThis.TextEncoder,za=e.encode.bind(e)))(n)}let Ga;function Va(n){let e;return(Ga??(e=new globalThis.TextDecoder,Ga=e.decode.bind(e)))(n)}var ge,ye;class as{constructor(){ge.set(this,void 0),ye.set(this,void 0),P(this,ge,new Uint8Array),P(this,ye,null)}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Ir(e):e;P(this,ge,pp([m(this,ge,"f"),t]));const s=[];let r;for(;(r=fp(m(this,ge,"f"),m(this,ye,"f")))!=null;){if(r.carriage&&m(this,ye,"f")==null){P(this,ye,r.index);continue}if(m(this,ye,"f")!=null&&(r.index!==m(this,ye,"f")+1||r.carriage)){s.push(Va(m(this,ge,"f").subarray(0,m(this,ye,"f")-1))),P(this,ge,m(this,ge,"f").subarray(m(this,ye,"f"))),P(this,ye,null);continue}const a=m(this,ye,"f")!==null?r.preceding-1:r.preceding,i=Va(m(this,ge,"f").subarray(0,a));s.push(i),P(this,ge,m(this,ge,"f").subarray(r.index)),P(this,ye,null)}return s}flush(){return m(this,ge,"f").length?this.decode(`
`):[]}}ge=new WeakMap,ye=new WeakMap;as.NEWLINE_CHARS=new Set([`
`,"\r"]);as.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function fp(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function hp(n){for(let s=0;s<n.length-1;s++){if(n[s]===10&&n[s+1]===10||n[s]===13&&n[s+1]===13)return s+2;if(n[s]===13&&n[s+1]===10&&s+3<n.length&&n[s+2]===13&&n[s+3]===10)return s+4}return-1}const zn={off:0,error:200,warn:300,info:400,debug:500},Ka=(n,e,t)=>{if(n){if(Vd(zn,n))return n;ce(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(zn))}`)}};function jt(){}function fn(n,e,t){return!e||zn[n]>zn[t]?jt:e[n].bind(e)}const mp={error:jt,warn:jt,info:jt,debug:jt};let Xa=new WeakMap;function ce(n){const e=n.logger,t=n.logLevel??"off";if(!e)return mp;const s=Xa.get(e);if(s&&s[0]===t)return s[1];const r={error:fn("error",e,t),warn:fn("warn",e,t),info:fn("info",e,t),debug:fn("debug",e,t)};return Xa.set(e,[t,r]),r}const tt=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var Mt;class Pe{constructor(e,t,s){this.iterator=e,Mt.set(this,void 0),this.controller=t,P(this,Mt,s)}static fromSSEResponse(e,t,s){let r=!1;const a=s?ce(s):console;async function*i(){if(r)throw new D("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const u of _p(e,t))if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null||!u.event.startsWith("thread.")){let c;try{c=JSON.parse(u.data)}catch(l){throw a.error("Could not parse message into JSON:",u.data),a.error("From chunk:",u.raw),l}if(c&&c.error)throw new de(void 0,c.error,void 0,e.headers);yield c}else{let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(u.event=="error")throw new de(void 0,c.error,c.message,void 0);yield{event:u.event,data:c}}}o=!0}catch(u){if(Ds(u))return;throw u}finally{o||t.abort()}}return new Pe(i,t,s)}static fromReadableStream(e,t,s){let r=!1;async function*a(){const o=new as,u=To(e);for await(const c of u)for(const l of o.decode(c))yield l;for(const c of o.flush())yield c}async function*i(){if(r)throw new D("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const u of a())o||u&&(yield JSON.parse(u));o=!0}catch(u){if(Ds(u))return;throw u}finally{o||t.abort()}}return new Pe(i,t,s)}[(Mt=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=s.next();e.push(i),t.push(i)}return a.shift()}});return[new Pe(()=>r(e),this.controller,m(this,Mt,"f")),new Pe(()=>r(t),this.controller,m(this,Mt,"f"))]}toReadableStream(){const e=this;let t;return So({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:r,done:a}=await t.next();if(a)return s.close();const i=Ir(JSON.stringify(r)+`
`);s.enqueue(i)}catch(r){s.error(r)}},async cancel(){await t.return?.()}})}}async function*_p(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new D("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new D("Attempted to iterate over a response with no body");const t=new yp,s=new as,r=To(n.body);for await(const a of gp(r))for(const i of s.decode(a)){const o=t.decode(i);o&&(yield o)}for(const a of s.flush()){const i=t.decode(a);i&&(yield i)}}async function*gp(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Ir(t):t;let r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let a;for(;(a=hp(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class yp{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,r]=vp(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}}function vp(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function Oo(n,e){const{response:t,requestLogID:s,retryOfRequestLogID:r,startTime:a}=e,i=await(async()=>{if(e.options.stream)return ce(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,n):Pe.fromSSEResponse(t,e.controller,n);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const u=t.headers.get("content-type")?.split(";")[0]?.trim();if(u?.includes("application/json")||u?.endsWith("+json")){const p=await t.json();return Do(p,t)}return await t.text()})();return ce(n).debug(`[${s}] response parsed`,tt({retryOfRequestLogID:r,url:t.url,status:t.status,body:i,durationMs:Date.now()-a})),i}function Do(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Ut;class is extends Promise{constructor(e,t,s=Oo){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=s,Ut.set(this,void 0),P(this,Ut,e)}_thenUnwrap(e){return new is(m(this,Ut,"f"),this.responsePromise,async(t,s)=>Do(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(m(this,Ut,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Ut=new WeakMap;var hn;class kr{constructor(e,t,s,r){hn.set(this,void 0),P(this,hn,e),this.options=r,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new D("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await m(this,hn,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(hn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class wp extends is{constructor(e,t,s){super(e,t,async(r,a)=>new s(r,a.response,await Oo(r,a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}class os extends kr{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class te extends kr{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...xo(this.options.query),after:t}}:null}}class bp extends kr{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...xo(this.options.query),after:e}}:null}}const No=()=>{if(typeof File>"u"){const{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function zt(n,e,t){return No(),new File(n,e??"unknown_file",t)}function xn(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}const Po=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",mt=async(n,e)=>({...n,body:await Sp(n.body,e)}),Ya=new WeakMap;function xp(n){const e=typeof n=="function"?n:n.fetch,t=Ya.get(e);if(t)return t;const s=(async()=>{try{const r="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new r(a).text()}catch{return!0}})();return Ya.set(e,s),s}const Sp=async(n,e)=>{if(!await xp(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(n||{}).map(([s,r])=>Xs(t,s,r))),t},Ap=n=>n instanceof Blob&&"name"in n,Xs=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response)n.append(e,zt([await t.blob()],xn(t)));else if(Po(t))n.append(e,zt([await new Response(Ao(t)).blob()],xn(t)));else if(Ap(t))n.append(e,t,xn(t));else if(Array.isArray(t))await Promise.all(t.map(s=>Xs(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,r])=>Xs(n,`${e}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},$o=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Tp=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&$o(n),Ip=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function kp(n,e,t){if(No(),n=await n,Tp(n))return n instanceof File?n:zt([await n.arrayBuffer()],n.name);if(Ip(n)){const r=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),zt(await Ys(r),e,t)}const s=await Ys(n);if(e||(e=xn(n)),!t?.type){const r=s.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof r=="string"&&(t={...t,type:r})}return zt(s,e,t)}async function Ys(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if($o(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(Po(n))for await(const t of n)e.push(...await Ys(t));else{const t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${Cp(n)}`)}return e}function Cp(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}class N{constructor(e){this._client=e}}function Mo(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Qa=Object.freeze(Object.create(null)),Ep=(n=Mo)=>function(t,...s){if(t.length===1)return t[0];let r=!1;const a=[],i=t.reduce((l,p,h)=>{/[?#]/.test(p)&&(r=!0);const f=s[h];let _=(r?encodeURIComponent:n)(""+f);return h!==s.length&&(f==null||typeof f=="object"&&f.toString===Object.getPrototypeOf(Object.getPrototypeOf(f.hasOwnProperty??Qa)??Qa)?.toString)&&(_=f+"",a.push({start:l.length+p.length,length:_.length,error:`Value of type ${Object.prototype.toString.call(f).slice(8,-1)} is not a valid path parameter`})),l+p+(h===s.length?"":_)},""),o=i.split(/[?#]/,1)[0],u=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let c;for(;(c=u.exec(o))!==null;)a.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(a.sort((l,p)=>l.start-p.start),a.length>0){let l=0;const p=a.reduce((h,f)=>{const _=" ".repeat(f.start-l),w="^".repeat(f.length);return l=f.start+f.length,h+_+w},"");throw new D(`Path parameters result in path with invalid segments:
${a.map(h=>h.error).join(`
`)}
${i}
${p}`)}return i},x=Ep(Mo);let Lo=class extends N{list(e,t={},s){return this._client.getAPIList(x`/chat/completions/${e}/messages`,te,{query:t,...s})}};const Gn=n=>n?.role==="assistant",Fo=n=>n?.role==="tool";var Qs,Sn,An,Bt,Jt,Tn,Zt,Be,qt,Vn,Kn,At,jo;class Cr{constructor(){Qs.add(this),this.controller=new AbortController,Sn.set(this,void 0),An.set(this,()=>{}),Bt.set(this,()=>{}),Jt.set(this,void 0),Tn.set(this,()=>{}),Zt.set(this,()=>{}),Be.set(this,{}),qt.set(this,!1),Vn.set(this,!1),Kn.set(this,!1),At.set(this,!1),P(this,Sn,new Promise((e,t)=>{P(this,An,e,"f"),P(this,Bt,t,"f")})),P(this,Jt,new Promise((e,t)=>{P(this,Tn,e,"f"),P(this,Zt,t,"f")})),m(this,Sn,"f").catch(()=>{}),m(this,Jt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},m(this,Qs,"m",jo).bind(this))},0)}_connected(){this.ended||(m(this,An,"f").call(this),this._emit("connect"))}get ended(){return m(this,qt,"f")}get errored(){return m(this,Vn,"f")}get aborted(){return m(this,Kn,"f")}abort(){this.controller.abort()}on(e,t){return(m(this,Be,"f")[e]||(m(this,Be,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=m(this,Be,"f")[e];if(!s)return this;const r=s.findIndex(a=>a.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(m(this,Be,"f")[e]||(m(this,Be,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{P(this,At,!0),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){P(this,At,!0),await m(this,Jt,"f")}_emit(e,...t){if(m(this,qt,"f"))return;e==="end"&&(P(this,qt,!0),m(this,Tn,"f").call(this));const s=m(this,Be,"f")[e];if(s&&(m(this,Be,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!m(this,At,"f")&&!s?.length&&Promise.reject(r),m(this,Bt,"f").call(this,r),m(this,Zt,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!m(this,At,"f")&&!s?.length&&Promise.reject(r),m(this,Bt,"f").call(this,r),m(this,Zt,"f").call(this,r),this._emit("end")}}_emitFinal(){}}Sn=new WeakMap,An=new WeakMap,Bt=new WeakMap,Jt=new WeakMap,Tn=new WeakMap,Zt=new WeakMap,Be=new WeakMap,qt=new WeakMap,Vn=new WeakMap,Kn=new WeakMap,At=new WeakMap,Qs=new WeakSet,jo=function(e){if(P(this,Vn,!0),e instanceof Error&&e.name==="AbortError"&&(e=new Ae),e instanceof Ae)return P(this,Kn,!0),this._emit("abort",e);if(e instanceof D)return this._emit("error",e);if(e instanceof Error){const t=new D(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new D(String(e)))};function Rp(n){return typeof n.parse=="function"}var fe,er,Xn,tr,nr,sr,Uo,Bo;const Op=10;class Jo extends Cr{constructor(){super(...arguments),fe.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),Fo(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Gn(e)&&e.tool_calls)for(const s of e.tool_calls)s.type==="function"&&this._emit("functionToolCall",s.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new D("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),m(this,fe,"m",er).call(this)}async finalMessage(){return await this.done(),m(this,fe,"m",Xn).call(this)}async finalFunctionToolCall(){return await this.done(),m(this,fe,"m",tr).call(this)}async finalFunctionToolCallResult(){return await this.done(),m(this,fe,"m",nr).call(this)}async totalUsage(){return await this.done(),m(this,fe,"m",sr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=m(this,fe,"m",Xn).call(this);t&&this._emit("finalMessage",t);const s=m(this,fe,"m",er).call(this);s&&this._emit("finalContent",s);const r=m(this,fe,"m",tr).call(this);r&&this._emit("finalFunctionToolCall",r);const a=m(this,fe,"m",nr).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",m(this,fe,"m",sr).call(this))}async _createChatCompletion(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),m(this,fe,"m",Uo).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(dr(a,t))}async _runChatCompletion(e,t,s){for(const r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){const r="tool",{tool_choice:a="auto",stream:i,...o}=t,u=typeof a!="string"&&a.type==="function"&&a?.function?.name,{maxChatCompletions:c=Op}=s||{},l=t.tools.map(f=>{if(on(f)){if(!f.$callback)throw new D("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:f.$callback,name:f.function.name,description:f.function.description||"",parameters:f.function.parameters,parse:f.$parseRaw,strict:!0}}}return f}),p={};for(const f of l)f.type==="function"&&(p[f.function.name||f.function.function.name]=f.function);const h="tools"in t?l.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description,strict:f.function.strict}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){const w=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:h,messages:[...this.messages]},s)).choices[0]?.message;if(!w)throw new D("missing message in ChatCompletion response");if(!w.tool_calls?.length)return;for(const A of w.tool_calls){if(A.type!=="function")continue;const I=A.id,{name:S,arguments:U}=A.function,q=p[S];if(q){if(u&&u!==S){const ne=`Invalid tool_call: ${JSON.stringify(S)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:r,tool_call_id:I,content:ne});continue}}else{const ne=`Invalid tool_call: ${JSON.stringify(S)}. Available options are: ${Object.keys(p).map(X=>JSON.stringify(X)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:I,content:ne});continue}let Y;try{Y=Rp(q)?await q.parse(U):U}catch(ne){const X=ne instanceof Error?ne.message:String(ne);this._addMessage({role:r,tool_call_id:I,content:X});continue}const pe=await q.function(Y,this),G=m(this,fe,"m",Bo).call(this,pe);if(this._addMessage({role:r,tool_call_id:I,content:G}),u)return}}}}fe=new WeakSet,er=function(){return m(this,fe,"m",Xn).call(this).content??null},Xn=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Gn(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new D("stream ended without producing a ChatCompletionMessage with role=assistant")},tr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Gn(t)&&t?.tool_calls?.length)return t.tool_calls.filter(s=>s.type==="function").at(-1)?.function}},nr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Fo(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(s=>s.role==="assistant"&&s.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},sr=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Uo=function(e){if(e.n!=null&&e.n>1)throw new D("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Bo=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Er extends Jo{static runTools(e,t,s){const r=new Er,a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,a)),r}_addMessage(e,t=!0){super._addMessage(e,t),Gn(e)&&e.content&&this._emit("content",e.content)}}const Zo=1,qo=2,Wo=4,Ho=8,zo=16,Go=32,Vo=64,Ko=128,Xo=256,Yo=Ko|Xo,Qo=zo|Go|Yo|Vo,eu=Zo|qo|Qo,tu=Wo|Ho,Dp=eu|tu,oe={STR:Zo,NUM:qo,ARR:Wo,OBJ:Ho,NULL:zo,BOOL:Go,NAN:Vo,INFINITY:Ko,MINUS_INFINITY:Xo,INF:Yo,SPECIAL:Qo,ATOM:eu,COLLECTION:tu,ALL:Dp};class Np extends Error{}class Pp extends Error{}function $p(n,e=oe.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return Mp(n.trim(),e)}const Mp=(n,e)=>{const t=n.length;let s=0;const r=h=>{throw new Np(`${h} at position ${s}`)},a=h=>{throw new Pp(`${h} at position ${s}`)},i=()=>(p(),s>=t&&r("Unexpected end of input"),n[s]==='"'?o():n[s]==="{"?u():n[s]==="["?c():n.substring(s,s+4)==="null"||oe.NULL&e&&t-s<4&&"null".startsWith(n.substring(s))?(s+=4,null):n.substring(s,s+4)==="true"||oe.BOOL&e&&t-s<4&&"true".startsWith(n.substring(s))?(s+=4,!0):n.substring(s,s+5)==="false"||oe.BOOL&e&&t-s<5&&"false".startsWith(n.substring(s))?(s+=5,!1):n.substring(s,s+8)==="Infinity"||oe.INFINITY&e&&t-s<8&&"Infinity".startsWith(n.substring(s))?(s+=8,1/0):n.substring(s,s+9)==="-Infinity"||oe.MINUS_INFINITY&e&&1<t-s&&t-s<9&&"-Infinity".startsWith(n.substring(s))?(s+=9,-1/0):n.substring(s,s+3)==="NaN"||oe.NAN&e&&t-s<3&&"NaN".startsWith(n.substring(s))?(s+=3,NaN):l()),o=()=>{const h=s;let f=!1;for(s++;s<t&&(n[s]!=='"'||f&&n[s-1]==="\\");)f=n[s]==="\\"?!f:!1,s++;if(n.charAt(s)=='"')try{return JSON.parse(n.substring(h,++s-Number(f)))}catch(_){a(String(_))}else if(oe.STR&e)try{return JSON.parse(n.substring(h,s-Number(f))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},u=()=>{s++,p();const h={};try{for(;n[s]!=="}";){if(p(),s>=t&&oe.OBJ&e)return h;const f=o();p(),s++;try{const _=i();Object.defineProperty(h,f,{value:_,writable:!0,enumerable:!0,configurable:!0})}catch(_){if(oe.OBJ&e)return h;throw _}p(),n[s]===","&&s++}}catch{if(oe.OBJ&e)return h;r("Expected '}' at end of object")}return s++,h},c=()=>{s++;const h=[];try{for(;n[s]!=="]";)h.push(i()),p(),n[s]===","&&s++}catch{if(oe.ARR&e)return h;r("Expected ']' at end of array")}return s++,h},l=()=>{if(s===0){n==="-"&&oe.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n)}catch(f){if(oe.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}a(String(f))}}const h=s;for(n[s]==="-"&&s++;n[s]&&!",]}".includes(n[s]);)s++;s==t&&!(oe.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(n.substring(h,s))}catch{n.substring(h,s)==="-"&&oe.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(_){a(String(_))}}},p=()=>{for(;s<t&&` 
\r	`.includes(n[s]);)s++};return i()},ei=n=>$p(n,oe.ALL^oe.NUM);var re,Fe,vt,ze,ks,mn,Cs,Es,Rs,_n,Os,ti;class an extends Jo{constructor(e){super(),re.add(this),Fe.set(this,void 0),vt.set(this,void 0),ze.set(this,void 0),P(this,Fe,e),P(this,vt,[])}get currentChatCompletionSnapshot(){return m(this,ze,"f")}static fromReadableStream(e){const t=new an(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const r=new an(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,s){super._createChatCompletion;const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),m(this,re,"m",ks).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const i of a)m(this,re,"m",Cs).call(this,i);if(a.controller.signal?.aborted)throw new Ae;return this._addChatCompletion(m(this,re,"m",_n).call(this))}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),m(this,re,"m",ks).call(this),this._connected();const r=Pe.fromReadableStream(e,this.controller);let a;for await(const i of r)a&&a!==i.id&&this._addChatCompletion(m(this,re,"m",_n).call(this)),m(this,re,"m",Cs).call(this,i),a=i.id;if(r.controller.signal?.aborted)throw new Ae;return this._addChatCompletion(m(this,re,"m",_n).call(this))}[(Fe=new WeakMap,vt=new WeakMap,ze=new WeakMap,re=new WeakSet,ks=function(){this.ended||P(this,ze,void 0)},mn=function(t){let s=m(this,vt,"f")[t.index];return s||(s={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},m(this,vt,"f")[t.index]=s,s)},Cs=function(t){if(this.ended)return;const s=m(this,re,"m",ti).call(this,t);this._emit("chunk",t,s);for(const r of t.choices){const a=s.choices[r.index];r.delta.content!=null&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",r.delta.content,a.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),r.delta.refusal!=null&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:a.message.refusal}),r.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:a.logprobs?.content??[]}),r.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});const i=m(this,re,"m",mn).call(this,a);a.finish_reason&&(m(this,re,"m",Rs).call(this,a),i.current_tool_call_index!=null&&m(this,re,"m",Es).call(this,a,i.current_tool_call_index));for(const o of r.delta.tool_calls??[])i.current_tool_call_index!==o.index&&(m(this,re,"m",Rs).call(this,a),i.current_tool_call_index!=null&&m(this,re,"m",Es).call(this,a,i.current_tool_call_index)),i.current_tool_call_index=o.index;for(const o of r.delta.tool_calls??[]){const u=a.message.tool_calls?.[o.index];u?.type&&(u?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:u.function?.name,index:o.index,arguments:u.function.arguments,parsed_arguments:u.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(u?.type,void 0))}}},Es=function(t,s){if(m(this,re,"m",mn).call(this,t).done_tool_calls.has(s))return;const a=t.message.tool_calls?.[s];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const i=m(this,Fe,"f")?.tools?.find(o=>On(o)&&o.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:s,arguments:a.function.arguments,parsed_arguments:on(i)?i.$parseRaw(a.function.arguments):i?.function.strict?JSON.parse(a.function.arguments):null})}else a.type},Rs=function(t){const s=m(this,re,"m",mn).call(this,t);if(t.message.content&&!s.content_done){s.content_done=!0;const r=m(this,re,"m",Os).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!s.refusal_done&&(s.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!s.logprobs_content_done&&(s.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!s.logprobs_refusal_done&&(s.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},_n=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");const t=m(this,ze,"f");if(!t)throw new D("request ended without sending any chunks");return P(this,ze,void 0),P(this,vt,[]),Lp(t,m(this,Fe,"f"))},Os=function(){const t=m(this,Fe,"f")?.response_format;return lr(t)?t:null},ti=function(t){var s,r,a,i;let o=m(this,ze,"f");const{choices:u,...c}=t;o?Object.assign(o,c):o=P(this,ze,{...c,choices:[]});for(const{delta:l,finish_reason:p,index:h,logprobs:f=null,..._}of t.choices){let w=o.choices[h];if(w||(w=o.choices[h]={finish_reason:p,index:h,message:{},logprobs:f,..._}),f)if(!w.logprobs)w.logprobs=Object.assign({},f);else{const{content:pe,refusal:G,...ne}=f;Object.assign(w.logprobs,ne),pe&&((s=w.logprobs).content??(s.content=[]),w.logprobs.content.push(...pe)),G&&((r=w.logprobs).refusal??(r.refusal=[]),w.logprobs.refusal.push(...G))}if(p&&(w.finish_reason=p,m(this,Fe,"f")&&Ri(m(this,Fe,"f")))){if(p==="length")throw new Ci;if(p==="content_filter")throw new Ei}if(Object.assign(w,_),!l)continue;const{content:A,refusal:I,function_call:S,role:U,tool_calls:q,...Y}=l;if(Object.assign(w.message,Y),I&&(w.message.refusal=(w.message.refusal||"")+I),U&&(w.message.role=U),S&&(w.message.function_call?(S.name&&(w.message.function_call.name=S.name),S.arguments&&((a=w.message.function_call).arguments??(a.arguments=""),w.message.function_call.arguments+=S.arguments)):w.message.function_call=S),A&&(w.message.content=(w.message.content||"")+A,!w.message.refusal&&m(this,re,"m",Os).call(this)&&(w.message.parsed=ei(w.message.content))),q){w.message.tool_calls||(w.message.tool_calls=[]);for(const{index:pe,id:G,type:ne,function:X,...K}of q){const se=(i=w.message.tool_calls)[pe]??(i[pe]={});Object.assign(se,K),G&&(se.id=G),ne&&(se.type=ne),X&&(se.function??(se.function={name:X.name??"",arguments:""})),X?.name&&(se.function.name=X.name),X?.arguments&&(se.function.arguments+=X.arguments,Ju(m(this,Fe,"f"),se)&&(se.function.parsed_arguments=ei(se.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Pe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Lp(n,e){const{id:t,choices:s,created:r,model:a,system_fingerprint:i,...o}=n,u={...o,id:t,choices:s.map(({message:c,finish_reason:l,index:p,logprobs:h,...f})=>{if(!l)throw new D(`missing finish_reason for choice ${p}`);const{content:_=null,function_call:w,tool_calls:A,...I}=c,S=c.role;if(!S)throw new D(`missing role for choice ${p}`);if(w){const{arguments:U,name:q}=w;if(U==null)throw new D(`missing function_call.arguments for choice ${p}`);if(!q)throw new D(`missing function_call.name for choice ${p}`);return{...f,message:{content:_,function_call:{arguments:U,name:q},role:S,refusal:c.refusal??null},finish_reason:l,index:p,logprobs:h}}return A?{...f,index:p,finish_reason:l,logprobs:h,message:{...I,role:S,content:_,refusal:c.refusal??null,tool_calls:A.map((U,q)=>{const{function:Y,type:pe,id:G,...ne}=U,{arguments:X,name:K,...se}=Y||{};if(G==null)throw new D(`missing choices[${p}].tool_calls[${q}].id
${gn(n)}`);if(pe==null)throw new D(`missing choices[${p}].tool_calls[${q}].type
${gn(n)}`);if(K==null)throw new D(`missing choices[${p}].tool_calls[${q}].function.name
${gn(n)}`);if(X==null)throw new D(`missing choices[${p}].tool_calls[${q}].function.arguments
${gn(n)}`);return{...ne,id:G,type:pe,function:{...se,name:K,arguments:X}}})}}:{...f,message:{...I,content:_,role:S,refusal:c.refusal??null},finish_reason:l,index:p,logprobs:h}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return ju(u,e)}function gn(n){return JSON.stringify(n)}class Yn extends an{static fromReadableStream(e){const t=new Yn(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){const r=new Yn(t),a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,a)),r}}let Rr=class extends N{constructor(){super(...arguments),this.messages=new Lo(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(x`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(x`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",te,{query:e,...t})}delete(e,t){return this._client.delete(x`/chat/completions/${e}`,t)}parse(e,t){return Zu(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(s=>dr(s,e))}runTools(e,t){return e.stream?Yn.runTools(this._client,e,t):Er.runTools(this._client,e,t)}stream(e,t){return an.createChatCompletion(this._client,e,t)}};Rr.Messages=Lo;class Or extends N{constructor(){super(...arguments),this.completions=new Rr(this._client)}}Or.Completions=Rr;const nu=Symbol("brand.privateNullableHeaders");function*Fp(n){if(!n)return;if(nu in n){const{values:s,nulls:r}=n;yield*s.entries();for(const a of r)yield[a,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Ua(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let s of t){const r=s[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");const a=Ua(s[1])?s[1]:[s[1]];let i=!1;for(const o of a)o!==void 0&&(e&&!i&&(i=!0,yield[r,null]),yield[r,o])}}const O=n=>{const e=new Headers,t=new Set;for(const s of n){const r=new Set;for(const[a,i]of Fp(s)){const o=a.toLowerCase();r.has(o)||(e.delete(a),r.add(o)),i===null?(e.delete(a),t.add(o)):(e.append(a,i),t.delete(o))}}return{[nu]:!0,values:e,nulls:t}};class su extends N{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:O([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class ru extends N{create(e,t){return this._client.post("/audio/transcriptions",mt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class au extends N{create(e,t){return this._client.post("/audio/translations",mt({body:e,...t,__metadata:{model:e.model}},this._client))}}class cn extends N{constructor(){super(...arguments),this.transcriptions=new ru(this._client),this.translations=new au(this._client),this.speech=new su(this._client)}}cn.Transcriptions=ru;cn.Translations=au;cn.Speech=su;class iu extends N{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(x`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",te,{query:e,...t})}cancel(e,t){return this._client.post(x`/batches/${e}/cancel`,t)}}class ou extends N{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(x`/assistants/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(x`/assistants/${e}`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",te,{query:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(x`/assistants/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class uu extends N{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class cu extends N{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}let us=class extends N{constructor(){super(...arguments),this.sessions=new uu(this._client),this.transcriptionSessions=new cu(this._client)}};us.Sessions=uu;us.TranscriptionSessions=cu;class lu extends N{create(e,t,s){return this._client.post(x`/threads/${e}/messages`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{thread_id:r}=t;return this._client.get(x`/threads/${r}/messages/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:r,...a}=t;return this._client.post(x`/threads/${r}/messages/${e}`,{body:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(x`/threads/${e}/messages`,te,{query:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{thread_id:r}=t;return this._client.delete(x`/threads/${r}/messages/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class du extends N{retrieve(e,t,s){const{thread_id:r,run_id:a,...i}=t;return this._client.get(x`/threads/${r}/runs/${a}/steps/${e}`,{query:i,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t,s){const{thread_id:r,...a}=t;return this._client.getAPIList(x`/threads/${r}/runs/${e}/steps`,te,{query:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}const jp=n=>{if(typeof Buffer<"u"){const e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),t=e.length,s=new Uint8Array(t);for(let r=0;r<t;r++)s[r]=e.charCodeAt(r);return Array.from(new Float32Array(s.buffer))}};var Up={};const wt=n=>{if(typeof globalThis.process<"u")return Up?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var le,at,rr,Ne,In,Re,it,kt,st,Qn,ve,kn,Cn,Gt,Wt,Ht,ni,si,ri,ai,ii,oi,ui;class Vt extends Cr{constructor(){super(...arguments),le.add(this),rr.set(this,[]),Ne.set(this,{}),In.set(this,{}),Re.set(this,void 0),it.set(this,void 0),kt.set(this,void 0),st.set(this,void 0),Qn.set(this,void 0),ve.set(this,void 0),kn.set(this,void 0),Cn.set(this,void 0),Gt.set(this,void 0)}[(rr=new WeakMap,Ne=new WeakMap,In=new WeakMap,Re=new WeakMap,it=new WeakMap,kt=new WeakMap,st=new WeakMap,Qn=new WeakMap,ve=new WeakMap,kn=new WeakMap,Cn=new WeakMap,Gt=new WeakMap,le=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new at;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=Pe.fromReadableStream(e,this.controller);for await(const a of r)m(this,le,"m",Wt).call(this,a);if(r.controller.signal?.aborted)throw new Ae;return this._addRun(m(this,le,"m",Ht).call(this))}toReadableStream(){return new Pe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,r){const a=new at;return a._run(()=>a._runToolAssistantStream(e,t,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.submitToolOutputs(t,i,{...r,signal:this.controller.signal});this._connected();for await(const u of o)m(this,le,"m",Wt).call(this,u);if(o.controller.signal?.aborted)throw new Ae;return this._addRun(m(this,le,"m",Ht).call(this))}static createThreadAssistantStream(e,t,s){const r=new at;return r._run(()=>r._threadAssistantStream(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,s,r){const a=new at;return a._run(()=>a._runAssistantStream(e,t,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return m(this,kn,"f")}currentRun(){return m(this,Cn,"f")}currentMessageSnapshot(){return m(this,Re,"f")}currentRunStepSnapshot(){return m(this,Gt,"f")}async finalRunSteps(){return await this.done(),Object.values(m(this,Ne,"f"))}async finalMessages(){return await this.done(),Object.values(m(this,In,"f"))}async finalRun(){if(await this.done(),!m(this,it,"f"))throw Error("Final run was not received.");return m(this,it,"f")}async _createThreadAssistantStream(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},i=await e.createAndRun(a,{...s,signal:this.controller.signal});this._connected();for await(const o of i)m(this,le,"m",Wt).call(this,o);if(i.controller.signal?.aborted)throw new Ae;return this._addRun(m(this,le,"m",Ht).call(this))}async _createAssistantStream(e,t,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.create(t,i,{...r,signal:this.controller.signal});this._connected();for await(const u of o)m(this,le,"m",Wt).call(this,u);if(o.controller.signal?.aborted)throw new Ae;return this._addRun(m(this,le,"m",Ht).call(this))}static accumulateDelta(e,t){for(const[s,r]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=r;continue}let a=e[s];if(a==null){e[s]=r;continue}if(s==="index"||s==="type"){e[s]=r;continue}if(typeof a=="string"&&typeof r=="string")a+=r;else if(typeof a=="number"&&typeof r=="number")a+=r;else if(As(a)&&As(r))a=this.accumulateDelta(a,r);else if(Array.isArray(a)&&Array.isArray(r)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...r);continue}for(const i of r){if(!As(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const u=a[o];u==null?a.push(i):a[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${r}, accValue: ${a}`);e[s]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,r){return await this._createAssistantStream(t,e,s,r)}async _runToolAssistantStream(e,t,s,r){return await this._createToolAssistantStream(t,e,s,r)}}at=Vt,Wt=function(e){if(!this.ended)switch(P(this,kn,e),m(this,le,"m",ri).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":m(this,le,"m",ui).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":m(this,le,"m",si).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":m(this,le,"m",ni).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Ht=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");if(!m(this,it,"f"))throw Error("Final run has not been received");return m(this,it,"f")},ni=function(e){const[t,s]=m(this,le,"m",ii).call(this,e,m(this,Re,"f"));P(this,Re,t),m(this,In,"f")[t.id]=t;for(const r of s){const a=t.content[r.index];a?.type=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let a=r.text,i=t.content[r.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=m(this,kt,"f")){if(m(this,st,"f"))switch(m(this,st,"f").type){case"text":this._emit("textDone",m(this,st,"f").text,m(this,Re,"f"));break;case"image_file":this._emit("imageFileDone",m(this,st,"f").image_file,m(this,Re,"f"));break}P(this,kt,r.index)}P(this,st,t.content[r.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(m(this,kt,"f")!==void 0){const r=e.data.content[m(this,kt,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,m(this,Re,"f"));break;case"text":this._emit("textDone",r.text,m(this,Re,"f"));break}}m(this,Re,"f")&&this._emit("messageDone",e.data),P(this,Re,void 0)}},si=function(e){const t=m(this,le,"m",ai).call(this,e);switch(P(this,Gt,t),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&s.step_details.type=="tool_calls"&&s.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const a of s.step_details.tool_calls)a.index==m(this,Qn,"f")?this._emit("toolCallDelta",a,t.step_details.tool_calls[a.index]):(m(this,ve,"f")&&this._emit("toolCallDone",m(this,ve,"f")),P(this,Qn,a.index),P(this,ve,t.step_details.tool_calls[a.index]),m(this,ve,"f")&&this._emit("toolCallCreated",m(this,ve,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,Gt,void 0),e.data.step_details.type=="tool_calls"&&m(this,ve,"f")&&(this._emit("toolCallDone",m(this,ve,"f")),P(this,ve,void 0)),this._emit("runStepDone",e.data,t);break}},ri=function(e){m(this,rr,"f").push(e),this._emit("event",e)},ai=function(e){switch(e.event){case"thread.run.step.created":return m(this,Ne,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=m(this,Ne,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const r=at.accumulateDelta(t,s.delta);m(this,Ne,"f")[e.data.id]=r}return m(this,Ne,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":m(this,Ne,"f")[e.data.id]=e.data;break}if(m(this,Ne,"f")[e.data.id])return m(this,Ne,"f")[e.data.id];throw new Error("No snapshot available")},ii=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const a of r.delta.content)if(a.index in t.content){let i=t.content[a.index];t.content[a.index]=m(this,le,"m",oi).call(this,a,i)}else t.content[a.index]=a,s.push(a);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},oi=function(e,t){return at.accumulateDelta(t,e)},ui=function(e){switch(P(this,Cn,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":P(this,it,e.data),m(this,ve,"f")&&(this._emit("toolCallDone",m(this,ve,"f")),P(this,ve,void 0));break}};let Dr=class extends N{constructor(){super(...arguments),this.steps=new du(this._client)}create(e,t,s){const{include:r,...a}=t;return this._client.post(x`/threads/${e}/runs`,{query:{include:r},body:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}retrieve(e,t,s){const{thread_id:r}=t;return this._client.get(x`/threads/${r}/runs/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:r,...a}=t;return this._client.post(x`/threads/${r}/runs/${e}`,{body:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(x`/threads/${e}/runs`,te,{query:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{thread_id:r}=t;return this._client.post(x`/threads/${r}/runs/${e}/cancel`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(r.id,{thread_id:e},s)}createAndStream(e,t,s){return Vt.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){const r=O([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(e,t,{...s,headers:{...s?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await un(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,s){return Vt.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){const{thread_id:r,...a}=t;return this._client.post(x`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){const r=await this.submitToolOutputs(e,t,s);return await this.poll(r.id,t,s)}submitToolOutputsStream(e,t,s){return Vt.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}};Dr.Steps=du;class cs extends N{constructor(){super(...arguments),this.runs=new Dr(this._client),this.messages=new lu(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(x`/threads/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(x`/threads/${e}`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t){return this._client.delete(x`/threads/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return Vt.createThreadAssistantStream(e,this._client.beta.threads,t)}}cs.Runs=Dr;cs.Messages=lu;class ln extends N{constructor(){super(...arguments),this.realtime=new us(this._client),this.assistants=new ou(this._client),this.threads=new cs(this._client)}}ln.Realtime=us;ln.Assistants=ou;ln.Threads=cs;class pu extends N{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class fu extends N{retrieve(e,t,s){const{container_id:r}=t;return this._client.get(x`/containers/${r}/files/${e}/content`,{...s,headers:O([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}let Nr=class extends N{constructor(){super(...arguments),this.content=new fu(this._client)}create(e,t,s){return this._client.post(x`/containers/${e}/files`,mt({body:t,...s},this._client))}retrieve(e,t,s){const{container_id:r}=t;return this._client.get(x`/containers/${r}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(x`/containers/${e}/files`,te,{query:t,...s})}delete(e,t,s){const{container_id:r}=t;return this._client.delete(x`/containers/${r}/files/${e}`,{...s,headers:O([{Accept:"*/*"},s?.headers])})}};Nr.Content=fu;class Pr extends N{constructor(){super(...arguments),this.files=new Nr(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(x`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",te,{query:e,...t})}delete(e,t){return this._client.delete(x`/containers/${e}`,{...t,headers:O([{Accept:"*/*"},t?.headers])})}}Pr.Files=Nr;class hu extends N{create(e,t,s){const{include:r,...a}=t;return this._client.post(x`/conversations/${e}/items`,{query:{include:r},body:a,...s})}retrieve(e,t,s){const{conversation_id:r,...a}=t;return this._client.get(x`/conversations/${r}/items/${e}`,{query:a,...s})}list(e,t={},s){return this._client.getAPIList(x`/conversations/${e}/items`,bp,{query:t,...s})}delete(e,t,s){const{conversation_id:r}=t;return this._client.delete(x`/conversations/${r}/items/${e}`,s)}}class $r extends N{constructor(){super(...arguments),this.items=new hu(this._client)}create(e,t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(x`/conversations/${e}`,t)}update(e,t,s){return this._client.post(x`/conversations/${e}`,{body:t,...s})}delete(e,t){return this._client.delete(x`/conversations/${e}`,t)}}$r.Items=hu;class mu extends N{create(e,t){const s=!!e.encoding_format;let r=s?e.encoding_format:"base64";s&&ce(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return s?a:(ce(this._client).debug("embeddings/decoding base64 embeddings from base64"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(o=>{const u=o.embedding;o.embedding=jp(u)}),i)))}}class _u extends N{retrieve(e,t,s){const{eval_id:r,run_id:a}=t;return this._client.get(x`/evals/${r}/runs/${a}/output_items/${e}`,s)}list(e,t,s){const{eval_id:r,...a}=t;return this._client.getAPIList(x`/evals/${r}/runs/${e}/output_items`,te,{query:a,...s})}}class Mr extends N{constructor(){super(...arguments),this.outputItems=new _u(this._client)}create(e,t,s){return this._client.post(x`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){const{eval_id:r}=t;return this._client.get(x`/evals/${r}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(x`/evals/${e}/runs`,te,{query:t,...s})}delete(e,t,s){const{eval_id:r}=t;return this._client.delete(x`/evals/${r}/runs/${e}`,s)}cancel(e,t,s){const{eval_id:r}=t;return this._client.post(x`/evals/${r}/runs/${e}`,s)}}Mr.OutputItems=_u;class Lr extends N{constructor(){super(...arguments),this.runs=new Mr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(x`/evals/${e}`,t)}update(e,t,s){return this._client.post(x`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",te,{query:e,...t})}delete(e,t){return this._client.delete(x`/evals/${e}`,t)}}Lr.Runs=Mr;let gu=class extends N{create(e,t){return this._client.post("/files",mt({body:e,...t},this._client))}retrieve(e,t){return this._client.get(x`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",te,{query:e,...t})}delete(e,t){return this._client.delete(x`/files/${e}`,t)}content(e,t){return this._client.get(x`/files/${e}/content`,{...t,headers:O([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=1800*1e3}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await un(t),i=await this.retrieve(e),Date.now()-a>s)throw new cr({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return i}};class yu extends N{}let vu=class extends N{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Fr extends N{constructor(){super(...arguments),this.graders=new vu(this._client)}}Fr.Graders=vu;class wu extends N{create(e,t,s){return this._client.getAPIList(x`/fine_tuning/checkpoints/${e}/permissions`,os,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.get(x`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}delete(e,t,s){const{fine_tuned_model_checkpoint:r}=t;return this._client.delete(x`/fine_tuning/checkpoints/${r}/permissions/${e}`,s)}}let jr=class extends N{constructor(){super(...arguments),this.permissions=new wu(this._client)}};jr.Permissions=wu;class bu extends N{list(e,t={},s){return this._client.getAPIList(x`/fine_tuning/jobs/${e}/checkpoints`,te,{query:t,...s})}}class Ur extends N{constructor(){super(...arguments),this.checkpoints=new bu(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(x`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",te,{query:e,...t})}cancel(e,t){return this._client.post(x`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(x`/fine_tuning/jobs/${e}/events`,te,{query:t,...s})}pause(e,t){return this._client.post(x`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(x`/fine_tuning/jobs/${e}/resume`,t)}}Ur.Checkpoints=bu;class Pt extends N{constructor(){super(...arguments),this.methods=new yu(this._client),this.jobs=new Ur(this._client),this.checkpoints=new jr(this._client),this.alpha=new Fr(this._client)}}Pt.Methods=yu;Pt.Jobs=Ur;Pt.Checkpoints=jr;Pt.Alpha=Fr;class xu extends N{}class Br extends N{constructor(){super(...arguments),this.graderModels=new xu(this._client)}}Br.GraderModels=xu;class Su extends N{createVariation(e,t){return this._client.post("/images/variations",mt({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",mt({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class Au extends N{retrieve(e,t){return this._client.get(x`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",os,e)}delete(e,t){return this._client.delete(x`/models/${e}`,t)}}class Tu extends N{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Iu extends N{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class Jr extends N{constructor(){super(...arguments),this.clientSecrets=new Iu(this._client)}}Jr.ClientSecrets=Iu;var bt,yn,Ge,vn,ci,li,di,pi;class Zr extends Cr{constructor(e){super(),bt.add(this),yn.set(this,void 0),Ge.set(this,void 0),vn.set(this,void 0),P(this,yn,e)}static createResponse(e,t,s){const r=new Zr(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),m(this,bt,"m",ci).call(this);let a,i=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const o of a)m(this,bt,"m",li).call(this,o,i);if(a.controller.signal?.aborted)throw new Ae;return m(this,bt,"m",di).call(this)}[(yn=new WeakMap,Ge=new WeakMap,vn=new WeakMap,bt=new WeakSet,ci=function(){this.ended||P(this,Ge,void 0)},li=function(t,s){if(this.ended)return;const r=(i,o)=>{(s==null||o.sequence_number>s)&&this._emit(i,o)},a=m(this,bt,"m",pi).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{const i=a.output[t.output_index];if(!i)throw new D(`missing output at index ${t.output_index}`);if(i.type==="message"){const o=i.content[t.content_index];if(!o)throw new D(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new D(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const i=a.output[t.output_index];if(!i)throw new D(`missing output at index ${t.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:i.arguments});break}default:r(t.type,t);break}},di=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");const t=m(this,Ge,"f");if(!t)throw new D("request ended without sending any events");P(this,Ge,void 0);const s=Bp(t,m(this,yn,"f"));return P(this,vn,s),s},pi=function(t){let s=m(this,Ge,"f");if(!s){if(t.type!=="response.created")throw new D(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return s=P(this,Ge,t.response),s}switch(t.type){case"response.output_item.added":{s.output.push(t.item);break}case"response.content_part.added":{const r=s.output[t.output_index];if(!r)throw new D(`missing output at index ${t.output_index}`);r.type==="message"&&r.content.push(t.part);break}case"response.output_text.delta":{const r=s.output[t.output_index];if(!r)throw new D(`missing output at index ${t.output_index}`);if(r.type==="message"){const a=r.content[t.content_index];if(!a)throw new D(`missing content at index ${t.content_index}`);if(a.type!=="output_text")throw new D(`expected content to be 'output_text', got ${a.type}`);a.text+=t.delta}break}case"response.function_call_arguments.delta":{const r=s.output[t.output_index];if(!r)throw new D(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.completed":{P(this,Ge,t.response);break}}return s},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=m(this,vn,"f");if(!e)throw new D("stream ended without producing a ChatCompletion");return e}}function Bp(n,e){return nl(n,e)}class ku extends N{list(e,t={},s){return this._client.getAPIList(x`/responses/${e}/input_items`,te,{query:t,...s})}}class qr extends N{constructor(){super(...arguments),this.inputItems=new ku(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&Js(s),s))}retrieve(e,t={},s){return this._client.get(x`/responses/${e}`,{query:t,...s,stream:t?.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&Js(r),r))}delete(e,t){return this._client.delete(x`/responses/${e}`,{...t,headers:O([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(s=>Bi(s,e))}stream(e,t){return Zr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(x`/responses/${e}/cancel`,t)}}qr.InputItems=ku;class Cu extends N{create(e,t,s){return this._client.post(x`/uploads/${e}/parts`,mt({body:t,...s},this._client))}}class Wr extends N{constructor(){super(...arguments),this.parts=new Cu(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(x`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(x`/uploads/${e}/complete`,{body:t,...s})}}Wr.Parts=Cu;const Jp=async n=>{const e=await Promise.allSettled(n),t=e.filter(r=>r.status==="rejected");if(t.length){for(const r of t)console.error(r.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const s=[];for(const r of e)r.status==="fulfilled"&&s.push(r.value);return s};class Eu extends N{create(e,t,s){return this._client.post(x`/vector_stores/${e}/file_batches`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:r}=t;return this._client.get(x`/vector_stores/${r}/file_batches/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{vector_store_id:r}=t;return this._client.post(x`/vector_stores/${r}/file_batches/${e}/cancel`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t);return await this.poll(e,r.id,s)}listFiles(e,t,s){const{vector_store_id:r,...a}=t;return this._client.getAPIList(x`/vector_stores/${r}/file_batches/${e}/files`,te,{query:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(e,t,s){const r=O([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(t,{vector_store_id:e},{...s,headers:r}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await un(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,i=Math.min(a,t.length),o=this._client,u=t.values(),c=[...s];async function l(h){for(let f of h){const _=await o.files.create({file:f,purpose:"assistants"},r);c.push(_.id)}}const p=Array(i).fill(u).map(l);return await Jp(p),await this.createAndPoll(e,{file_ids:c})}}class Ru extends N{create(e,t,s){return this._client.post(x`/vector_stores/${e}/files`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:r}=t;return this._client.get(x`/vector_stores/${r}/files/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{vector_store_id:r,...a}=t;return this._client.post(x`/vector_stores/${r}/files/${e}`,{body:a,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(x`/vector_stores/${e}/files`,te,{query:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{vector_store_id:r}=t;return this._client.delete(x`/vector_stores/${r}/files/${e}`,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(e,r.id,s)}async poll(e,t,s){const r=O([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const a=await this.retrieve(t,{vector_store_id:e},{...s,headers:r}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const u=a.response.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await un(o);break;case"failed":case"completed":return i}}}async upload(e,t,s){const r=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:r.id},s)}async uploadAndPoll(e,t,s){const r=await this.upload(e,t,s);return await this.poll(e,r.id,s)}content(e,t,s){const{vector_store_id:r}=t;return this._client.getAPIList(x`/vector_stores/${r}/files/${e}/content`,os,{...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class ls extends N{constructor(){super(...arguments),this.files=new Ru(this._client),this.fileBatches=new Eu(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(x`/vector_stores/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(x`/vector_stores/${e}`,{body:t,...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",te,{query:e,...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(x`/vector_stores/${e}`,{...t,headers:O([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,s){return this._client.getAPIList(x`/vector_stores/${e}/search`,os,{body:t,method:"post",...s,headers:O([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}ls.Files=Ru;ls.FileBatches=Eu;var Tt,Ou,En;class Du extends N{constructor(){super(...arguments),Tt.add(this)}async unwrap(e,t,s=this._client.webhookSecret,r=300){return await this.verifySignature(e,t,s,r),JSON.parse(e)}async verifySignature(e,t,s=this._client.webhookSecret,r=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");m(this,Tt,"m",Ou).call(this,s);const a=O([t]).values,i=m(this,Tt,"m",En).call(this,a,"webhook-signature"),o=m(this,Tt,"m",En).call(this,a,"webhook-timestamp"),u=m(this,Tt,"m",En).call(this,a,"webhook-id"),c=parseInt(o,10);if(isNaN(c))throw new Lt("Invalid webhook timestamp format");const l=Math.floor(Date.now()/1e3);if(l-c>r)throw new Lt("Webhook timestamp is too old");if(c>l+r)throw new Lt("Webhook timestamp is too new");const p=i.split(" ").map(w=>w.startsWith("v1,")?w.substring(3):w),h=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),f=u?`${u}.${o}.${e}`:`${o}.${e}`,_=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const w of p)try{const A=Buffer.from(w,"base64");if(await crypto.subtle.verify("HMAC",_,A,new TextEncoder().encode(f)))return}catch{continue}throw new Lt("The given webhook signature does not match the expected signature")}}Tt=new WeakSet,Ou=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},En=function(e,t){if(!e)throw new Error("Headers are required");const s=e.get(t);if(s==null)throw new Error(`Missing required header: ${t}`);return s};var ar,Hr,Rn,Nu;class L{constructor({baseURL:e=wt("OPENAI_BASE_URL"),apiKey:t=wt("OPENAI_API_KEY"),organization:s=wt("OPENAI_ORG_ID")??null,project:r=wt("OPENAI_PROJECT_ID")??null,webhookSecret:a=wt("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(ar.add(this),Rn.set(this,void 0),this.completions=new pu(this),this.chat=new Or(this),this.embeddings=new mu(this),this.files=new gu(this),this.images=new Su(this),this.audio=new cn(this),this.moderations=new Tu(this),this.models=new Au(this),this.fineTuning=new Pt(this),this.graders=new Br(this),this.vectorStores=new ls(this),this.webhooks=new Du(this),this.beta=new ln(this),this.batches=new iu(this),this.uploads=new Wr(this),this.responses=new qr(this),this.realtime=new Jr(this),this.conversations=new $r(this),this.evals=new Lr(this),this.containers=new Pr(this),t===void 0)throw new D("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:t,organization:s,project:r,webhookSecret:a,...i,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&Yd())throw new D(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??Hr.DEFAULT_TIMEOUT,this.logger=o.logger??console;const u="warn";this.logLevel=u,this.logLevel=Ka(o.logLevel,"ClientOptions.logLevel",this)??Ka(wt("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??u,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??sp(),P(this,Rn,ap),this._options=o,this.apiKey=typeof t=="string"?t:"Missing Key",this.organization=s,this.project=r,this.webhookSecret=a}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return O([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return dp(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${St}`}defaultIdempotencyKey(){return`stainless-node-retry-${bo()}`}makeStatusError(e,t,s,r){return de.generate(e,t,s,r)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let t;try{t=await e()}catch(s){throw s instanceof D?s:new D(`Failed to get token from 'apiKey' function: ${s.message}`,{cause:s})}if(typeof t!="string"||!t)throw new D(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,s){const r=!m(this,ar,"m",Nu).call(this)&&s||this.baseURL,a=zd(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return Gd(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new is(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:i,url:o,timeout:u}=await this.buildRequest(r,{retryCount:a-t});await this.prepareRequest(i,{url:o,options:r});const c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),l=s===void 0?"":`, retryOf: ${s}`,p=Date.now();if(ce(this).debug(`[${c}] sending request`,tt({retryOfRequestLogID:s,method:r.method,url:o,options:r,headers:i.headers})),r.signal?.aborted)throw new Ae;const h=new AbortController,f=await this.fetchWithTimeout(o,i,u,h).catch(Ns),_=Date.now();if(f instanceof globalThis.Error){const I=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new Ae;const S=Ds(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(t)return ce(this).info(`[${c}] connection ${S?"timed out":"failed"} - ${I}`),ce(this).debug(`[${c}] connection ${S?"timed out":"failed"} (${I})`,tt({retryOfRequestLogID:s,url:o,durationMs:_-p,message:f.message})),this.retryRequest(r,t,s??c);throw ce(this).info(`[${c}] connection ${S?"timed out":"failed"} - error; no more retries left`),ce(this).debug(`[${c}] connection ${S?"timed out":"failed"} (error; no more retries left)`,tt({retryOfRequestLogID:s,url:o,durationMs:_-p,message:f.message})),S?new cr:new es({cause:f})}const w=[...f.headers.entries()].filter(([I])=>I==="x-request-id").map(([I,S])=>", "+I+": "+JSON.stringify(S)).join(""),A=`[${c}${l}${w}] ${i.method} ${o} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${_-p}ms`;if(!f.ok){const I=await this.shouldRetry(f);if(t&&I){const G=`retrying, ${t} attempts remaining`;return await rp(f.body),ce(this).info(`${A} - ${G}`),ce(this).debug(`[${c}] response error (${G})`,tt({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,durationMs:_-p})),this.retryRequest(r,t,s??c,f.headers)}const S=I?"error; no more retries left":"error; not retryable";ce(this).info(`${A} - ${S}`);const U=await f.text().catch(G=>Ns(G).message),q=Xd(U),Y=q?void 0:U;throw ce(this).debug(`[${c}] response error (${S})`,tt({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,message:Y,durationMs:Date.now()-p})),this.makeStatusError(f.status,q,Y,f.headers)}return ce(this).info(A),ce(this).debug(`[${c}] response start`,tt({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,durationMs:_-p})),{response:f,options:r,controller:h,requestLogID:c,retryOfRequestLogID:s,startTime:p}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new wp(this,s,e)}async fetchWithTimeout(e,t,s,r){const{signal:a,method:i,...o}=t||{};a&&a.addEventListener("abort",()=>r.abort());const u=setTimeout(()=>r.abort(),s),c=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,l={signal:r.signal,...c?{duplex:"half"}:{},method:"GET",...o};i&&(l.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,l)}finally{clearTimeout(u)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s,r){let a;const i=r?.get("retry-after-ms");if(i){const u=parseFloat(i);Number.isNaN(u)||(a=u)}const o=r?.get("retry-after");if(o&&!a){const u=parseFloat(o);Number.isNaN(u)?a=Date.parse(o)-Date.now():a=u*1e3}if(!(a&&0<=a&&a<60*1e3)){const u=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,u)}return await un(a),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}async buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:r,path:a,query:i,defaultBaseURL:o}=s,u=this.buildURL(a,i,o);"timeout"in s&&Kd("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:c,body:l}=this.buildBody({options:s}),p=await this.buildHeaders({options:e,method:r,bodyHeaders:c,retryCount:t});return{req:{method:r,headers:p,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&l instanceof globalThis.ReadableStream&&{duplex:"half"},...l&&{body:l},...this.fetchOptions??{},...s.fetchOptions??{}},url:u,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:r}){let a={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const i=O([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...np(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=O([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Ao(e)}:m(this,Rn,"f").call(this,{body:e,headers:s})}}Hr=L,Rn=new WeakMap,ar=new WeakSet,Nu=function(){return this.baseURL!=="https://api.openai.com/v1"};L.OpenAI=Hr;L.DEFAULT_TIMEOUT=6e5;L.OpenAIError=D;L.APIError=de;L.APIConnectionError=es;L.APIConnectionTimeoutError=cr;L.APIUserAbortError=Ae;L.NotFoundError=Si;L.ConflictError=Ai;L.RateLimitError=Ii;L.BadRequestError=wi;L.AuthenticationError=bi;L.InternalServerError=ki;L.PermissionDeniedError=xi;L.UnprocessableEntityError=Ti;L.InvalidWebhookSignatureError=Lt;L.toFile=kp;L.Completions=pu;L.Chat=Or;L.Embeddings=mu;L.Files=gu;L.Images=Su;L.Audio=cn;L.Moderations=Tu;L.Models=Au;L.FineTuning=Pt;L.Graders=Br;L.VectorStores=ls;L.Webhooks=Du;L.Beta=ln;L.Batches=iu;L.Uploads=Wr;L.Responses=qr;L.Realtime=Jr;L.Conversations=$r;L.Evals=Lr;L.Containers=Pr;const Zp={version:"0.1.2"},qp="responses";let Wp=qp;function Hp(){return _r().OPENAI_API_KEY}function zp(){return Wp==="responses"}function Gp(){return _r().OPENAI_API_KEY}const zr={"User-Agent":`Agents/JavaScript ${Zp.version}`},ie=mr("openai-agents:openai"),Vp=V(["in_progress","completed","searching","failed"]).default("failed"),Kp=V(["in_progress","completed","searching","failed","incomplete"]).default("failed"),Xp=V(["in_progress","completed","interpreting"]).default("in_progress"),Yp=V(["in_progress","completed","generating","failed"]).default("failed");function z(n){if(!n||typeof n!="object"||Array.isArray(n))return n;const e={};for(const[t,s]of Object.entries(n)){const r=t.replace(/([A-Z])/g,"_$1").toLowerCase();e[r]=z(s)}return e}const Qp=V(["file_search","web_search","web_search_preview","computer_use_preview","code_interpreter","image_generation","mcp"]),ef=V(["auto","required","none"]);function tf(n){if(typeof n>"u")return;const e=ef.safeParse(n);if(e.success)return e.data;const t=Qp.safeParse(n);return t.success?{type:t.data}:{type:"function",name:n}}function nf(n,e){return n==="text"?e:{...e,format:n}}function sf(n,e){const t=[],s=[];for(const r of n){const{tool:a,include:i}=rf(r);if(t.push(a),i&&i.length>0)for(const o of i)s.push(o)}return{tools:[...t,...e.map(of)],include:s}}function rf(n){if(n.type==="function")return{tool:{type:"function",name:n.name,description:n.description,parameters:n.parameters,strict:n.strict},include:void 0};if(n.type==="computer")return{tool:{type:"computer_use_preview",environment:n.environment,display_width:n.dimensions[0],display_height:n.dimensions[1]},include:void 0};if(n.type==="hosted_tool"){if(n.providerData?.type==="web_search")return{tool:{type:"web_search",user_location:n.providerData.user_location,filters:n.providerData.filters,search_context_size:n.providerData.search_context_size},include:void 0};if(n.providerData?.type==="web_search_preview")return{tool:{type:"web_search_preview",user_location:n.providerData.user_location,search_context_size:n.providerData.search_context_size},include:void 0};if(n.providerData?.type==="file_search")return{tool:{type:"file_search",vector_store_ids:n.providerData.vector_store_ids||(typeof n.providerData.vector_store_id=="string"?[n.providerData.vector_store_id]:n.providerData.vector_store_id),max_num_results:n.providerData.max_num_results,ranking_options:n.providerData.ranking_options,filters:n.providerData.filters},include:n.providerData.include_search_results?["file_search_call.results"]:void 0};if(n.providerData?.type==="code_interpreter")return{tool:{type:"code_interpreter",container:n.providerData.container},include:void 0};if(n.providerData?.type==="image_generation")return{tool:{type:"image_generation",background:n.providerData.background,input_fidelity:n.providerData.input_fidelity,input_image_mask:n.providerData.input_image_mask,model:n.providerData.model,moderation:n.providerData.moderation,output_compression:n.providerData.output_compression,output_format:n.providerData.output_format,partial_images:n.providerData.partial_images,quality:n.providerData.quality,size:n.providerData.size},include:void 0};if(n.providerData?.type==="mcp")return{tool:{type:"mcp",server_label:n.providerData.server_label,server_url:n.providerData.server_url,connector_id:n.providerData.connector_id,authorization:n.providerData.authorization,allowed_tools:n.providerData.allowed_tools,headers:n.providerData.headers,require_approval:af(n.providerData.require_approval)},include:void 0};if(n.providerData)return{tool:n.providerData,include:void 0}}throw new Error(`Unsupported tool type: ${JSON.stringify(n)}`)}function af(n){return n==="never"||n===void 0?"never":n==="always"?"always":{never:{tool_names:n.never?.tool_names},always:{tool_names:n.always?.tool_names}}}function of(n){return{name:n.toolName,description:n.toolDescription,parameters:n.inputJsonSchema,strict:n.strictJsonSchema,type:"function"}}function Pu(n){if(n.type==="input_text")return{type:"input_text",text:n.text,...z(n.providerData)};if(n.type==="input_image"){const e={type:"input_image",detail:"auto"};return typeof n.image=="string"?e.image_url=n.image:e.file_id=n.image.id,{...e,...z(n.providerData)}}else if(n.type==="input_file"){const e={type:"input_file"};if(typeof n.file=="string")if(n.file.startsWith("data:"))e.file_data=n.file;else if(n.file.startsWith("https://"))e.file_url=n.file;else throw new H("Unsupported string data for file input. If you're trying to pass an uploaded file's ID, use an object with the ID property instead.");else"id"in n.file?e.file_id=n.file.id:"url"in n.file&&(e.file_url=n.file.url);return{...e,...z(n.providerData)}}throw new H(`Unsupported input content type: ${JSON.stringify(n)}`)}function uf(n){if(n.type==="output_text")return{type:"output_text",text:n.text,annotations:[],...z(n.providerData)};if(n.type==="refusal")return{type:"refusal",refusal:n.refusal,...z(n.providerData)};throw new H(`Unsupported output content type: ${JSON.stringify(n)}`)}function cf(n){if(n.role==="system")return{id:n.id,role:"system",content:n.content,...z(n.providerData)};if(n.role==="user")return typeof n.content=="string"?{id:n.id,role:"user",content:n.content,...z(n.providerData)}:{id:n.id,role:"user",content:n.content.map(Pu),...z(n.providerData)};if(n.role==="assistant")return{type:"message",id:n.id,role:"assistant",content:n.content.map(uf),status:n.status,...z(n.providerData)};throw new H(`Unsupported item ${JSON.stringify(n)}`)}function lf(n){return n.type==="message"||typeof n.type>"u"&&typeof n.role=="string"}function df(n){if(!n)return;const e={};for(const[t,s]of Object.entries(n.variables??{}))typeof s=="string"?e[t]=s:typeof s=="object"&&(e[t]=Pu(s));return{id:n.promptId,version:n.version,variables:e}}function pf(n){return typeof n=="string"?[{role:"user",content:n}]:n.map(e=>{if(lf(e))return cf(e);if(e.type==="function_call")return{id:e.id,type:"function_call",name:e.name,call_id:e.callId,arguments:e.arguments,status:e.status,...z(e.providerData)};if(e.type==="function_call_result"){if(e.output.type!=="text")throw new H(`Unsupported tool result type: ${JSON.stringify(e.output)}`);return{type:"function_call_output",id:e.id,call_id:e.callId,output:e.output.text,status:e.status,...z(e.providerData)}}if(e.type==="reasoning")return{id:e.id,type:"reasoning",summary:e.content.map(r=>({type:"summary_text",text:r.text,...z(r.providerData)})),encrypted_content:e.providerData?.encryptedContent,...z(e.providerData)};if(e.type==="computer_call")return{type:"computer_call",call_id:e.callId,id:e.id,action:e.action,status:e.status,pending_safety_checks:[],...z(e.providerData)};if(e.type==="computer_call_result")return{type:"computer_call_output",id:e.id,call_id:e.callId,output:ff(e),status:e.providerData?.status,acknowledged_safety_checks:e.providerData?.acknowledgedSafetyChecks,...z(e.providerData)};if(e.type==="hosted_tool_call"){if(e.providerData?.type==="web_search_call"||e.providerData?.type==="web_search")return{...z(e.providerData),type:"web_search_call",id:e.id,status:Vp.parse(e.status??"failed")};if(e.providerData?.type==="file_search_call"||e.providerData?.type==="file_search")return{...z(e.providerData),type:"file_search_call",id:e.id,status:Kp.parse(e.status??"failed"),queries:e.providerData?.queries??[],results:e.providerData?.results};if(e.providerData?.type==="code_interpreter_call"||e.providerData?.type==="code_interpreter")return{...z(e.providerData),type:"code_interpreter_call",id:e.id,code:e.providerData?.code??"",outputs:e.providerData?.outputs??e.providerData?.results??[],status:Xp.parse(e.status??"failed"),container_id:e.providerData?.container_id};if(e.providerData?.type==="image_generation_call"||e.providerData?.type==="image_generation")return{...z(e.providerData),type:"image_generation_call",id:e.id,result:e.providerData?.result??null,status:Yp.parse(e.status??"failed")};if(e.providerData?.type==="mcp_list_tools"||e.name==="mcp_list_tools"){const s=e.providerData;return{...z(e.providerData),type:"mcp_list_tools",id:e.id,tools:z(s.tools),server_label:s.server_label,error:s.error}}else if(e.providerData?.type==="mcp_approval_request"||e.name==="mcp_approval_request"){const s=e.providerData;return{...z(e.providerData),type:"mcp_approval_request",id:s.id??e.id,name:s.name,arguments:s.arguments,server_label:s.server_label}}else if(e.providerData?.type==="mcp_approval_response"||e.name==="mcp_approval_response"){const s=e.providerData;return{...z(s),type:"mcp_approval_response",id:s.id,approve:s.approve,approval_request_id:s.approval_request_id,reason:s.reason}}else if(e.providerData?.type==="mcp_call"||e.name==="mcp_call"){const s=e.providerData;return{...z(s),type:"mcp_call",id:s.id??e.id,name:s.name,arguments:s.arguments,server_label:s.server_label,error:s.error}}throw new H(`Unsupported built-in tool call type: ${JSON.stringify(e)}`)}if(e.type==="unknown")return{...z(e.providerData),id:e.id};const t=e;throw new H(`Unsupported item ${JSON.stringify(t)}`)})}function ff(n){return{type:"computer_screenshot",image_url:n.output.data}}function hf(n){if(n.type==="output_text"){const{type:e,text:t,...s}=n;return{type:e,text:t,...s}}if(n.type==="refusal"){const{type:e,refusal:t,...s}=n;return{type:e,refusal:t,...s}}throw new Error(`Unsupported message content type: ${JSON.stringify(n)}`)}function fi(n){return n.map(e=>{if(e.type==="message"){const{id:t,type:s,role:r,content:a,status:i,...o}=e;return{id:t,type:s,role:r,content:a.map(hf),status:i,providerData:o}}else if(e.type==="file_search_call"||e.type==="web_search_call"||e.type==="image_generation_call"||e.type==="code_interpreter_call"){const{status:t,...s}=e;let r;return"result"in s&&s.result!==null&&(r=s.result,delete s.result),{type:"hosted_tool_call",id:e.id,name:e.type,status:t,output:r,providerData:s}}else if(e.type==="function_call"){const{call_id:t,name:s,status:r,arguments:a,...i}=e;return{type:"function_call",id:e.id,callId:t,name:s,status:r,arguments:a,providerData:i}}else if(e.type==="computer_call"){const{call_id:t,status:s,action:r,...a}=e;return{type:"computer_call",id:e.id,callId:t,status:s,action:r,providerData:a}}else if(e.type==="mcp_list_tools"){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:void 0,providerData:t}}else if(e.type==="mcp_approval_request"){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:"mcp_approval_request",status:"completed",output:void 0,providerData:t}}else if(e.type==="mcp_call"){const{output:t,...s}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:t||void 0,providerData:s}}else if(e.type==="reasoning"){const{summary:t,...s}=e;return{type:"reasoning",id:e.id,content:t.map(a=>{const{text:i,...o}=a;return{type:"input_text",text:i,providerData:o}}),providerData:s}}return{type:"unknown",providerData:e}})}class mf{#e;#t;constructor(e,t){this.#e=e,this.#t=t}async#n(e,t){const s=pf(e.input),{tools:r,include:a}=sf(e.tools,e.handoffs),i=tf(e.modelSettings.toolChoice),{text:o,...u}=e.modelSettings.providerData??{},c=nf(e.outputType,o),l=df(e.prompt);let p;if(typeof e.modelSettings.parallelToolCalls=="boolean"){if(e.modelSettings.parallelToolCalls&&r.length===0)throw new Error("Parallel tool calls are not supported without tools");p=e.modelSettings.parallelToolCalls}const h={instructions:e.systemInstructions,model:this.#t,input:s,include:a,tools:r,previous_response_id:e.previousResponseId,conversation:e.conversationId,prompt:l,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,truncation:e.modelSettings.truncation,max_output_tokens:e.modelSettings.maxTokens,tool_choice:i,parallel_tool_calls:p,stream:t,text:c,store:e.modelSettings.store,...u};ie.dontLogModelData?ie.debug("Calling LLM"):ie.debug(`Calling LLM. Request data: ${JSON.stringify(h,null,2)}`);const f=await this.#e.responses.create(h,{headers:zr,signal:e.signal});return ie.dontLogModelData?ie.debug("Response received"):ie.debug(`Response received: ${JSON.stringify(f,null,2)}`),f}async getResponse(e){const t=await Zl(async r=>{const a=await this.#n(e,!1);return e.tracing&&(r.spanData.response_id=a.id,r.spanData._input=e.input,r.spanData._response=a),a});return{usage:new ht({inputTokens:t.usage?.input_tokens??0,outputTokens:t.usage?.output_tokens??0,totalTokens:t.usage?.total_tokens??0,inputTokensDetails:{...t.usage?.input_tokens_details},outputTokensDetails:{...t.usage?.output_tokens_details}}),output:fi(t.output),responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?Xi():void 0;try{t&&(t.start(),Ct(t),e.tracing===!0&&(t.spanData._input=e.input));const s=await this.#n(e,!0);let r;for await(const a of s){if(a.type==="response.created")yield{type:"response_started",providerData:{...a}};else if(a.type==="response.completed"){r=a.response;const{response:i,...o}=a,{output:u,usage:c,id:l,...p}=i;yield{type:"response_done",response:{id:l,output:fi(u),usage:{inputTokens:c?.input_tokens??0,outputTokens:c?.output_tokens??0,totalTokens:c?.total_tokens??0,inputTokensDetails:{...c?.input_tokens_details},outputTokensDetails:{...c?.output_tokens_details}},providerData:p},providerData:o},yield{type:"model",event:a}}else if(a.type==="response.output_text.delta"){const{delta:i,...o}=a;yield{type:"output_text_delta",delta:i,providerData:o}}yield{type:"model",event:a}}e.tracing&&t&&r&&(t.spanData.response_id=r.id,t.spanData._response=r)}catch(s){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing?String(s):s instanceof Error?s.name:void 0}}),s}finally{t&&(t.end(),rt())}}}async function*_f(n,e){let t;const s={started:!1,text_content_index_and_output:null,refusal_content_index_and_output:null,function_calls:{},reasoning:""};for await(const i of e){if(s.started||(s.started=!0,yield{type:"response_started",providerData:{...i}}),yield{type:"model",event:i},t=i.usage||void 0,!i.choices?.[0]?.delta)continue;const o=i.choices[0].delta;if(o.content&&(s.text_content_index_and_output||(s.text_content_index_and_output=[s.refusal_content_index_and_output?1:0,{text:"",type:"output_text",providerData:{annotations:[]}}]),yield{type:"output_text_delta",delta:o.content,providerData:{...i}},s.text_content_index_and_output[1].text+=o.content),"reasoning"in o&&o.reasoning&&typeof o.reasoning=="string"&&(s.reasoning+=o.reasoning),"refusal"in o&&o.refusal&&(s.refusal_content_index_and_output||(s.refusal_content_index_and_output=[s.text_content_index_and_output?1:0,{refusal:"",type:"refusal"}]),s.refusal_content_index_and_output[1].refusal+=o.refusal),o.tool_calls)for(const u of o.tool_calls){u.index in s.function_calls||(s.function_calls[u.index]={id:ir,arguments:"",name:"",type:"function_call",callId:""});const c=u.function;s.function_calls[u.index].arguments+=c?.arguments||"",s.function_calls[u.index].name+=c?.name||"",s.function_calls[u.index].callId+=u.id||""}}const r=[];if(s.reasoning&&r.push({type:"reasoning",content:[],rawContent:[{type:"reasoning_text",text:s.reasoning}]}),s.text_content_index_and_output||s.refusal_content_index_and_output){const i={id:ir,content:[],role:"assistant",type:"message",status:"completed"};s.text_content_index_and_output&&i.content.push(s.text_content_index_and_output[1]),s.refusal_content_index_and_output&&i.content.push(s.refusal_content_index_and_output[1]),r.push(i)}for(const i of Object.values(s.function_calls))r.push(i);yield{type:"response_done",response:{id:n.id,usage:{inputTokens:t?.prompt_tokens??0,outputTokens:t?.completion_tokens??0,totalTokens:t?.total_tokens??0,inputTokensDetails:{cached_tokens:t?.prompt_tokens_details?.cached_tokens??0},outputTokensDetails:{reasoning_tokens:t?.completion_tokens_details?.reasoning_tokens??0}},output:r}}}function gf(n){if(!(n==null||n==null))return n==="auto"||n==="required"||n==="none"?n:{type:"function",function:{name:n}}}function yf(n){if(typeof n=="string")return n;const e=[];for(const t of n)if(t.type==="output_text")e.push({type:"text",text:t.text,...t.providerData});else if(t.type==="refusal")e.push({type:"refusal",refusal:t.refusal,...t.providerData});else{if(t.type==="audio"||t.type==="image")continue;{const s=t;throw new Error(`Unknown content: ${JSON.stringify(s)}`)}}return e}function vf(n){if(typeof n=="string")return n;const e=[];for(const t of n)if(t.type==="input_text")e.push({type:"text",text:t.text,...t.providerData});else if(t.type==="input_image"){if(typeof t.image!="string")throw new Error(`Only image URLs are supported for input_image: ${JSON.stringify(t)}`);const{image_url:s,...r}=t.providerData||{};e.push({type:"image_url",image_url:{url:t.image,...s},...r})}else{if(t.type==="input_file")throw new Error(`File uploads are not supported for chat completions: ${JSON.stringify(t)}`);if(t.type==="audio"){const{input_audio:s,...r}=t.providerData||{};e.push({type:"input_audio",input_audio:{data:t.audio,...s},...r})}else{const s=t;throw new Error(`Unknown content: ${JSON.stringify(s)}`)}}return e}function wf(n){return n.type==="message"||typeof n.type>"u"&&typeof n.role=="string"}function bf(n){if(typeof n=="string")return[{role:"user",content:n}];const e=[];let t=null;const s=()=>{t&&((!t.tool_calls||t.tool_calls.length===0)&&delete t.tool_calls,e.push(t),t=null)},r=()=>(t||(t={role:"assistant",tool_calls:[]}),t);for(const a of n)if(wf(a)){const{content:i,role:o,providerData:u}=a;if(s(),o==="assistant"){const c={role:"assistant",content:yf(i),...u};if(Array.isArray(i)){const l=i.find(p=>p.type==="audio");l&&(c.audio={id:"",...l.providerData})}e.push(c)}else o==="user"?e.push({role:o,content:vf(i),...u}):o==="system"&&e.push({role:"system",content:i,...u})}else if(a.type==="reasoning"){const i=r();i.reasoning=a.rawContent?.[0]?.text;continue}else if(a.type==="hosted_tool_call")if(a.name==="file_search_call"){const i=r(),o=i.tool_calls??[],u=a,{function:c,...l}=u.providerData??{},{arguments:p,...h}=c??{};o.push({id:u.id||"",type:"function",function:{name:"file_search_call",arguments:JSON.stringify({queries:u.providerData?.queries??[],status:u.status,...p}),...h},...l}),i.tool_calls=o;continue}else throw new H("Hosted tool calls are not supported for chat completions. Got item: "+JSON.stringify(a));else{if(a.type==="computer_call"||a.type==="computer_call_result")throw new H("Computer use calls are not supported for chat completions. Got item: "+JSON.stringify(a));if(a.type==="function_call"){const i=r(),o=i.tool_calls??[],u=a;o.push({id:u.callId,type:"function",function:{name:u.name,arguments:u.arguments??"{}"}}),i.tool_calls=o}else if(a.type==="function_call_result"){s();const i=a;if(i.output.type!=="text")throw new H("Only text output is supported for chat completions. Got item: "+JSON.stringify(a));e.push({role:"tool",tool_call_id:i.callId,content:i.output.text,...i.providerData})}else if(a.type==="unknown")e.push({...a.providerData});else{const i=a;throw new Error(`Unknown item type: ${JSON.stringify(i)}`)}}return s(),e}function xf(n){if(n.type==="function")return{type:"function",function:{name:n.name,description:n.description||"",parameters:n.parameters,strict:n.strict}};throw new Error(`Hosted tools are not supported with the ChatCompletions API. Got tool type: ${n.type}, tool: ${JSON.stringify(n)}`)}function Sf(n){return{type:"function",function:{name:n.toolName,description:n.toolDescription||"",parameters:n.inputJsonSchema}}}const ir="FAKE_ID";function Af(n){return"reasoning"in n&&typeof n.reasoning=="string"&&n.reasoning!==""}class Tf{#e;#t;constructor(e,t){this.#e=e,this.#t=t}async getResponse(e){const t=await zl(async a=>{a.spanData.model=this.#t,a.spanData.model_config=e.modelSettings?{temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty}:{base_url:this.#e.baseURL};const i=await this.#n(e,a,!1);return a&&e.tracing===!0&&(a.spanData.output=[i]),i}),s=[];if(t.choices&&t.choices[0]){const a=t.choices[0].message;if(Af(a)&&s.push({type:"reasoning",content:[],rawContent:[{type:"reasoning_text",text:a.reasoning}]}),a.content!==void 0&&a.content!==null&&!(a.tool_calls&&a.content==="")){const{content:i,...o}=a;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"output_text",text:i||"",providerData:o}],status:"completed"})}else if(a.refusal){const{refusal:i,...o}=a;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"refusal",refusal:i||"",providerData:o}],status:"completed"})}else if(a.audio){const{data:i,...o}=a.audio;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"audio",audio:i,providerData:o}],status:"completed"})}else if(a.tool_calls){for(const i of a.tool_calls)if(i.type==="function"){const{id:o,...u}=i,{arguments:c,name:l,...p}=i.function;s.push({id:t.id,type:"function_call",arguments:c,name:l,callId:o,status:"completed",providerData:{...u,...p}})}}}return{usage:t.usage?new ht(kf(t.usage)):new ht,output:s,responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?Yi():void 0;try{t&&(t.start(),Ct(t));const s=await this.#n(e,t,!0),r={id:ir,created:Math.floor(Date.now()/1e3),model:this.#t,object:"chat.completion",choices:[],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}};for await(const a of _f(r,s))yield a;t&&r&&e.tracing===!0&&(t.spanData.output=[r])}catch(s){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing===!0?String(s):s instanceof Error?s.name:void 0}}),s}finally{t&&(t.end(),rt())}}async#n(e,t,s){const r=[];if(e.tools)for(const l of e.tools)r.push(xf(l));if(e.handoffs)for(const l of e.handoffs)r.push(Sf(l));const a=If(e.outputType);let i;if(typeof e.modelSettings.parallelToolCalls=="boolean"){if(e.modelSettings.parallelToolCalls&&r.length===0)throw new Error("Parallel tool calls are not supported without tools");i=e.modelSettings.parallelToolCalls}const o=bf(e.input);e.systemInstructions&&o.unshift({content:e.systemInstructions,role:"system"}),t&&e.tracing===!0&&(t.spanData.input=o);const u={model:this.#t,messages:o,tools:r.length?r:void 0,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,max_tokens:e.modelSettings.maxTokens,tool_choice:gf(e.modelSettings.toolChoice),response_format:a,parallel_tool_calls:i,stream:s,store:e.modelSettings.store,...e.modelSettings.providerData};ie.dontLogModelData?ie.debug("Calling LLM"):ie.debug(`Calling LLM. Request data: ${JSON.stringify(u,null,2)}`);const c=await this.#e.chat.completions.create(u,{headers:zr,signal:e.signal});return ie.dontLogModelData?ie.debug("Response received"):ie.debug(`Response received: ${JSON.stringify(c,null,2)}`),c}}function If(n){return n==="text"?{type:"text"}:n.type==="json_schema"?{type:"json_schema",json_schema:{name:n.name,strict:n.strict,schema:n.schema}}:{type:"json_object"}}function kf(n){return{requests:1,input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens,input_tokens_details:{cached_tokens:n.prompt_tokens_details?.cached_tokens||0},output_tokens_details:{reasoning_tokens:n.completion_tokens_details?.reasoning_tokens||0}}}class Cf{#e;#t;#n;constructor(e={}){if(this.#n=e,this.#n.openAIClient){if(this.#n.apiKey)throw new Error("Cannot provide both apiKey and openAIClient");if(this.#n.baseURL)throw new Error("Cannot provide both baseURL and openAIClient");this.#e=this.#n.openAIClient}this.#t=this.#n.useResponses}#s(){return this.#e||(this.#e=new L({apiKey:this.#n.apiKey??Gp(),baseURL:this.#n.baseURL,organization:this.#n.organization,project:this.#n.project})),this.#e}async getModel(e){const t=e||yr();return this.#t??zp()?new mf(this.#s(),t):new Tf(this.#s(),t)}}class Ef{#e;constructor(e={}){this.#e={apiKey:e.apiKey??void 0,organization:e.organization??"",project:e.project??"",endpoint:e.endpoint??"https://api.openai.com/v1/traces/ingest",maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4}}async export(e,t){const s=this.#e.apiKey??Hp();if(!s){ie.error("No API key provided for OpenAI tracing exporter. Exports will be skipped");return}const r={data:e.map(o=>o.toJSON()).filter(o=>!!o)};let a=0,i=this.#e.baseDelay;for(;a<this.#e.maxRetries;){try{const u=await fetch(this.#e.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,"OpenAI-Beta":"traces=v1",...zr},body:JSON.stringify(r),signal:t});if(u.ok){ie.debug(`Exported ${r.data.length} items`);return}if(u.status>=400&&u.status<500){ie.error(`[non-fatal] Tracing client error ${u.status}: ${await u.text()}`);return}ie.warn(`[non-fatal] Tracing: server error ${u.status}, retrying.`)}catch(u){ie.error("[non-fatal] Tracing: request failed: ",u)}if(t?.aborted){ie.error("Tracing: request aborted");return}const o=i+Math.random()*.1*i;await new Promise(u=>setTimeout(u,o)),i=Math.min(i*2,this.#e.maxDelay),a++}ie.error(`Tracing: failed to export traces after ${this.#e.maxRetries} attempts`)}}function Rf(){const n=new Ef,e=new Gi(n);Yl([e])}const or={version:"0.1.2"};function Of(n){const e=atob(n),t=e.length,s=new Uint8Array(t);for(let r=0;r<t;r++)s[r]=e.charCodeAt(r);return s.buffer}function Df(n){const e=String.fromCharCode(...new Uint8Array(n));return btoa(e)}function Nf(n){if(typeof n>"u"||n===null||typeof n!="object"||!("type"in n)||typeof n.type!="string"||!n.type||n.type!=="message"||!("content"in n)||!Array.isArray(n.content)||n.content.length<1)return;const e=n.content[n.content.length-1];if(!(!("type"in e)||typeof e.type!="string")){if(e.type==="output_text")return typeof e.text=="string"?e.text:void 0;if(e.type==="output_audio")return typeof e.transcript=="string"?e.transcript:void 0}}function Pf(n,e){const t=n.filter(a=>!e.some(i=>i.itemId===a.itemId)),s=e.filter(a=>!n.some(i=>i.itemId===a.itemId)),r=e.filter(a=>n.some(i=>i.itemId===a.itemId&&JSON.stringify(i)!==JSON.stringify(a)));return{removals:t,additions:s,updates:r}}function $f(){return typeof window>"u"?!1:typeof window.RTCPeerConnection<"u"}function hi(n){return n.role==="system"?n:n.role==="assistant"?{...n,content:n.content.map(e=>e.type==="output_audio"?{...e,audio:null}:e)}:n.role==="user"?{...n,content:n.content.map(e=>e.type==="input_audio"?{...e,audio:null}:e)}:n}function mi(n,e,t){if(e.type==="conversation.item.input_audio_transcription.completed")return n.map(a=>{if(a.itemId===e.item_id&&a.type==="message"&&"role"in a&&a.role==="user"){const i=a.content.map(o=>o.type==="input_audio"?{...o,transcript:e.transcript}:o);return{...a,content:i,status:"completed"}}return a});const s=!t&&e.type==="message"?hi(e):e,r=n.findIndex(a=>a.itemId===e.itemId);if(r!==-1)return n.map((a,i)=>i===r?s:!t&&a.type==="message"?hi(a):a);if(e.previousItemId){const a=n.findIndex(i=>i.itemId===e.previousItemId);return a!==-1?[...n.slice(0,a+1),s,...n.slice(a+1)]:[...n,s]}else return[...n,s]}const Mf={"User-Agent":`Agents/JavaScript ${or.version}`,"X-OpenAI-Agents-SDK":`openai-agents-sdk.${or.version}`},Lf=`openai-agents-sdk.${or.version}`;function Ff(n,e){const{name:t,arguments:s,...r}=e;return new Ie({type:"hosted_tool_call",name:t,arguments:JSON.stringify(s),status:"in_progress",providerData:{...r}},n)}function _i(n){const{name:e,arguments:t,providerData:s}=n.rawItem,{itemId:r,serverLabel:a,...i}=s??{};if(!r||!a)throw new Error("Invalid approval item for Realtime MCP approval request");return{type:"mcp_approval_request",itemId:r,serverLabel:a,...i,name:e,arguments:t?JSON.parse(t):{},approved:null}}class jf extends qe{voice;constructor(e){super(e),this.voice=e.voice}}function Uf(n){return{debounceTextLength:n.debounceTextLength??100}}function Bf({policyHint:n,...e}){const t=Hs(e),s=n??t.name;return{...t,policyHint:s,run:async r=>{const a=await t.run(r);return{...a,guardrail:{...a.guardrail,policyHint:s}}}}}function Jf(n){return`
⚠️ Your last answer was blocked. 
Failed Guardrail Reason: ${n.guardrail.policyHint}. 
Failure Details: ${JSON.stringify(n.output.outputInfo??{})}. 
Please respond again following policy. Apologize for not being able to answer the question (while avoiding the specific reason) and divert discussion back to an approved topic immediately and not invite more discussion.
`.trim()}const Se=mr("openai-agents:realtime");function Ve(n,e){return n in e&&typeof e[n]<"u"}function Zf(n){return Ve("modalities",n)||Ve("voice",n)||Ve("inputAudioFormat",n)||Ve("outputAudioFormat",n)||Ve("inputAudioTranscription",n)||Ve("turnDetection",n)||Ve("inputAudioNoiseReduction",n)||Ve("speed",n)}function qf(n){return Zf(n)?{model:n.model,instructions:n.instructions,toolChoice:n.toolChoice,tools:n.tools,tracing:n.tracing,providerData:n.providerData,prompt:n.prompt,outputModalities:n.modalities,audio:{input:{format:wn(n.inputAudioFormat),noiseReduction:n.inputAudioNoiseReduction??null,transcription:n.inputAudioTranscription,turnDetection:n.turnDetection},output:{format:wn(n.outputAudioFormat),voice:n.voice,speed:n.speed}}}:{model:n.model,instructions:n.instructions,toolChoice:n.toolChoice,tools:n.tools,tracing:n.tracing,providerData:n.providerData,prompt:n.prompt,outputModalities:n.outputModalities,audio:n.audio?{input:n.audio.input?{format:wn(n.audio.input.format),noiseReduction:n.audio.input.noiseReduction??null,transcription:n.audio.input.transcription,turnDetection:n.audio.input.turnDetection}:void 0,output:n.audio.output?{format:wn(n.audio.output.format),voice:n.audio.output.voice,speed:n.audio.output.speed}:void 0}:void 0}}function wn(n){if(!n)return;if(typeof n=="object")return n;const e=String(n);return e==="pcm16"?{type:"audio/pcm",rate:24e3}:e==="g711_ulaw"?{type:"audio/pcmu"}:e==="g711_alaw"?{type:"audio/pcma"}:{type:"audio/pcm",rate:24e3}}g({itemId:d()});const gi=we("role",[g({itemId:d(),previousItemId:d().nullable().optional(),type:y("message"),role:y("system"),content:B(g({type:y("input_text"),text:d()}))}),g({itemId:d(),previousItemId:d().nullable().optional(),type:y("message"),role:y("user"),status:V(["in_progress","completed"]),content:B(g({type:y("input_text"),text:d()}).or(g({type:y("input_audio"),audio:d().nullable().optional(),transcript:d().nullable()})))}),g({itemId:d(),previousItemId:d().nullable().optional(),type:y("message"),role:y("assistant"),status:V(["in_progress","completed","incomplete"]),content:B(g({type:y("output_text"),text:d()}).or(g({type:y("output_audio"),audio:d().nullable().optional(),transcript:d().nullable().optional()})))})]),yi=g({itemId:d(),previousItemId:d().nullable().optional(),type:y("function_call"),status:V(["in_progress","completed","incomplete"]),arguments:d(),name:d(),output:d().nullable()}),vi=g({itemId:d(),previousItemId:d().nullable().optional(),type:V(["mcp_call","mcp_tool_call"]),status:V(["in_progress","completed","incomplete"]),arguments:d(),name:d(),output:d().nullable()}),Wf=g({itemId:d(),type:y("mcp_approval_request"),serverLabel:d(),name:d(),arguments:ee(d(),F()),approved:ot().optional().nullable()}),$u=g({id:d().optional().nullable(),conversation_id:d().optional().nullable(),max_output_tokens:C().or(y("inf")).optional().nullable(),metadata:ee(d(),F()).optional().nullable(),output_modalities:B(d()).optional().nullable(),object:y("realtime.response").optional().nullable(),output:B(F()).optional().nullable(),audio:g({output:g({format:F().optional().nullable(),voice:d().optional().nullable()}).optional().nullable()}).optional().nullable(),status:V(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:ee(d(),F()).optional().nullable(),usage:g({input_tokens:C().optional(),input_tokens_details:ee(d(),F()).optional().nullable(),output_tokens:C().optional(),output_tokens_details:ee(d(),F()).optional().nullable()}).optional().nullable()}),Hf=g({id:d().optional(),audio:d().nullable().optional(),text:d().nullable().optional(),transcript:d().nullable().optional(),type:Li([y("input_text"),y("input_audio"),y("item_reference"),y("output_text"),y("output_audio")])}),$t=g({id:d().optional(),arguments:d().optional(),call_id:d().optional(),content:B(Hf).optional(),name:d().optional(),output:d().nullable().optional(),role:V(["user","assistant","system"]).optional(),status:V(["completed","incomplete","in_progress"]).optional(),type:V(["message","function_call","function_call_output","mcp_list_tools","mcp_tool_call","mcp_call","mcp_approval_request","mcp_approval_response"]).optional(),approval_request_id:d().nullable().optional(),approve:ot().nullable().optional(),reason:d().nullable().optional(),server_label:d().optional(),error:F().nullable().optional(),tools:B(g({name:d(),description:d(),input_schema:ee(F()).optional()}).passthrough()).optional()}).passthrough(),zf=g({type:y("conversation.created"),event_id:d(),conversation:g({id:d().optional(),object:y("realtime.conversation").optional()})}),Gf=g({type:y("conversation.item.added"),event_id:d(),item:$t,previous_item_id:d().nullable().optional()}),Vf=g({type:y("conversation.item.done"),event_id:d(),item:$t,previous_item_id:d().nullable().optional()}),Kf=g({type:y("conversation.item.deleted"),event_id:d(),item_id:d()}),Xf=g({type:y("conversation.item.input_audio_transcription.completed"),event_id:d(),item_id:d(),content_index:C(),transcript:d(),logprobs:B(F()).nullable().optional()}),Yf=g({type:y("conversation.item.input_audio_transcription.delta"),event_id:d(),item_id:d(),content_index:C().optional(),delta:d().optional(),logprobs:B(F()).nullable().optional()}),Qf=g({type:y("conversation.item.input_audio_transcription.failed"),event_id:d(),item_id:d(),content_index:C(),error:g({code:d().optional(),message:d().optional(),param:d().optional(),type:d().optional()})}),eh=g({type:y("conversation.item.retrieved"),event_id:d(),item:$t}),th=g({type:y("conversation.item.truncated"),event_id:d(),item_id:d(),audio_end_ms:C(),content_index:C()}),nh=g({type:y("conversation.item.create"),item:$t,event_id:d().optional(),previous_item_id:d().nullable().optional()}),sh=g({type:y("conversation.item.delete"),item_id:d(),event_id:d().optional()}),rh=g({type:y("conversation.item.retrieve"),item_id:d(),event_id:d().optional()}),ah=g({type:y("conversation.item.truncate"),item_id:d(),audio_end_ms:C(),content_index:C(),event_id:d().optional()}),ih=g({type:y("error"),event_id:d().optional(),error:F().optional()}),oh=g({type:y("input_audio_buffer.cleared"),event_id:d()}),uh=g({type:y("input_audio_buffer.append"),audio:d(),event_id:d().optional()}),ch=g({type:y("input_audio_buffer.clear"),event_id:d().optional()}),lh=g({type:y("input_audio_buffer.commit"),event_id:d().optional()}),dh=g({type:y("input_audio_buffer.committed"),event_id:d(),item_id:d(),previous_item_id:d().nullable().optional()}),ph=g({type:y("input_audio_buffer.speech_started"),event_id:d(),item_id:d(),audio_start_ms:C()}),fh=g({type:y("input_audio_buffer.speech_stopped"),event_id:d(),item_id:d(),audio_end_ms:C()}),hh=g({type:y("output_audio_buffer.started"),event_id:d()}).passthrough(),mh=g({type:y("output_audio_buffer.stopped"),event_id:d()}).passthrough(),_h=g({type:y("output_audio_buffer.cleared"),event_id:d()}),gh=g({type:y("rate_limits.updated"),event_id:d(),rate_limits:B(g({limit:C().optional(),name:V(["requests","tokens"]).optional(),remaining:C().optional(),reset_seconds:C().optional()}))}),yh=g({type:y("response.output_audio.delta"),event_id:d(),item_id:d(),content_index:C(),delta:d(),output_index:C(),response_id:d()}),vh=g({type:y("response.output_audio.done"),event_id:d(),item_id:d(),content_index:C(),output_index:C(),response_id:d()}),wh=g({type:y("response.output_audio_transcript.delta"),event_id:d(),item_id:d(),content_index:C(),delta:d(),output_index:C(),response_id:d()}),bh=g({type:y("response.output_audio_transcript.done"),event_id:d(),item_id:d(),content_index:C(),transcript:d(),output_index:C(),response_id:d()}),xh=g({type:y("response.content_part.added"),event_id:d(),item_id:d(),content_index:C(),output_index:C(),response_id:d(),part:g({audio:d().optional(),text:d().optional(),transcript:d().optional(),type:V(["text","audio"]).optional()})}),Sh=g({type:y("response.content_part.done"),event_id:d(),item_id:d(),content_index:C(),output_index:C(),response_id:d(),part:g({audio:d().optional(),text:d().optional(),transcript:d().optional(),type:V(["text","audio"]).optional()})}),Ah=g({type:y("response.created"),event_id:d(),response:$u}),Mu=g({type:y("response.done"),event_id:d(),response:$u}),Th=g({type:y("response.function_call_arguments.delta"),event_id:d(),item_id:d(),call_id:d(),delta:d(),output_index:C(),response_id:d()}),Ih=g({type:y("response.function_call_arguments.done"),event_id:d(),item_id:d(),call_id:d(),arguments:d(),output_index:C(),response_id:d()}),kh=g({type:y("response.output_item.added"),event_id:d(),item:$t,output_index:C(),response_id:d()}),Ch=g({type:y("response.output_item.done"),event_id:d(),item:$t,output_index:C(),response_id:d()}),Eh=g({type:y("response.output_text.delta"),event_id:d(),item_id:d(),content_index:C(),delta:d(),output_index:C(),response_id:d()}),Rh=g({type:y("response.output_text.done"),event_id:d(),item_id:d(),content_index:C(),text:d(),output_index:C(),response_id:d()}),Oh=g({type:y("session.created"),event_id:d(),session:F()}),Dh=g({type:y("session.updated"),event_id:d(),session:F()}),Nh=g({type:y("response.cancel"),event_id:d().optional(),response_id:d().optional()}),Ph=g({type:y("response.create"),event_id:d().optional(),response:F().optional()}),$h=g({type:y("session.update"),event_id:d().optional(),session:F()}),Mh=g({type:y("mcp_list_tools.in_progress"),event_id:d().optional(),item_id:d().optional()}),Lh=g({type:y("mcp_list_tools.completed"),event_id:d().optional(),item_id:d().optional()}),Fh=g({type:y("response.mcp_call_arguments.delta"),event_id:d(),response_id:d(),item_id:d(),output_index:C(),delta:d(),obfuscation:d()}),jh=g({type:y("response.mcp_call_arguments.done"),event_id:d(),response_id:d(),item_id:d(),output_index:C(),arguments:d()}),Uh=g({type:y("response.mcp_call.in_progress"),event_id:d(),output_index:C(),item_id:d()}),Bh=g({type:y("response.mcp_call.completed"),event_id:d(),output_index:C(),item_id:d()}),Jh=g({type:y("mcp_list_tools.failed"),event_id:d().optional(),item_id:d().optional()}),Zh=g({type:d(),event_id:d().optional().nullable()}).passthrough(),qh=we("type",[zf,Gf,Vf,Kf,Xf,Yf,Qf,eh,th,ih,oh,dh,ph,fh,hh,mh,_h,gh,yh,vh,wh,bh,xh,Sh,Ah,Mu,Th,Ih,kh,Ch,Eh,Rh,Oh,Dh,Mh,Lh,Jh,Fh,jh,Uh,Bh]);we("type",[nh,sh,rh,ah,uh,ch,lh,Nh,Ph,$h]);function Gr(n){const e=JSON.parse(n.data.toString()),t=qh.safeParse(e);if(!t.success){const s=Zh.safeParse(e);return s.success?{data:s.data,isGeneric:!0}:{data:null,isGeneric:!0}}return{data:t.data,isGeneric:!1}}const Wh="gpt-realtime",je={outputModalities:["audio"],audio:{input:{format:{type:"audio/pcm",rate:24e3},transcription:{model:"gpt-4o-mini-transcribe"},turnDetection:{type:"semantic_vad"},noiseReduction:null},output:{format:{type:"audio/pcm",rate:24e3},speed:1}}};class ds extends gr{#e;#t;#n=null;#s=null;eventEmitter=new ts;constructor(e={}){super(),this.#e=e.model??Wh,this.#t=e.apiKey}get currentModel(){return this.#e}set currentModel(e){this.#e=e}get _rawSessionConfig(){return this.#s??null}async _getApiKey(e){const t=e.apiKey??this.#t;return typeof t=="function"?await t():t}_onMessage(e){const{data:t,isGeneric:s}=Gr(e);if(t!==null&&(this.emit("*",t),!s)){if(t.type==="error"?this.emit("error",{type:"error",error:t}):this.emit(t.type,t),t.type==="response.created"){this.emit("turn_started",{type:"response_started",providerData:{...t}});return}if(t.type==="session.updated"&&(this.#s=t.session),t.type==="response.done"){const r=Mu.safeParse(t);if(!r.success){Se.error("Error parsing response done event",r.error);return}const a=r.data.response.usage?.input_tokens??0,i=r.data.response.usage?.output_tokens??0,o=a+i,u=new ht({inputTokens:a,inputTokensDetails:r.data.response.usage?.input_tokens_details??{},outputTokens:i,outputTokensDetails:r.data.response.usage?.output_tokens_details??{},totalTokens:o});this.emit("usage_update",u),this.emit("turn_done",{type:"response_done",response:{id:r.data.response.id??"",output:r.data.response.output??[],usage:{inputTokens:a,inputTokensDetails:r.data.response.usage?.input_tokens_details??{},outputTokens:i,outputTokensDetails:r.data.response.usage?.output_tokens_details??{},totalTokens:o}}});return}if(t.type==="response.output_audio.done"){this.emit("audio_done");return}if(t.type==="conversation.item.deleted"){this.emit("item_deleted",{itemId:t.item_id});return}if(t.type==="conversation.item.input_audio_transcription.completed"||t.type==="conversation.item.truncated"){this.sendEvent({type:"conversation.item.retrieve",item_id:t.item_id});return}if(t.type==="conversation.item.input_audio_transcription.delta"||t.type==="response.output_text.delta"||t.type==="response.output_audio_transcript.delta"||t.type==="response.function_call_arguments.delta"){t.type==="response.output_audio_transcript.delta"&&this.emit("audio_transcript_delta",{type:"transcript_delta",delta:t.delta,itemId:t.item_id,responseId:t.response_id});return}if(t.type==="conversation.item.added"||t.type==="conversation.item.done"||t.type==="conversation.item.retrieved"){if(t.item.type==="mcp_list_tools"&&t.type==="conversation.item.done"){const r=t.item.server_label??"",a=t.item.tools??[];try{this.emit("mcp_tools_listed",{serverLabel:r,tools:a})}catch(i){Se.error("Error emitting mcp_tools_listed",i,t.item)}return}if(t.item.type==="message"){const r=t.type==="conversation.item.added"||t.type==="conversation.item.done"?t.previous_item_id:null,a=gi.parse({itemId:t.item.id,previousItemId:r,type:t.item.type,role:t.item.role,content:t.item.content,status:t.item.status});this.emit("item_update",a);return}if(t.item.type==="mcp_approval_request"&&t.type==="conversation.item.done"){const r=t.item,a=Wf.parse({itemId:r.id,type:r.type,serverLabel:r.server_label,name:r.name,arguments:JSON.parse(r.arguments||"{}"),approved:r.approved});this.emit("item_update",a),this.emit("mcp_approval_request",a);return}if(t.item.type==="mcp_tool_call"||t.item.type==="mcp_call"){const r=t.type==="conversation.item.done"?"completed":"in_progress",a=vi.parse({itemId:t.item.id,type:t.item.type,status:r,arguments:t.item.arguments,name:t.item.name,output:t.item.output});this.emit("item_update",a),t.type==="conversation.item.done"&&this.emit("mcp_tool_call_completed",a);return}}if(t.type==="response.mcp_call.in_progress"){const r=t;this.sendEvent({type:"conversation.item.retrieve",item_id:r.item_id});return}if(t.type==="mcp_list_tools.in_progress"){const r=t;r.item_id&&this.sendEvent({type:"conversation.item.retrieve",item_id:r.item_id});return}if(t.type==="response.output_item.done"||t.type==="response.output_item.added"){const r=t.item;if(r.type==="function_call"&&r.status==="completed"){const a=yi.parse({itemId:r.id,type:r.type,status:"in_progress",arguments:r.arguments,name:r.name,output:null});this.emit("item_update",a),this.emit("function_call",{id:r.id,type:"function_call",callId:r.call_id??"",arguments:r.arguments??"",name:r.name??""});return}if(r.type==="mcp_tool_call"||r.type==="mcp_call"){const a=vi.parse({itemId:r.id,type:r.type,status:t.type==="response.output_item.done"?"completed":"in_progress",arguments:r.arguments,name:r.name,output:r.output});this.emit("item_update",a);return}if(r.type==="message"){const a=gi.parse({itemId:t.item.id,type:t.item.type,role:t.item.role,content:t.item.content,status:t.type==="response.output_item.done"?r.status??"completed":r.status??"in_progress"});this.emit("item_update",a);return}}}}_onError(e){this.emit("error",{type:"error",error:e})}_onOpen(){this.emit("connected")}_onClose(){this.emit("disconnected")}sendMessage(e,t,{triggerResponse:s=!0}={}){const r=typeof e=="string"?[{type:"input_text",text:e}]:e.content.map(a=>a.type==="input_image"?{type:"input_image",image_url:a.image,...a.providerData??{}}:a);this.sendEvent({type:"conversation.item.create",item:{type:"message",role:"user",content:r},...t}),s&&this.sendEvent({type:"response.create"})}addImage(e,{triggerResponse:t=!0}={}){this.sendMessage({type:"message",role:"user",content:[{type:"input_image",image:e}]},{},{triggerResponse:t})}_getMergedSessionConfig(e){const t=qf(e),s={type:"realtime",instructions:t.instructions,model:t.model??this.#e,output_modalities:t.outputModalities??je.outputModalities,audio:{input:{format:t.audio?.input?.format??je.audio?.input?.format,noise_reduction:t.audio?.input?.noiseReduction??je.audio?.input?.noiseReduction,transcription:t.audio?.input?.transcription??je.audio?.input?.transcription,turn_detection:ds.buildTurnDetectionConfig(t.audio?.input?.turnDetection)??je.audio?.input?.turnDetection},output:{format:t.audio?.output?.format??je.audio?.output?.format,voice:t.audio?.output?.voice??je.audio?.output?.voice,speed:t.audio?.output?.speed??je.audio?.output?.speed}},tool_choice:t.toolChoice??je.toolChoice,...t.providerData??{}};return t.prompt&&(s.prompt={id:t.prompt.promptId,version:t.prompt.version,variables:t.prompt.variables}),t.tools&&t.tools.length>0&&(s.tools=t.tools.map(r=>({...r,strict:void 0}))),s}static buildTurnDetectionConfig(e){if(typeof e>"u")return;const{type:t,createResponse:s,create_response:r,eagerness:a,interruptResponse:i,interrupt_response:o,prefixPaddingMs:u,prefix_padding_ms:c,silenceDurationMs:l,silence_duration_ms:p,threshold:h,idleTimeoutMs:f,idle_timeout_ms:_,...w}=e,A={type:t,create_response:s||r,eagerness:a,interrupt_response:i||o,prefix_padding_ms:u||c,silence_duration_ms:l||p,idle_timeout_ms:f||_,threshold:h,...w};return Object.keys(A).forEach(I=>{A[I]===void 0&&delete A[I]}),Object.keys(A).length>0?A:void 0}set _tracingConfig(e){this.#n=e}_updateTracingConfig(e){if(typeof this.#n>"u"&&(this.#n=null),e==="auto"){this.sendEvent({type:"session.update",session:{type:"realtime",tracing:"auto"}});return}if(this.#n!==null&&typeof this.#n!="string"&&typeof e!="string"){Se.warn("Tracing config is already set, skipping setting it again. This likely happens when you already set a tracing config on session creation.");return}if(e===null){Se.debug("Disabling tracing for this session. It cannot be turned on for this session from this point on."),this.sendEvent({type:"session.update",session:{type:"realtime",tracing:null}});return}if(this.#n===null||typeof this.#n=="string"){this.sendEvent({type:"session.update",session:{type:"realtime",tracing:e}});return}if(e?.group_id!==this.#n?.group_id||e?.metadata!==this.#n?.metadata||e?.workflow_name!==this.#n?.workflow_name){Se.warn("Mismatch in tracing config. Ignoring the new tracing config. This likely happens when you already set a tracing config on session creation. Current tracing config: %s, new tracing config: %s",JSON.stringify(this.#n),JSON.stringify(e));return}this.sendEvent({type:"session.update",session:{type:"realtime",tracing:e}})}updateSessionConfig(e){const t=this._getMergedSessionConfig(e);this.sendEvent({type:"session.update",session:t})}sendFunctionCallOutput(e,t,s=!0){this.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",output:t,call_id:e.callId}});try{const r=yi.parse({itemId:e.id,previousItemId:e.previousItemId,type:"function_call",status:"completed",arguments:e.arguments,name:e.name,output:t});this.emit("item_update",r)}catch(r){Se.error("Error parsing tool call item",r,e)}s&&this.sendEvent({type:"response.create"})}sendAudio(e,{commit:t=!1}={}){this.sendEvent({type:"input_audio_buffer.append",audio:Df(e)}),t&&this.sendEvent({type:"input_audio_buffer.commit"})}resetHistory(e,t){const{removals:s,additions:r,updates:a}=Pf(e,t),i=new Set(s.map(u=>u.itemId));for(const u of a)i.add(u.itemId);if(i.size>0)for(const u of i)this.sendEvent({type:"conversation.item.delete",item_id:u});const o=[...r,...a];for(const u of o)if(u.type==="message"){const c={type:"message",role:u.role,content:u.content,id:u.itemId};u.role!=="system"&&u.status&&(c.status=u.status),this.sendEvent({type:"conversation.item.create",item:c})}else u.type==="function_call"&&Se.warn("Function calls cannot be manually added or updated at the moment. Ignoring.")}sendMcpResponse(e,t){this.sendEvent({type:"conversation.item.create",previous_item_id:e.itemId,item:{type:"mcp_approval_response",approval_request_id:e.itemId,approve:t}})}}class Hh extends ds{options;#e;#t={status:"disconnected",peerConnection:void 0,dataChannel:void 0};#n;#s=!1;#i=!1;constructor(e={}){if(typeof RTCPeerConnection>"u")throw new Error("WebRTC is not supported in this environment");super(e),this.options=e,this.#e=e.baseUrl??"https://api.openai.com/v1/realtime/calls",this.#n=e.useInsecureApiKey??!1}get status(){return this.#t.status}get connectionState(){return this.#t}get muted(){return this.#i}async connect(e){if(this.#t.status==="connected")return;this.#t.status==="connecting"&&Se.warn("Realtime connection already in progress. Please await original promise");const t=e.model??this.currentModel;this.currentModel=t;const s=e.url??this.#e,r=await this._getApiKey(e),a=typeof r=="string"&&r.startsWith("ek_");if(!this.#n&&!a)throw new H("Using the WebRTC connection in a browser environment requires an ephemeral client key. If you need to use a regular API key, use the WebSocket transport or set the `useInsecureApiKey` option to true.");return new Promise(async(i,o)=>{try{const u={...e.initialSessionConfig||{},model:this.currentModel},c=new URL(s);let l=new RTCPeerConnection;const p=l.createDataChannel("oai-events");this.#t={status:"connecting",peerConnection:l,dataChannel:p},this.emit("connection_change",this.#t.status),p.addEventListener("open",()=>{this.#t={status:"connected",peerConnection:l,dataChannel:p},this.updateSessionConfig(u),this.emit("connection_change",this.#t.status),this._onOpen(),i()}),p.addEventListener("error",I=>{this.close(),this._onError(I),o(I)}),p.addEventListener("message",I=>{this._onMessage(I);const{data:S,isGeneric:U}=Gr(I);!S||U||(S.type==="response.created"?this.#s=!0:S.type==="response.done"&&(this.#s=!1),S.type==="session.created"&&(this._tracingConfig=S.session.tracing,this._updateTracingConfig(u.tracing??"auto")))});const h=this.options.audioElement??document.createElement("audio");h.autoplay=!0,l.ontrack=I=>{h.srcObject=I.streams[0]};const f=this.options.mediaStream??await navigator.mediaDevices.getUserMedia({audio:!0});l.addTrack(f.getAudioTracks()[0]),this.options.changePeerConnection&&(l=await this.options.changePeerConnection(l),this.#t={...this.#t,peerConnection:l});const _=await l.createOffer();if(await l.setLocalDescription(_),!_.sdp)throw new Error("Failed to create offer");const A={type:"answer",sdp:await(await fetch(c,{method:"POST",body:_.sdp,headers:{"Content-Type":"application/sdp",Authorization:`Bearer ${r}`,"X-OpenAI-Agents-SDK":Mf["X-OpenAI-Agents-SDK"]}})).text()};await l.setRemoteDescription(A)}catch(u){this.close(),this._onError(u),o(u)}})}sendEvent(e){if(!this.#t.dataChannel||this.#t.dataChannel.readyState!=="open")throw new Error("WebRTC data channel is not connected. Make sure you call `connect()` before sending events.");this.#t.dataChannel.send(JSON.stringify(e))}mute(e){this.#i=e,this.#t.peerConnection&&this.#t.peerConnection.getSenders().forEach(s=>{s.track&&(s.track.enabled=!e)})}close(){if(this.#t.dataChannel&&this.#t.dataChannel.close(),this.#t.peerConnection){const e=this.#t.peerConnection;e.getSenders().forEach(t=>{t.track?.stop()}),e.close()}this.#t.status!=="disconnected"&&(this.#t={status:"disconnected",peerConnection:void 0,dataChannel:void 0},this.emit("connection_change",this.#t.status),this._onClose())}interrupt(){this.#s&&(this.sendEvent({type:"response.cancel"}),this.#s=!1),this.sendEvent({type:"output_audio_buffer.clear"})}}const zh=globalThis.WebSocket;class Gh extends ds{#e;#t;#n={status:"disconnected",websocket:void 0};#s;#i;#a;_firstAudioTimestamp;_audioLengthMs=0;#o=!1;constructor(e={}){super(e),this.#t=e.url,this.#s=e.useInsecureApiKey??!1}get status(){return this.#n.status}get connectionState(){return this.#n}get muted(){return null}get currentItemId(){return this.#i}_onAudio(e){this.emit("audio",e)}#r(e,t,s){if(this.#n.websocket){e();return}if(!this.#e)throw new H("API key is not set. Please call `connect()` with an API key first.");if(!this.#e.startsWith("ek_")&&!this.#s)throw new H("Using the WebSocket connection in a browser environment requires an ephemeral client key. If you have to use a regular API key, set the `useInsecureApiKey` option to true.");const r=["realtime","openai-insecure-api-key."+this.#e,Lf],a=new zh(this.#t,r);this.#n={status:"connecting",websocket:a},this.emit("connection_change",this.#n.status),a.addEventListener("open",()=>{this.#n={status:"connected",websocket:a},this.emit("connection_change",this.#n.status),this._onOpen(),e()}),a.addEventListener("error",i=>{this._onError(i),this.#n={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#n.status),t(i)}),a.addEventListener("message",i=>{this._onMessage(i);const{data:o,isGeneric:u}=Gr(i);if(!(!o||u))if(o.type==="response.output_audio.delta"){this.#a=o.content_index,this.#i=o.item_id,this._firstAudioTimestamp===void 0&&(this._firstAudioTimestamp=Date.now(),this._audioLengthMs=0);const c=Of(o.delta),l=this._rawSessionConfig?.audio?.output?.format;if(l&&typeof l=="object"){const h=l.type;if(h==="audio/pcmu"||h==="audio/pcma")this._audioLengthMs+=c.byteLength/8;else if(h==="audio/pcm"){const f=l.rate??24e3;this._audioLengthMs+=c.byteLength/2/f*1e3}else this._audioLengthMs+=c.byteLength/24/2}else typeof l=="string"?l.startsWith("g711_")?this._audioLengthMs+=c.byteLength/8:this._audioLengthMs+=c.byteLength/24/2:this._audioLengthMs+=c.byteLength/24/2;const p={type:"audio",data:c,responseId:o.response_id};this._onAudio(p)}else if(o.type==="input_audio_buffer.speech_started"){const c=this._rawSessionConfig?.audio?.input?.turn_detection?.interrupt_response??!1;this.interrupt(!c)}else o.type==="response.created"?this.#o=!0:o.type==="response.done"?this.#o=!1:o.type==="session.created"&&(this._tracingConfig=o.session.tracing,this._updateTracingConfig(s.tracing??"auto"))}),a.addEventListener("close",()=>{this.#n={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#n.status),this._onClose()})}async connect(e){const t=e.model??this.currentModel;this.currentModel=t,this.#e=await this._getApiKey(e);const s=e.url??this.#t??`wss://api.openai.com/v1/realtime?model=${this.currentModel}`;this.#t=s;const r={...e.initialSessionConfig||{},model:this.currentModel};await new Promise((a,i)=>{try{this.#r(a,i,r)}catch(o){i(o)}}),await this.updateSessionConfig(r)}sendEvent(e){if(!this.#n.websocket)throw new Error("WebSocket is not connected. Make sure you call `connect()` before sending events.");this.#n.websocket.send(JSON.stringify(e))}close(){this.#n.websocket?.close(),this.#i=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#a=void 0}mute(e){throw new Error("Mute is not supported for the WebSocket transport. You have to mute the audio input yourself.")}sendAudio(e,t={}){this.#n.status==="connected"&&super.sendAudio(e,t)}_cancelResponse(){this.#o&&(this.sendEvent({type:"response.cancel"}),this.#o=!1)}_interrupt(e,t=!0){if(e<0)return;t&&this._cancelResponse();const s=this._audioLengthMs??Number.POSITIVE_INFINITY,r=Math.max(0,Math.min(Math.floor(e),s));this.emit("audio_interrupted"),this.sendEvent({type:"conversation.item.truncate",item_id:this.#i,content_index:this.#a,audio_end_ms:r})}interrupt(e=!0){if(!this.#i||typeof this._firstAudioTimestamp!="number")return;const t=Date.now()-this._firstAudioTimestamp;t>=0&&this._interrupt(t,e),this.#i=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#a=void 0}}const Vh=Symbol("backgroundResult");function Kh(n){return typeof n=="object"&&n!==null&&Vh in n}function Xh(n){return n.type==="function"||n.type==="hosted_tool"&&n.name==="hosted_mcp"}function Yh(n){if(n.type==="function")return n;if(n.type==="hosted_tool"&&n.name==="hosted_mcp"){const e=n.providerData.server_url&&n.providerData.server_url.length>0?n.providerData.server_url:void 0;return{type:"mcp",server_label:n.providerData.server_label,server_url:e,headers:n.providerData.headers,allowed_tools:n.providerData.allowed_tools,require_approval:n.providerData.require_approval}}throw new H(`Invalid tool type: ${n}`)}class Qh extends ts{initialAgent;options;#e;#t;#n;#s;#i=[];#a;#o={};#r=[];#u;#d={};#c=!1;#p=new Map;#l=[];#_=null;#g=!0;constructor(e,t={}){super(),this.initialAgent=e,this.options=t,typeof t.transport>"u"&&$f()||t.transport==="webrtc"?this.#e=new Hh:t.transport==="websocket"||typeof t.transport>"u"?this.#e=new Gh:this.#e=t.transport,this.#t=e,this.#s=new It({...t.context??{},history:this.#r}),this.#i=(t.outputGuardrails??[]).map(Bf),this.#a=Uf(t.outputGuardrailSettings??{}),this.#u=t.historyStoreAudio??!1,this.#g=t.automaticallyTriggerResponseForMcpToolCalls??!0}get transport(){return this.#e}get currentAgent(){return this.#t}get usage(){return this.#s.usage}get context(){return this.#s}get muted(){return this.#e.muted}get history(){return this.#r}get availableMcpTools(){return this.#l}async#f(e){this.#t=e;const t=this.#t.handoffs.map(Wn),s=t.map(o=>o.getHandoffAsFunctionTool()),r=(await this.#t.getAllTools(this.#s)).filter(Xh).map(Yh),a=typeof this.#t.tools<"u"||typeof this.#t.mcpServers<"u",i=t.length>0;this.#n=a||i?[...r,...s]:void 0,this.#v()}async#h(e={}){const t=await this.#t.getSystemPrompt(this.#s),s=this.options.tracingDisabled?null:this.options.workflowName?{workflow_name:this.options.workflowName}:"auto";s!==null&&s!=="auto"?(this.options.groupId&&(s.group_id=this.options.groupId),this.options.traceMetadata&&(s.metadata=this.options.traceMetadata)):(this.options.groupId||this.options.traceMetadata)&&Se.warn("In order to set traceMetadata or a groupId you need to specify a workflowName.");const a={...{...this.#_??{},...this.options.config??{},...e??{}},instructions:t,voice:this.#t.voice,model:this.options.model,tools:this.#n,tracing:s,prompt:typeof this.#t.prompt=="function"?await this.#t.prompt(this.#s,this.#t):this.#t.prompt};return this.#_=a,a}async updateAgent(e){return this.#t.emit("agent_handoff",this.#s,e),this.emit("agent_handoff",this.#s,this.#t,e),await this.#f(e),await this.#e.updateSessionConfig(await this.#h()),e}async#w(e,t){const s=await t.onInvokeHandoff(this.#s,e.arguments);this.#t.emit("agent_handoff",this.#s,s),this.emit("agent_handoff",this.#s,this.#t,s),await this.#f(s),await this.#e.updateSessionConfig(await this.#h());const r=eo(s);return this.#e.sendFunctionCallOutput(e,r,!0),s}async#m(e,t){this.#s.context.history=JSON.parse(JSON.stringify(this.#r));let s=e.arguments;if(t.parameters&&(ft(t.parameters)?s=t.parameters.parse(s):s=JSON.parse(s)),await t.needsApproval(this.#s,s,e.callId)){const o=this.context.isToolApproved({toolName:t.name,callId:e.callId});if(o===!1){this.emit("agent_tool_start",this.#s,this.#t,t,{toolCall:e}),this.#t.emit("agent_tool_start",this.#s,t,{toolCall:e});const u="Tool execution was not approved.";this.#e.sendFunctionCallOutput(e,u,!0),this.emit("agent_tool_end",this.#s,this.#t,t,u,{toolCall:e}),this.#t.emit("agent_tool_end",this.#s,t,u,{toolCall:e});return}else if(typeof o>"u"){this.emit("tool_approval_requested",this.#s,this.#t,{type:"function_approval",tool:t,approvalItem:new Ie(e,this.#t)});return}}this.emit("agent_tool_start",this.#s,this.#t,t,{toolCall:e}),this.#t.emit("agent_tool_start",this.#s,t,{toolCall:e}),this.#s.context.history=JSON.parse(JSON.stringify(this.#r));const a=await t.invoke(this.#s,e.arguments,{toolCall:e});let i;Kh(a)?(i=Ye(a.content),this.#e.sendFunctionCallOutput(e,i,!1)):(i=Ye(a),this.#e.sendFunctionCallOutput(e,i,!0)),this.emit("agent_tool_end",this.#s,this.#t,t,i,{toolCall:e}),this.#t.emit("agent_tool_end",this.#s,t,i,{toolCall:e})}async#b(e){const t=new Map(this.#t.handoffs.map(Wn).map(i=>[i.toolName,i])),s=await this.#t.getAllTools(this.#s),r=new Map(s.map(i=>[i.name,i])),a=t.get(e.name);if(a)await this.#w(e,a);else{const i=r.get(e.name);if(i&&i.type==="function")await this.#m(e,i);else throw new Te(`Tool ${e.name} not found`)}}async#y(e,t,s){if(this.#i.length===0)return;const r={agent:this.#t,agentOutput:e,context:this.#s},i=(await Promise.all(this.#i.map(o=>o.run(r)))).find(o=>o.output.tripwireTriggered);if(i){if(this.#d[t])return;this.#d[t]=!0;const o=new Zs(`Output guardrail triggered: ${JSON.stringify(i.output.outputInfo)}`,i);this.emit("guardrail_tripped",this.#s,this.#t,o,{itemId:s}),this.interrupt();const u=Jf(i);this.sendMessage(u);return}}#x(){this.#e.on("*",s=>{if(this.emit("transport_event",s),s.type==="conversation.item.input_audio_transcription.completed")try{const r=s;this.#r=mi(this.#r,r,this.#u),this.#s.context.history=this.#r,this.emit("history_updated",this.#r)}catch(r){this.emit("error",{type:"error",error:r})}}),this.#e.on("mcp_tools_listed",({serverLabel:s,tools:r})=>{try{this.#p.set(s,r??[]),this.#v()}catch(a){this.emit("error",{type:"error",error:a})}}),this.#e.on("audio",s=>{this.#c||(this.#c=!0,this.emit("audio_start",this.#s,this.#t)),this.emit("audio",s)}),this.#e.on("turn_started",()=>{this.#c=!1,this.emit("agent_start",this.#s,this.#t),this.#t.emit("agent_start",this.#s,this.#t)}),this.#e.on("turn_done",s=>{const r=s.response.output[s.response.output.length-1],a=Nf(r)??"",i=r?.id??"";this.emit("agent_end",this.#s,this.#t,a),this.#t.emit("agent_end",this.#s,a),this.#y(a,s.response.id,i)}),this.#e.on("audio_done",()=>{this.#c&&(this.#c=!1),this.emit("audio_stopped",this.#s,this.#t)});let e=0,t;this.#e.on("audio_transcript_delta",s=>{try{const r=s.delta,a=s.itemId,i=s.responseId;t!==a&&(t=a,e=0);const u=(this.#o[a]??"")+r;if(this.#o[a]=u,this.#a.debounceTextLength<0)return;const c=Math.floor(u.length/this.#a.debounceTextLength);c>e&&(e=c,this.#y(u,i,a))}catch(r){this.emit("error",{type:"error",error:r})}}),this.#e.on("item_update",s=>{try{const r=!this.#r.some(a=>a.itemId===s.itemId);if(this.#r=mi(this.#r,s,this.#u),this.#s.context.history=this.#r,r){const a=this.#r.find(i=>i.itemId===s.itemId);a&&this.emit("history_added",a)}this.emit("history_updated",this.#r)}catch(r){this.emit("error",{type:"error",error:r})}}),this.#e.on("item_deleted",s=>{try{this.#r=this.#r.filter(r=>r.itemId!==s.itemId),this.#s.context.history=this.#r,this.emit("history_updated",this.#r)}catch(r){this.emit("error",{type:"error",error:r})}}),this.#e.on("function_call",async s=>{try{await this.#b(s)}catch(r){Se.error("Error handling function call",r),this.emit("error",{type:"error",error:r})}}),this.#e.on("usage_update",s=>{this.#s.usage.add(s)}),this.#e.on("audio_interrupted",()=>{this.#c&&(this.#c=!1),this.emit("audio_interrupted",this.#s,this.#t)}),this.#e.on("error",s=>{this.emit("error",s)}),this.#e.on("mcp_tool_call_completed",s=>{this.emit("mcp_tool_call_completed",this.#s,this.#t,s),this.#g&&this.#e.sendEvent({type:"response.create"})}),this.#e.on("mcp_approval_request",s=>{this.emit("tool_approval_requested",this.#s,this.#t,{type:"mcp_approval_request",approvalItem:Ff(this.#t,s)})})}#v(){const e=this.#n?.filter(o=>o.type==="mcp"),t=o=>{const u=o.allowed_tools;if(u){if(Array.isArray(u))return u;if(u&&Array.isArray(u.tool_names))return u.tool_names}},s=new Map;for(const o of e){const u=this.#p.get(o.server_label)??[],c=t(o);for(const l of u)c&&!c.includes(l.name)||s.has(l.name)||s.set(l.name,l)}const r=Array.from(s.values()),a=this.#l;(a.length!==r.length||JSON.stringify(a.map(o=>o.name).sort())!==JSON.stringify(r.map(o=>o.name).sort()))&&(this.#l=r,this.emit("mcp_tools_changed",this.#l))}async connect(e){await this.#f(this.initialAgent),this.#x(),await this.#e.connect({apiKey:e.apiKey??this.options.apiKey,model:this.options.model,url:e.url,initialSessionConfig:await this.#h(this.options.config)}),this.#r=[],this.emit("history_updated",this.#r)}updateHistory(e){let t;typeof e=="function"?t=e(this.#r):t=e,this.#e.resetHistory(this.#r,t)}sendMessage(e,t={}){this.#e.sendMessage(e,t)}addImage(e,{triggerResponse:t=!0}={}){this.#e.addImage(e,{triggerResponse:t})}mute(e){this.#e.mute(e)}close(){this.#d={},this.#e.close()}sendAudio(e,t={}){this.#e.sendAudio(e,t)}interrupt(){this.#e.interrupt()}async approve(e,t={alwaysApprove:!1}){this.#s.approveTool(e,t);const s=this.#t.tools.find(r=>r.name===e.rawItem.name);if(s&&s.type==="function"&&e.rawItem.type==="function_call")await this.#m(e.rawItem,s);else if(e.rawItem.type==="hosted_tool_call"){t.alwaysApprove&&Se.warn("Always approving MCP tools is not supported. Use the allowed tools configuration instead.");const r=_i(e);this.#e.sendMcpResponse(r,!0)}else throw new Te(`Tool ${e.rawItem.name} not found`)}async reject(e,t={alwaysReject:!1}){this.#s.rejectTool(e,t);const s=this.#t.tools.find(r=>r.name===e.rawItem.name);if(s&&s.type==="function"&&e.rawItem.type==="function_call")await this.#m(e.rawItem,s);else if(e.rawItem.type==="hosted_tool_call"){t.alwaysReject&&Se.warn("Always rejecting MCP tools is not supported. Use the allowed tools configuration instead.");const r=_i(e);this.#e.sendMcpResponse(r,!1)}else throw new Te(`Tool ${e.rawItem.name} not found`)}}ad(new Cf);Rf();async function em({startButton:n,stopButton:e,messageOutput:t,errorOutput:s}){let r=null;n.addEventListener("click",async()=>{n.disabled=!0,e.disabled=!1,me("thinking");try{r=await tm({messageOutput:t,errorOutput:s})}catch(i){n.disabled=!1,e.disabled=!0,me("idle"),console.error("Failed to start agent:",i)}}),e.addEventListener("click",()=>{n.disabled=!1,e.disabled=!0,me("idle"),a(),r&&(r(),r=null)});function a(){s.classList.add("hidden"),s.innerText=""}}async function tm({messageOutput:n,errorOutput:e}){const t=localStorage.getItem("userInput.setting")||"",s=`日本語で答えてください。

  - 現在日付: ${new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"})}
  - 現在時刻: ${new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"})} (日本時間)

  # 会話の情報
  ${t}

  # 検索について

  - 毎回の質問に\`web_search\`ツールの\`tavily_search\`で検索して答えてください。
  - 検索キーワードは2～3単語のみでシンプルにするようにしてください。
  - 天気予報はyahoo天気などの日本の天気予報サイトで検索してください。
  - ニュースはyahooニュースなどの日本のニュースサイトで検索してください。
  - 検索を開始する時は「検索を開始します」と伝えてください。
  - 検索が終了したら結果を伝えてください。

  # 会話の終了

  - ユーザーから黙るよう指示された場合は、返答しないでください。
  `,r=new jf({name:"Assistant",instructions:s,tools:[xl({serverLabel:"web_search",serverUrl:"https://mcp.tavily.com/mcp/?tavilyApiKey=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",requireApproval:"never"})]}),a=new Qh(r,{config:{audio:{input:{turnDetection:{type:"semantic_vad",eagerness:"medium"}}}}});function i(u){e.classList.remove("hidden"),e.innerText=u,me("idle")}a.on("history_updated",u=>{console.log(u),nm(n,u)}),a.on("error",u=>{console.error("Session error:",u);const c=u instanceof Error?u.message:JSON.stringify(u);i(c)}),a.transport.on("input_audio_buffer.speech_started",()=>{me("listening")}),a.transport.on("input_audio_buffer.speech_stopped",()=>{me("thinking")}),a.transport.on("output_audio_buffer.started",()=>{me("speaking")}),a.transport.on("output_audio_buffer.done",()=>{me("idle")});let o=null;a.transport.on("output_audio_buffer.stopped",()=>{me("idle"),o&&(clearTimeout(o),o=null),o=setTimeout(()=>{me("thinking"),a.sendMessage({role:"user",type:"message",content:[{type:"input_text",text:"会話の情報に基づいて、盛り上がるように話を振ってください。全員のユーザーに一人ずつ話を振っていってください。また同じトピックを何回も振り続けるのはやめてください。トピックがなくなったら、最近の面白いニュースや出来事を検索して話題として振ってください。また、話の初めはさてやではから始めてください。"}]})},10*1e3)}),a.on("history_added",()=>{o&&(clearTimeout(o),o=null)});try{await a.connect({apiKey:"ek_68ed93cb11c0819181896c73d630e1c1"}),console.log("You are connected!"),me("idle"),me("thinking"),a.sendMessage({role:"user",type:"message",content:[{type:"input_text",text:"各ユーザーに自己紹介するよう促してください"}]})}catch(u){console.error(u);const c=u instanceof Error?u.message:JSON.stringify(u);throw i(c),u}return function(){o&&(clearTimeout(o),o=null),a.interrupt(),a.close(),me("idle")}}function nm(n,e){n.innerText=JSON.stringify(e.slice().reverse(),null,2)}function sm({input:n}){rm(n,"userInput.setting")}function rm(n,e){const t=localStorage.getItem(e);t&&(n.value=t),n.addEventListener("input",()=>{localStorage.setItem(e,n.value)})}am();sm({input:document.getElementById("input")});em({startButton:document.getElementById("ai-start-button"),stopButton:document.getElementById("ai-stop-button"),messageOutput:document.getElementById("ai-messages"),errorOutput:document.getElementById("ai-error")});function am(){const n=document.getElementById("settings-toggle"),e=document.getElementById("settings-panel");n.addEventListener("click",()=>{e.classList.toggle("hidden");const a=e.classList.contains("hidden");n.textContent=a?"⚙️ 設定":"⚙️ 設定を閉じる"});const t=document.getElementById("ai-avatar"),s=document.getElementById("debug-panel");let r=0;t.addEventListener("click",()=>{r++,setTimeout(()=>{r===2&&s.classList.toggle("hidden"),r=0},300)}),me("idle")}function me(n){const e=document.getElementById("app"),t=document.getElementById("ai-status"),s=t.querySelector("h2"),r=t.querySelector("p"),a=document.getElementById("sound-waves");switch(e.classList.remove("ai-idle","ai-listening","ai-speaking","ai-thinking"),e.classList.add(`ai-${n}`),n){case"idle":s.textContent="準備完了",r.textContent="スタートボタンを押して会話を始めてください",a.style.opacity="0";break;case"listening":s.textContent="🎧 聞いています...",r.textContent="あなたの声を聞いています",a.style.opacity="0.7";break;case"speaking":s.textContent="🗣️ 話しています...",r.textContent="AIが回答しています",a.style.opacity="1";break;case"thinking":s.textContent="💭 考えています...",r.textContent="回答を準備しています",a.style.opacity="0.5";break}}
